<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA DOCENTE MEP 2026 - MASTER</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --mep-blue: #003366; --mep-red: #cc0000; --bg: #f4f7f6; --card: #ffffff; --text: #1c1e21;
        }
        [data-theme="dark"] { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 80px; }
        header { background: var(--mep-blue); color: white; padding: 15px; text-align: center; border-bottom: 3px solid var(--mep-red); position: sticky; top: 0; z-index: 1000; }
        .container { padding: 15px; max-width: 800px; margin: auto; }
        .card { background: var(--card); border-radius: 12px; padding: 18px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        /* TAB BAR INFERIOR */
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ddd; z-index: 1001; }
        .tab-item { background: none; border: none; font-size: 11px; color: #65676b; display: flex; flex-direction: column; align-items: center; gap: 4px; flex: 1; }
        .tab-item.active { color: var(--mep-blue); font-weight: bold; }

        /* TABLAS Y BOTONES */
        .table-wrapper { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; background: var(--bg); color: var(--text); }
        .btn { padding: 14px; border: none; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; color: white; }
        .btn-mep { background: var(--mep-blue); }
        .btn-wa { background: #25d366; }
        .btn-red { background: var(--mep-red); }
        .locked { background: #eee !important; pointer-events: none; }
    </style>
</head>
<body>

<header>
    <div id="inst-tag" style="font-size: 10px; opacity: 0.8;">REGISTRO PROFESIONAL</div>
    <div id="active-title" style="font-weight: bold; font-size: 18px;">Configuraci√≥n</div>
</header>

<div class="container" id="app-content"></div>

<nav class="tab-bar">
    <button class="tab-item active" onclick="router('config')">‚öôÔ∏è<span>Config</span></button>
    <button class="tab-item" onclick="router('estud')">üë•<span>Lista</span></button>
    <button class="tab-item" onclick="router('eval')">üìä<span>Eval</span></button>
    <button class="tab-item" onclick="router('bitacora')">üìñ<span>Bit√°cora</span></button>
    <button class="tab-item" onclick="router('mas')">‚ûï<span>M√°s</span></button>
</nav>

<script>
let db;
let AppState = {
    config: { id: "main", centro: "Liceo Bello Horizonte", tc: 45, pr: 20, ta: 10, py: 25, cerrado: false },
    currentView: 'config'
};

// --- BASE DE DATOS ---
const req = indexedDB.open("MEP_MASTER_DB", 2);
req.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore("config", { keyPath: "id" });
    db.createObjectStore("estudiantes", { keyPath: "id", autoIncrement: true });
    db.createObjectStore("bitacora", { keyPath: "id", autoIncrement: true });
};
req.onsuccess = e => { db = e.target.result; loadApp(); };

function loadApp() {
    db.transaction("config").objectStore("config").get("main").onsuccess = e => {
        if(e.target.result) AppState.config = e.target.result;
        document.getElementById('inst-tag').innerText = AppState.config.centro;
        router('config');
    };
}

// --- ROUTER (VISTAS) ---
function router(view) {
    const content = document.getElementById('app-content');
    const title = document.getElementById('active-title');
    document.querySelectorAll('.tab-item').forEach(b => b.classList.remove('active'));
    if(event) event.currentTarget.classList.add('active');

    title.innerText = view.toUpperCase();
    
    if(view === 'config') {
        content.innerHTML = `
            <div class="card">
                <h3>Instituci√≥n</h3>
                <input type="text" id="c-name" value="${AppState.config.centro}">
                <h3>Ponderaci√≥n (%)</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>Cotidiano: <input type="number" id="c-tc" value="${AppState.config.tc}"></div>
                    <div>Prueba: <input type="number" id="c-pr" value="${AppState.config.pr}"></div>
                </div>
                <button class="btn btn-mep" onclick="saveConfig()">Guardar Todo</button>
            </div>`;
    }

    if(view === 'estud') {
        content.innerHTML = `
            <div class="card">
                <h3>Nuevo Estudiante</h3>
                <input type="text" id="s-nom" placeholder="Nombre completo">
                <input type="number" id="s-tel" placeholder="WhatsApp Encargado">
                <select id="s-acs"><option value="no">Sin Adecuaci√≥n</option><option value="si">Con ACS</option></select>
                <button class="btn btn-mep" onclick="addEst()">Registrar</button>
            </div>
            <div id="st-list-area"></div>`;
        renderEstud();
    }

    if(view === 'eval') {
        content.innerHTML = `<div class="card"><h3>Notas</h3><div class="table-wrapper"><table id="eval-t">
            <tr><th>Nombre</th><th>Cot</th><th>Pru</th><th>Final</th></tr>
        </table></div></div>`;
        renderEval();
    }

    if(view === 'bitacora') {
        content.innerHTML = `
            <div class="card">
                <h3>Registro DUA</h3>
                <input type="date" id="b-f" value="${new Date().toISOString().split('T')[0]}">
                <input type="text" id="b-t" placeholder="Tema/Aprendizaje">
                <textarea id="b-d" placeholder="Estrategia y ajustes..."></textarea>
                <button class="btn btn-mep" onclick="addBit()">Guardar Bit√°cora</button>
            </div>
            <div id="bit-list"></div>`;
        renderBit();
    }

    if(view === 'mas') {
        content.innerHTML = `
            <div class="card">
                <button class="btn btn-wa" onclick="sendAlerts()">üö® Alertas WhatsApp</button>
                <button class="btn" style="background:#6c757d" onclick="exportTraslados()">üìë Informes de Traslado</button>
                <button class="btn btn-mep" onclick="alert('Exportando CSV...')">üì§ Exportar a Excel (CSV)</button>
                <hr>
                <button class="btn btn-red" onclick="cerrar()">üîí Cerrar Periodo</button>
            </div>`;
    }
}

// --- L√ìGICA ---
function saveConfig() {
    AppState.config.centro = document.getElementById('c-name').value;
    AppState.config.tc = parseInt(document.getElementById('c-tc').value);
    AppState.config.pr = parseInt(document.getElementById('c-pr').value);
    db.transaction("config", "readwrite").objectStore("config").put(AppState.config);
    alert("Configuraci√≥n guardada.");
}

function addEst() {
    const nombre = document.getElementById('s-nom').value;
    const tel = document.getElementById('s-tel').value;
    const acs = document.getElementById('s-acs').value;
    if(!nombre) return;
    const tx = db.transaction("estudiantes", "readwrite");
    tx.objectStore("estudiantes").add({ nombre, tel, acs, tc:0, pr:0 });
    tx.oncomplete = () => router('estud');
}

function renderEval() {
    const table = document.getElementById('eval-t');
    const lock = AppState.config.cerrado ? 'locked' : '';
    db.transaction("estudiantes").objectStore("estudiantes").openCursor().onsuccess = e => {
        const c = e.target.result;
        if(c) {
            const final = ((c.value.tc * AppState.config.tc/100) + (c.value.pr * AppState.config.pr/100)).toFixed(1);
            table.innerHTML += `<tr>
                <td>${c.value.nombre}</td>
                <td><input type="number" value="${c.value.tc}" onchange="upd(${c.key},'tc',this.value)" class="${lock}"></td>
                <td><input type="number" value="${c.value.pr}" onchange="upd(${c.key},'pr',this.value)" class="${lock}"></td>
                <td><b>${final}</b></td>
            </tr>`;
            c.continue();
        }
    };
}

function upd(id, campo, val) {
    const store = db.transaction("estudiantes", "readwrite").objectStore("estudiantes");
    store.get(id).onsuccess = e => {
        const d = e.target.result;
        d[campo] = parseFloat(val);
        store.put(d);
    };
}

function addBit() {
    const fecha = document.getElementById('b-f').value;
    const tema = document.getElementById('b-t').value;
    const dua = document.getElementById('b-d').value;
    db.transaction("bitacora", "readwrite").objectStore("bitacora").add({ fecha, tema, dua });
    router('bitacora');
}

function renderBit() {
    let h = "";
    db.transaction("bitacora").objectStore("bitacora").openCursor(null, 'prev').onsuccess = e => {
        const c = e.target.result;
        if(c) {
            h += `<div class="card" style="border-left:4px solid var(--mep-blue)"><small>${c.value.fecha}</small><h4>${c.value.tema}</h4><p>${c.value.dua}</p></div>`;
            c.continue();
        } else { document.getElementById('bit-list').innerHTML = h; }
    };
}

function cerrar() {
    if(confirm("¬øBloquear periodo?")) {
        AppState.config.cerrado = true;
        db.transaction("config", "readwrite").objectStore("config").put(AppState.config);
        router('config');
    }
}
</script>
</body>
</html>
