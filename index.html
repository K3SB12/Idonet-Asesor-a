<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>SISTEMA DOCENTE MEP 2026 - PROFESIONAL</title>
    <!-- Librer√≠as esenciales -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
        }

        :root {
            --azul-mep: #003366;
            --rojo-mep: #CC0000;
            --gris-fondo: #f5f7fa;
            --blanco: #ffffff;
            --texto: #2c3e50;
            --borde: #e1e4e8;
            --exito: #27ae60;
            --advertencia: #f39c12;
            --peligro: #e74c3c;
        }

        body {
            background: var(--gris-fondo);
            color: var(--texto);
            padding-bottom: 85px;
            min-height: 100vh;
            font-size: 14px;
        }

        /* Header institucional */
        .header-mep {
            background: var(--azul-mep);
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-bottom: 4px solid var(--rojo-mep);
        }

        .header-mep h1 {
            font-size: 1.3rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .header-mep .subtitulo {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 4px;
        }

        /* Contenedor principal */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Tarjetas */
        .card {
            background: var(--blanco);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid var(--borde);
        }

        .card h2 {
            font-size: 1.2rem;
            color: var(--azul-mep);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--rojo-mep);
        }

        .card h3 {
            font-size: 1rem;
            margin: 12px 0 8px;
            color: var(--texto);
        }

        /* Grids responsivos */
        .grid-2, .grid-3, .grid-4 {
            display: grid;
            gap: 12px;
            margin-bottom: 15px;
        }

        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        /* Formularios */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--texto);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1.5px solid var(--borde);
            border-radius: 10px;
            font-size: 1rem;
            transition: border 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--azul-mep);
        }

        /* Botones */
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            width: 100%;
            margin: 8px 0;
            transition: all 0.2s;
            color: white;
        }

        .btn-primary { background: var(--azul-mep); }
        .btn-success { background: var(--exito); }
        .btn-warning { background: var(--advertencia); color: black; }
        .btn-danger { background: var(--rojo-mep); }
        .btn-wa { background: #25D366; }

        /* Tablas */
        .table-responsive {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--borde);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            background: var(--azul-mep);
            color: white;
            padding: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--borde);
            text-align: center;
        }

        td input {
            padding: 6px;
            margin: 0;
            text-align: center;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .badge-acs { background: #f39c12; }
        .badge-no-acs { background: #3498db; }
        .badge-riesgo { background: var(--peligro); }

        /* Navegaci√≥n inferior */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            overflow-x: auto;
            padding: 8px 4px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            border-top: 2px solid var(--azul-mep);
        }

        .nav-item {
            min-width: 70px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 4px;
            background: none;
            border: none;
            color: #7f8c8d;
            font-size: 0.7rem;
            cursor: pointer;
            transition: 0.2s;
            border-radius: 12px;
        }

        .nav-item.active {
            color: var(--azul-mep);
            font-weight: 600;
            background: rgba(0,51,102,0.1);
        }

        .nav-item span:first-child {
            font-size: 1.4rem;
            margin-bottom: 2px;
        }

        /* Utilidades */
        .text-success { color: var(--exito); }
        .text-danger { color: var(--peligro); }
        .text-warning { color: var(--advertencia); }
        .mt-2 { margin-top: 10px; }
        .mb-2 { margin-bottom: 10px; }
    </style>
</head>
<body>

<header class="header-mep" id="mainHeader">
    <h1 id="nombreInstitucion">Sistema Docente MEP 2026</h1>
    <div class="subtitulo" id="infoInstitucion">Cargando datos institucionales...</div>
</header>

<main class="app-container" id="appMain">
    <!-- El contenido se renderiza din√°micamente -->
</main>

<nav class="bottom-nav" id="bottomNav">
    <button class="nav-item active" data-view="config">‚öôÔ∏è<span>Config</span></button>
    <button class="nav-item" data-view="parametros">‚öñÔ∏è<span>Ponderar</span></button>
    <button class="nav-item" data-view="estudiantes">üë•<span>Lista</span></button>
    <button class="nav-item" data-view="asistencia">üìÖ<span>Asistencia</span></button>
    <button class="nav-item" data-view="instrumentos">üìù<span>Instrum</span></button>
    <button class="nav-item" data-view="evaluacion">üìä<span>Evaluar</span></button>
    <button class="nav-item" data-view="bitacora">üìñ<span>DUA</span></button>
    <button class="nav-item" data-view="alertas">üö®<span>Alertas</span></button>
    <button class="nav-item" data-view="reportes">üìë<span>Reportes</span></button>
</nav>

<script>
    (function() {
        // ==================== CONFIGURACI√ìN INICIAL Y CONSTANTES ====================
        const DB_NAME = 'MEP_DOCENTE_2026';
        const DB_VERSION = 1;
        const CODIGO_PAIS = '506'; // Costa Rica

        // Estado global reactivo
        let db = null;
        let configuracionActual = {
            id: 'configPrincipal',
            nombreCentro: 'Liceo Experimental MEP',
            codigoPresupuestario: 'MEP-001-2026',
            seccion: 'Secundaria',
            periodo: 'I Periodo',
            rubros: {
                cotidiano: 30,
                pruebas: 30,
                tareas: 20,
                proyectos: 20
            }
        };

        // ==================== INICIALIZACI√ìN DE INDEXEDDB ====================
        function inicializarDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error('Error abriendo DB:', event.target.error);
                    reject('Error al abrir la base de datos');
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('‚úÖ IndexedDB conectada');
                    cargarConfiguracionInicial().then(() => {
                        resolve(db);
                    });
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    // Store de configuraci√≥n
                    if (!db.objectStoreNames.contains('configuracion')) {
                        db.createObjectStore('configuracion', { keyPath: 'id' });
                    }

                    // Store de estudiantes
                    if (!db.objectStoreNames.contains('estudiantes')) {
                        const storeEstudiantes = db.createObjectStore('estudiantes', { keyPath: 'id', autoIncrement: true });
                        storeEstudiantes.createIndex('nombre', 'nombre', { unique: false });
                        storeEstudiantes.createIndex('cedula', 'cedula', { unique: true });
                    }

                    // Store de bit√°cora DUA
                    if (!db.objectStoreNames.contains('bitacora')) {
                        db.createObjectStore('bitacora', { keyPath: 'id', autoIncrement: true });
                    }

                    // Store de asistencia
                    if (!db.objectStoreNames.contains('asistencia')) {
                        const storeAsistencia = db.createObjectStore('asistencia', { keyPath: 'id', autoIncrement: true });
                        storeAsistencia.createIndex('fecha', 'fecha', { unique: false });
                        storeAsistencia.createIndex('estudianteId', 'estudianteId', { unique: false });
                    }

                    // Store de instrumentos
                    if (!db.objectStoreNames.contains('instrumentos')) {
                        db.createObjectStore('instrumentos', { keyPath: 'id', autoIncrement: true });
                    }

                    // Store de calificaciones
                    if (!db.objectStoreNames.contains('calificaciones')) {
                        const storeCalif = db.createObjectStore('calificaciones', { keyPath: 'id', autoIncrement: true });
                        storeCalif.createIndex('estudianteId', 'estudianteId', { unique: false });
                        storeCalif.createIndex('periodo', 'periodo', { unique: false });
                    }

                    console.log('‚úÖ Estructura de Base de Datos creada');
                };
            });
        }

        // ==================== FUNCIONES DE CARGA INICIAL ====================
        async function cargarConfiguracionInicial() {
            return new Promise((resolve) => {
                if (!db) return resolve();

                const tx = db.transaction('configuracion', 'readonly');
                const store = tx.objectStore('configuracion');
                const request = store.get('configPrincipal');

                request.onsuccess = (e) => {
                    if (e.target.result) {
                        configuracionActual = e.target.result;
                    } else {
                        // Guardar configuraci√≥n por defecto
                        guardarConfiguracion(configuracionActual);
                    }
                    actualizarHeaderInstitucional();
                    resolve();
                };

                request.onerror = () => resolve();
            });
        }

        function guardarConfiguracion(config) {
            if (!db) return;
            const tx = db.transaction('configuracion', 'readwrite');
            const store = tx.objectStore('configuracion');
            store.put(config);
            configuracionActual = config;
            actualizarHeaderInstitucional();
        }

        function actualizarHeaderInstitucional() {
            document.getElementById('nombreInstitucion').textContent = configuracionActual.nombreCentro;
            document.getElementById('infoInstitucion').textContent = 
                `${configuracionActual.codigoPresupuestario} ¬∑ ${configuracionActual.seccion} ¬∑ ${configuracionActual.periodo}`;
        }

        // ==================== VALIDACIONES CENTRALES ====================
        function validarPorcentajesRubros(rubros) {
            const suma = rubros.cotidiano + rubros.pruebas + rubros.tareas + rubros.proyectos;
            return suma === 100;
        }

        function calcularNotaFinal(estudiante, rubros) {
            if (!estudiante || !rubros) return 0;
            
            // Si tiene ACS, aplicar f√≥rmula diferenciada (50% cotidiano, 50% pruebas)
            if (estudiante.tipoAdecuacion === 'ACS') {
                return (estudiante.cotidiano * 0.5) + (estudiante.pruebas * 0.5);
            }
            
            // F√≥rmula est√°ndar con ponderaciones
            return (
                (estudiante.cotidiano || 0) * (rubros.cotidiano / 100) +
                (estudiante.pruebas || 0) * (rubros.pruebas / 100) +
                (estudiante.tareas || 0) * (rubros.tareas / 100) +
                (estudiante.proyectos || 0) * (rubros.proyectos / 100)
            ).toFixed(2);
        }

        // ==================== SISTEMA DE NAVEGACI√ìN ====================
        function cambiarVista(vistaId) {
            // Actualizar botones activos
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === vistaId);
            });

            // Renderizar vista correspondiente
            const container = document.getElementById('appMain');
            
            switch(vistaId) {
                case 'config':
                    renderizarConfiguracion(container);
                    break;
                case 'parametros':
                    renderizarParametros(container);
                    break;
                case 'estudiantes':
                    renderizarEstudiantes(container);
                    break;
                case 'asistencia':
                    renderizarAsistencia(container);
                    break;
                case 'instrumentos':
                    renderizarInstrumentos(container);
                    break;
                case 'evaluacion':
                    renderizarEvaluacion(container);
                    break;
                case 'bitacora':
                    renderizarBitacora(container);
                    break;
                case 'alertas':
                    renderizarAlertas(container);
                    break;
                case 'reportes':
                    renderizarReportes(container);
                    break;
                default:
                    renderizarConfiguracion(container);
            }
        }

        // ==================== VISTA 1: CONFIGURACI√ìN INSTITUCIONAL ====================
        function renderizarConfiguracion(container) {
            container.innerHTML = `
                <div class="card">
                    <h2>üè´ Configuraci√≥n Institucional</h2>
                    <div class="form-group">
                        <label>Nombre del Centro Educativo</label>
                        <input type="text" id="cfg-nombre" value="${configuracionActual.nombreCentro}" placeholder="Ej: Liceo de Costa Rica">
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>C√≥digo Presupuestario</label>
                            <input type="text" id="cfg-codigo" value="${configuracionActual.codigoPresupuestario}">
                        </div>
                        <div class="form-group">
                            <label>Secci√≥n</label>
                            <select id="cfg-seccion">
                                <option value="Primaria" ${configuracionActual.seccion === 'Primaria' ? 'selected' : ''}>Primaria</option>
                                <option value="Secundaria" ${configuracionActual.seccion === 'Secundaria' ? 'selected' : ''}>Secundaria</option>
                                <option value="Preescolar" ${configuracionActual.seccion === 'Preescolar' ? 'selected' : ''}>Preescolar</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Periodo Lectivo</label>
                        <select id="cfg-periodo">
                            <option value="I Periodo" ${configuracionActual.periodo === 'I Periodo' ? 'selected' : ''}>I Periodo</option>
                            <option value="II Periodo" ${configuracionActual.periodo === 'II Periodo' ? 'selected' : ''}>II Periodo</option>
                            <option value="III Periodo" ${configuracionActual.periodo === 'III Periodo' ? 'selected' : ''}>III Periodo</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="guardarConfiguracionInstitucional()">üíæ Guardar Configuraci√≥n</button>
                </div>
            `;

            // Exponer funci√≥n global
            window.guardarConfiguracionInstitucional = () => {
                const nuevaConfig = {
                    id: 'configPrincipal',
                    nombreCentro: document.getElementById('cfg-nombre').value,
                    codigoPresupuestario: document.getElementById('cfg-codigo').value,
                    seccion: document.getElementById('cfg-seccion').value,
                    periodo: document.getElementById('cfg-periodo').value,
                    rubros: configuracionActual.rubros // Mantener rubros existentes
                };
                guardarConfiguracion(nuevaConfig);
                alert('‚úÖ Configuraci√≥n guardada exitosamente');
            };
        }

        // ==================== VISTA 2: PAR√ÅMETROS DE EVALUACI√ìN ====================
        function renderizarParametros(container) {
            const r = configuracionActual.rubros;
            container.innerHTML = `
                <div class="card">
                    <h2>‚öñÔ∏è Par√°metros de Evaluaci√≥n</h2>
                    <div class="grid-4">
                        <div class="form-group">
                            <label>Trabajo Cotidiano (%)</label>
                            <input type="number" id="rubro-tc" value="${r.cotidiano}" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>Pruebas (%)</label>
                            <input type="number" id="rubro-pr" value="${r.pruebas}" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>Tareas (%)</label>
                            <input type="number" id="rubro-ta" value="${r.tareas}" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>Proyectos (%)</label>
                            <input type="number" id="rubro-py" value="${r.proyectos}" min="0" max="100">
                        </div>
                    </div>
                    <div id="suma-rubros" class="badge" style="margin-bottom:10px;"></div>
                    <button class="btn btn-primary" onclick="guardarRubros()">‚úÖ Actualizar Porcentajes</button>
                </div>
            `;

            actualizarSumaRubros();
            
            ['rubro-tc', 'rubro-pr', 'rubro-ta', 'rubro-py'].forEach(id => {
                document.getElementById(id).addEventListener('input', actualizarSumaRubros);
            });

            window.guardarRubros = () => {
                const nuevosRubros = {
                    cotidiano: parseInt(document.getElementById('rubro-tc').value) || 0,
                    pruebas: parseInt(document.getElementById('rubro-pr').value) || 0,
                    tareas: parseInt(document.getElementById('rubro-ta').value) || 0,
                    proyectos: parseInt(document.getElementById('rubro-py').value) || 0
                };

                if (!validarPorcentajesRubros(nuevosRubros)) {
                    alert('‚ùå Los porcentajes deben sumar exactamente 100%');
                    return;
                }

                configuracionActual.rubros = nuevosRubros;
                guardarConfiguracion(configuracionActual);
                alert('‚úÖ Porcentajes actualizados correctamente');
            };
        }

        function actualizarSumaRubros() {
            const tc = parseInt(document.getElementById('rubro-tc')?.value) || 0;
            const pr = parseInt(document.getElementById('rubro-pr')?.value) || 0;
            const ta = parseInt(document.getElementById('rubro-ta')?.value) || 0;
            const py = parseInt(document.getElementById('rubro-py')?.value) || 0;
            const suma = tc + pr + ta + py;
            const badge = document.getElementById('suma-rubros');
            
            if (badge) {
                badge.textContent = `Suma total: ${suma}%`;
                badge.style.backgroundColor = suma === 100 ? '#27ae60' : '#e74c3c';
            }
        }

        // ==================== VISTA 3: GESTI√ìN DE ESTUDIANTES ====================
        function renderizarEstudiantes(container) {
            container.innerHTML = `
                <div class="card">
                    <h2>üë• Registro de Estudiantes</h2>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>C√©dula / Identificaci√≥n</label>
                            <input type="text" id="est-cedula" placeholder="Ej: 1-1234-5678">
                        </div>
                        <div class="form-group">
                            <label>Nombre Completo</label>
                            <input type="text" id="est-nombre" placeholder="Nombre completo">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Tel√©fono Encargado</label>
                            <input type="tel" id="est-telefono" placeholder="8888-7777">
                        </div>
                        <div class="form-group">
                            <label>Tipo de Adecuaci√≥n</label>
                            <select id="est-adecuacion">
                                <option value="ninguna">Sin adecuaci√≥n</option>
                                <option value="acceso">Acceso</option>
                                <option value="no-significativa">No significativa</option>
                                <option value="ACS">ACS</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="agregarEstudiante()">‚ûï Agregar Estudiante</button>
                </div>
                <div class="card">
                    <h3>Listado de Estudiantes</h3>
                    <div class="table-responsive" id="lista-estudiantes">
                        <table>
                            <thead>
                                <tr>
                                    <th>C√©dula</th>
                                    <th>Nombre</th>
                                    <th>Tel√©fono</th>
                                    <th>Adecuaci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-estudiantes-body"></tbody>
                        </table>
                    </div>
                </div>
            `;

            cargarListaEstudiantes();

            window.agregarEstudiante = () => {
                const cedula = document.getElementById('est-cedula').value.trim();
                const nombre = document.getElementById('est-nombre').value.trim();
                const telefono = document.getElementById('est-telefono').value.trim();
                const adecuacion = document.getElementById('est-adecuacion').value;

                if (!cedula || !nombre) {
                    alert('‚ùå C√©dula y nombre son obligatorios');
                    return;
                }

                const tx = db.transaction('estudiantes', 'readwrite');
                const store = tx.objectStore('estudiantes');
                
                store.add({
                    cedula,
                    nombre,
                    telefono,
                    tipoAdecuacion: adecuacion,
                    cotidiano: 0,
                    pruebas: 0,
                    tareas: 0,
                    proyectos: 0
                });

                tx.oncomplete = () => {
                    alert('‚úÖ Estudiante registrado');
                    cargarListaEstudiantes();
                    // Limpiar campos
                    document.getElementById('est-cedula').value = '';
                    document.getElementById('est-nombre').value = '';
                    document.getElementById('est-telefono').value = '';
                };
            };
        }

        function cargarListaEstudiantes() {
            const tx = db.transaction('estudiantes', 'readonly');
            const store = tx.objectStore('estudiantes');
            const request = store.getAll();

            request.onsuccess = (e) => {
                const estudiantes = e.target.result;
                const tbody = document.getElementById('tabla-estudiantes-body');
                
                tbody.innerHTML = estudiantes.map(est => `
                    <tr>
                        <td>${est.cedula || '-'}</td>
                        <td>${est.nombre}</td>
                        <td>${est.telefono || '-'}</td>
                        <td>
                            <span class="badge ${est.tipoAdecuacion === 'ACS' ? 'badge-acs' : 'badge-no-acs'}">
                                ${est.tipoAdecuacion || 'Ninguna'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-danger btn-small" style="padding:5px 10px;" onclick="eliminarEstudiante(${est.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            };
        }

        window.eliminarEstudiante = (id) => {
            if (confirm('¬øEliminar este estudiante?')) {
                const tx = db.transaction('estudiantes', 'readwrite');
                const store = tx.objectStore('estudiantes');
                store.delete(id);
                tx.oncomplete = () => cargarListaEstudiantes();
            }
        };

        // ==================== VISTA 6: EVALUACI√ìN (INTEGRADA) ====================
        function renderizarEvaluacion(container) {
            container.innerHTML = `
                <div class="card">
                    <h2>üìä Matriz de Evaluaci√≥n por Rubros</h2>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    <th>ACS</th>
                                    <th>Cotidiano</th>
                                    <th>Pruebas</th>
                                    <th>Tareas</th>
                                    <th>Proyectos</th>
                                    <th>Nota Final</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="eval-tabla-body"></tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary mt-2" onclick="guardarTodasNotas()">üíæ Guardar todas las notas</button>
                </div>
            `;

            cargarMatrizEvaluacion();
        }

        function cargarMatrizEvaluacion() {
            const tx = db.transaction('estudiantes', 'readonly');
            const store = tx.objectStore('estudiantes');
            const request = store.getAll();

            request.onsuccess = (e) => {
                const estudiantes = e.target.result;
                const tbody = document.getElementById('eval-tabla-body');
                
                tbody.innerHTML = estudiantes.map(est => {
                    const notaFinal = calcularNotaFinal(est, configuracionActual.rubros);
                    const estado = parseFloat(notaFinal) >= 65 ? 'Aprobado' : parseFloat(notaFinal) >= 50 ? 'Convocatoria' : 'Reprobado';
                    
                    return `
                        <tr>
                            <td>${est.nombre}</td>
                            <td><span class="badge ${est.tipoAdecuacion === 'ACS' ? 'badge-acs' : ''}">${est.tipoAdecuacion === 'ACS' ? 'ACS' : 'No'}</span></td>
                            <td><input type="number" id="nota-${est.id}-cot" value="${est.cotidiano || 0}" min="0" max="100" step="0.1" style="width:70px;"></td>
                            <td><input type="number" id="nota-${est.id}-pr" value="${est.pruebas || 0}" min="0" max="100" step="0.1" style="width:70px;"></td>
                            <td><input type="number" id="nota-${est.id}-ta" value="${est.tareas || 0}" min="0" max="100" step="0.1" style="width:70px;"></td>
                            <td><input type="number" id="nota-${est.id}-py" value="${est.proyectos || 0}" min="0" max="100" step="0.1" style="width:70px;"></td>
                            <td><strong class="${parseFloat(notaFinal) < 65 ? 'text-danger' : 'text-success'}">${notaFinal}</strong></td>
                            <td><span class="badge ${estado === 'Aprobado' ? 'badge-no-acs' : 'badge-riesgo'}">${estado}</span></td>
                        </tr>
                    `;
                }).join('');
            };
        }

        window.guardarTodasNotas = () => {
            const tx = db.transaction('estudiantes', 'readwrite');
            const store = tx.objectStore('estudiantes');
            const request = store.getAll();

            request.onsuccess = (e) => {
                const estudiantes = e.target.result;
                
                estudiantes.forEach(est => {
                    const cot = parseFloat(document.getElementById(`nota-${est.id}-cot`)?.value) || 0;
                    const pr = parseFloat(document.getElementById(`nota-${est.id}-pr`)?.value) || 0;
                    const ta = parseFloat(document.getElementById(`nota-${est.id}-ta`)?.value) || 0;
                    const py = parseFloat(document.getElementById(`nota-${est.id}-py`)?.value) || 0;
                    
                    est.cotidiano = cot;
                    est.pruebas = pr;
                    est.tareas = ta;
                    est.proyectos = py;
                    
                    store.put(est);
                });

                alert('‚úÖ Notas guardadas correctamente');
                cargarMatrizEvaluacion(); // Recargar para mostrar nuevos promedios
            };
        };

        // ==================== VISTA 8: ALERTAS CON WHATSAPP ====================
        function renderizarAlertas(container) {
            container.innerHTML = `
                <div class="card">
                    <h2>üö® Alertas de Rendimiento</h2>
                    <div id="alertas-lista"></div>
                </div>
            `;

            const tx = db.transaction('estudiantes', 'readonly');
            const store = tx.objectStore('estudiantes');
            const request = store.getAll();

            request.onsuccess = (e) => {
                const estudiantes = e.target.result;
                const lista = document.getElementById('alertas-lista');
                
                const estudiantesEnRiesgo = estudiantes.filter(est => {
                    const nota = calcularNotaFinal(est, configuracionActual.rubros);
                    return parseFloat(nota) < 65;
                });

                if (estudiantesEnRiesgo.length === 0) {
                    lista.innerHTML = '<p class="text-success">‚úÖ No hay estudiantes con bajo rendimiento</p>';
                    return;
                }

                lista.innerHTML = estudiantesEnRiesgo.map(est => {
                    const nota = calcularNotaFinal(est, configuracionActual.rubros);
                    const telefono = est.telefono ? `${CODIGO_PAIS}${est.telefono.replace(/\D/g, '')}` : '';
                    const mensaje = encodeURIComponent(`Apreciable encargado de ${est.nombre}, su nota actual es ${nota}. Solicitamos su apoyo para mejorar su rendimiento acad√©mico. Atentamente, ${configuracionActual.nombreCentro}`);
                    
                    return `
                        <div class="card" style="margin-bottom:10px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <strong>${est.nombre}</strong><br>
                                    <span class="badge badge-riesgo">Nota: ${nota}</span>
                                </div>
                                ${telefono ? `
                                    <button class="btn btn-wa" style="width:auto; padding:10px;" onclick="window.open('https://wa.me/${telefono}?text=${mensaje}')">
                                        üì± WhatsApp
                                    </button>
                                ` : '<span class="badge">Sin tel√©fono</span>'}
                            </div>
                        </div>
                    `;
                }).join('');
            };
        }

        // ==================== VISTA 9: REPORTES PDF ====================
        function renderizarReportes(container) {
            container.innerHTML = `
                <div class="card">
                    <h2>üìë Generaci√≥n de Reportes</h2>
                    <div class="grid-2">
                        <button class="btn btn-primary" onclick="generarInformeTraslado()">üìÑ Informe de Traslado</button>
                        <button class="btn btn-success" onclick="generarActaCalificaciones()">üìä Acta de Calificaciones</button>
                    </div>
                    <button class="btn btn-secondary mt-2" onclick="exportarCSV()">üì• Exportar a Excel (CSV)</button>
                </div>
            `;

            window.generarInformeTraslado = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(16);
                doc.text(configuracionActual.nombreCentro, 15, 15);
                doc.setFontSize(10);
                doc.text(`C√≥digo: ${configuracionActual.codigoPresupuestario}`, 15, 22);
                doc.text(`Fecha: ${new Date().toLocaleDateString('es-CR')}`, 15, 28);

                const tx = db.transaction('estudiantes', 'readonly');
                const store = tx.objectStore('estudiantes');
                const request = store.getAll();

                request.onsuccess = (e) => {
                    const estudiantes = e.target.result;
                    const data = estudiantes.map(est => [
                        est.nombre,
                        est.cedula || '-',
                        calcularNotaFinal(est, configuracionActual.rubros),
                        est.tipoAdecuacion || 'Ninguna'
                    ]);

                    doc.autoTable({
                        head: [['Estudiante', 'C√©dula', 'Nota Final', 'Adecuaci√≥n']],
                        body: data,
                        startY: 35,
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [0, 51, 102] }
                    });

                    doc.save(`Informe_Traslado_${new Date().toISOString().slice(0,10)}.pdf`);
                };
            };

            window.generarActaCalificaciones = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape');
                
                doc.text('Acta de Calificaciones - MEP 2026', 15, 15);
                doc.text(configuracionActual.nombreCentro, 15, 22);

                const tx = db.transaction('estudiantes', 'readonly');
                const store = tx.objectStore('estudiantes');
                const request = store.getAll();

                request.onsuccess = (e) => {
                    const estudiantes = e.target.result;
                    const data = estudiantes.map(est => [
                        est.nombre,
                        est.cotidiano || 0,
                        est.pruebas || 0,
                        est.tareas || 0,
                        est.proyectos || 0,
                        calcularNotaFinal(est, configuracionActual.rubros)
                    ]);

                    doc.autoTable({
                        head: [['Estudiante', 'Cotidiano', 'Pruebas', 'Tareas', 'Proyectos', 'Nota Final']],
                        body: data,
                        startY: 30,
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [0, 51, 102] }
                    });

                    doc.save(`Acta_Calificaciones_${new Date().toISOString().slice(0,10)}.pdf`);
                };
            };
        }

        // ==================== VISTAS PENDIENTES POR IMPLEMENTAR (Placeholders funcionales) ====================
        function renderizarAsistencia(container) {
            container.innerHTML = `
                <div class="card">
                    <h2>üìÖ Control de Asistencia</h2>
                    <div class="form-group">
                        <label>Mes</label>
                        <select id="asist-mes">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="alert('M√≥dulo de asistencia en desarrollo profesional')">üìä Ver Asistencia</button>
                </div>
            `;
        }

        function renderizarInstrumentos(container) {
            container.innerHTML = `
                <div class="card">
                    <h2>üìù Instrumentos de Evaluaci√≥n</h2>
                    <p>Dise√±e r√∫bricas y listas de cotejo</p>
                    <button class="btn btn-primary" onclick="alert('M√≥dulo de instrumentos disponible en versi√≥n completa')">‚ûï Crear Instrumento</button>
                </div>
            `;
        }

        function renderizarBitacora(container) {
            container.innerHTML = `
                <div class="card">
                    <h2>üìñ Bit√°cora DUA</h2>
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="bit-fecha" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label>Estrategias implementadas</label>
                        <textarea id="bit-texto" rows="4" placeholder="Describa las estrategias DUA aplicadas..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="guardarBitacora()">üìù Guardar Registro</button>
                </div>
                <div class="card">
                    <h3>Registros Recientes</h3>
                    <div id="bitacora-lista"></div>
                </div>
            `;

            window.guardarBitacora = () => {
                const fecha = document.getElementById('bit-fecha').value;
                const texto = document.getElementById('bit-texto').value;

                if (!fecha || !texto) {
                    alert('Complete todos los campos');
                    return;
                }

                const tx = db.transaction('bitacora', 'readwrite');
                const store = tx.objectStore('bitacora');
                store.add({ fecha, texto, timestamp: Date.now() });

                tx.oncomplete = () => {
                    alert('‚úÖ Registro guardado');
                    document.getElementById('bit-texto').value = '';
                    cargarBitacora();
                };
            };

            cargarBitacora();
        }

        function cargarBitacora() {
            const tx = db.transaction('bitacora', 'readonly');
            const store = tx.objectStore('bitacora');
            const request = store.getAll();

            request.onsuccess = (e) => {
                const registros = e.target.result.slice(-5).reverse();
                const lista = document.getElementById('bitacora-lista');
                
                lista.innerHTML = registros.map(r => `
                    <div class="card" style="margin-bottom:8px; padding:10px;">
                        <strong>${r.fecha}</strong>
                        <p style="margin-top:5px;">${r.texto}</p>
                    </div>
                `).join('') || '<p>No hay registros</p>';
            };
        }

        // ==================== INICIALIZACI√ìN ====================
        async function iniciarSistema() {
            await inicializarDB();
            
            // Configurar navegaci√≥n
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    cambiarVista(e.currentTarget.dataset.view);
                });
            });

            // Cargar vista inicial
            cambiarVista('config');
        }

        // Exponer funciones globales necesarias
        window.cambiarVista = cambiarVista;
        window.validarPorcentajesRubros = validarPorcentajesRubros;

        // Iniciar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', iniciarSistema);
        } else {
            iniciarSistema();
        }
    })();
</script>
</body>
</html>
