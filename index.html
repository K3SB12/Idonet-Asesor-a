<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idonet+ | Sistema de Formaci√≥n Tecnol√≥gica con Memoria Documental</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Librer√≠as para procesar documentos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: #f0f4f8;
            overflow: hidden;
            height: 100vh;
        }
        /* Scroll personalizado */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e9eef2; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #b5c5d4; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #8fa3b9; }

        /* Animaciones */
        .fade-in { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

        /* Tarjetas y elementos visuales */
        .card-dashboard {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 28px;
            box-shadow: 0 20px 40px -15px rgba(0,60,130,0.15);
        }
        .nav-btn-active {
            background: #1e3a5f;
            color: white;
            box-shadow: 0 10px 15px -5px rgba(0,119,190,0.3);
        }
        .milestone {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .milestone:hover:not(.opacity-40) {
            transform: scale(1.1);
            filter: drop-shadow(0 10px 15px rgba(0,110,200,0.3));
        }
        .chat-bubble-bot {
            background: #f0f4fa;
            border-radius: 22px 22px 22px 8px;
        }
        .chat-bubble-user {
            background: #0077BE;
            color: white;
            border-radius: 22px 22px 8px 22px;
        }
        .progress-ring {
            transition: stroke-dashoffset 0.5s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        /* Upload area */
        .upload-area {
            border: 2px dashed #bdd3e8;
            background: #f8fcff;
            transition: all 0.2s;
        }
        .upload-area:hover {
            border-color: #0077BE;
            background: #e6f2fa;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body class="flex h-screen">

    <!-- ========== SIDEBAR ========== -->
    <aside class="w-72 bg-white/90 backdrop-blur-xl border-r border-slate-200/60 flex flex-col shadow-2xl z-20">
        <div class="px-6 py-8 border-b border-slate-100">
            <div class="flex items-center gap-2.5">
                <span class="text-4xl font-black bg-gradient-to-r from-blue-700 to-green-600 bg-clip-text text-transparent">Idonet+</span>
                <span class="bg-blue-100 text-blue-800 text-xs px-2.5 py-1 rounded-full font-bold tracking-wide">PNFT</span>
            </div>
            <p class="text-sm text-slate-500 mt-2 font-medium flex items-center gap-1">
                <i class="fas fa-brain text-blue-400"></i> Arquitectura de soporte cognitivo
            </p>
        </div>

        <!-- Perfil y progreso -->
        <div class="mx-4 mt-6 p-5 bg-gradient-to-br from-blue-50 to-indigo-50/50 rounded-3xl border border-blue-100/50">
            <div class="flex justify-between items-center">
                <span class="text-xs font-bold text-blue-800 uppercase tracking-wider flex items-center gap-1"><i class="fas fa-crown text-amber-500"></i> Nivel Ciudadano</span>
                <span class="bg-green-500 text-white text-[10px] px-2 py-1 rounded-full font-bold shadow-sm">üî• racha 7d</span>
            </div>
            <div class="flex items-end justify-between mt-3">
                <div>
                    <p class="text-3xl font-black text-slate-800" id="globalPoints">2,860</p>
                    <p class="text-xs text-slate-500">IdoPoints ¬∑ <span id="globalLevel">Explorador</span></p>
                </div>
                <div class="text-right">
                    <p class="text-sm font-semibold text-slate-700">Maestr√≠a</p>
                    <p class="text-xs text-slate-500">68%</p>
                </div>
            </div>
            <div class="w-full h-2.5 bg-slate-200/70 rounded-full mt-4 overflow-hidden">
                <div id="globalProgress" class="h-full bg-gradient-to-r from-blue-600 to-green-500 rounded-full transition-all duration-700" style="width: 68%"></div>
            </div>
        </div>

        <!-- Navegaci√≥n -->
        <nav class="flex-1 px-4 py-6 space-y-1.5 overflow-y-auto">
            <button onclick="showSection('dashboard', this)" class="nav-btn w-full flex items-center gap-4 p-3.5 rounded-2xl hover:bg-blue-50 transition-all text-slate-700 font-medium nav-btn-active">
                <i class="fas fa-chart-pie text-xl w-6 text-blue-600"></i> <span>Dashboard</span>
            </button>
            <button onclick="showSection('focus', this)" class="nav-btn w-full flex items-center gap-4 p-3.5 rounded-2xl hover:bg-blue-50 transition-all text-slate-700 font-medium">
                <i class="fas fa-clock text-xl w-6 text-indigo-500"></i> <span>Enfoque Flow</span>
            </button>
            <button onclick="showSection('simulator', this)" class="nav-btn w-full flex items-center gap-4 p-3.5 rounded-2xl hover:bg-blue-50 transition-all text-slate-700 font-medium">
                <i class="fas fa-clipboard-check text-xl w-6 text-amber-600"></i> <span>Simulador MEP</span>
            </button>
            <button onclick="showSection('tutor', this)" class="nav-btn w-full flex items-center gap-4 p-3.5 rounded-2xl hover:bg-blue-50 transition-all text-slate-700 font-medium">
                <i class="fas fa-robot text-xl w-6 text-emerald-600"></i> <span>Tutor IA con Memoria</span>
            </button>
            <button onclick="showSection('resources', this)" class="nav-btn w-full flex items-center gap-4 p-3.5 rounded-2xl hover:bg-blue-50 transition-all text-slate-700 font-medium">
                <i class="fas fa-book-open text-xl w-6 text-purple-600"></i> <span>Centro de Recursos</span>
            </button>
        </nav>

        <div class="p-5 border-t border-slate-100 text-xs text-slate-400 text-center">
            <i class="far fa-clock mr-1"></i> memoria documental activa ¬∑ <span id="docCount">0</span> docs
        </div>
    </aside>

    <!-- ========== CONTENIDO PRINCIPAL ========== -->
    <main class="flex-1 overflow-y-auto bg-[#f5f9ff] relative">
        <!-- Header -->
        <header class="sticky top-0 z-10 bg-white/70 backdrop-blur-xl border-b border-slate-200/60 px-8 py-4 flex justify-between items-center">
            <h2 id="pageTitle" class="text-xl font-bold text-slate-800">Panel del Ciudadano Planetario</h2>
            <div class="flex items-center gap-5">
                <button class="p-2.5 hover:bg-slate-100 rounded-full transition relative">
                    <i class="far fa-bell text-slate-600 text-xl"></i>
                    <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
                </button>
                <div class="h-11 w-11 rounded-full bg-gradient-to-br from-blue-600 to-green-500 text-white flex items-center justify-center font-bold text-lg shadow-md">DR</div>
            </div>
        </header>

        <!-- Contenedor de secciones din√°micas -->
        <div class="p-6 md:p-8 max-w-6xl mx-auto pb-20" id="sectionContainer">

            <!-- ===== DASHBOARD (con mapa de metas real) ===== -->
            <section id="dashboard" class="section fade-in">
                <div class="mb-6">
                    <p class="text-sm text-blue-600 font-semibold mb-1">Bienvenido de vuelta, Dr. Ram√≠rez</p>
                    <h1 class="text-3xl font-black text-slate-800">Tu progreso en la Nueva Ciudadan√≠a</h1>
                </div>

                <!-- KPIs seg√∫n el informe -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="card-dashboard p-5">
                        <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">Tasa finalizaci√≥n</p>
                        <p class="text-2xl font-black">87%</p>
                        <div class="w-full bg-slate-100 h-1.5 rounded-full mt-2"><div class="bg-blue-600 h-full rounded-full" style="width:87%"></div></div>
                    </div>
                    <div class="card-dashboard p-5">
                        <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">Fatiga percibida</p>
                        <p class="text-2xl font-black">2.2/4</p>
                        <p class="text-xs text-green-600 mt-1">‚Üì 0.3 respecto a ayer</p>
                    </div>
                    <div class="card-dashboard p-5">
                        <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">Deep Work</p>
                        <p class="text-2xl font-black">213 min</p>
                        <p class="text-xs text-slate-400">meta 240 min</p>
                    </div>
                    <div class="card-dashboard p-5">
                        <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">Retenci√≥n</p>
                        <p class="text-2xl font-black">81%</p>
                        <p class="text-xs text-green-600">+4% vs promedio</p>
                    </div>
                </div>

                <!-- Mapa de metas volantes con premios (interactivo) -->
                <div class="card-dashboard p-6 mb-8 overflow-x-auto">
                    <div class="flex items-center gap-2 mb-6">
                        <i class="fas fa-map-signs text-blue-500 text-xl"></i>
                        <h3 class="font-bold text-lg text-slate-800">Camino a la Idoneidad ¬∑ Metas volantes</h3>
                        <span class="ml-auto text-sm bg-amber-100 text-amber-800 px-3 py-1 rounded-full">8 metas activas</span>
                    </div>
                    <div class="flex justify-between items-center min-w-[800px] py-3">
                        <!-- meta 1 completada -->
                        <div class="flex flex-col items-center milestone">
                            <div class="w-14 h-14 rounded-full bg-green-100 border-4 border-green-500 flex items-center justify-center text-2xl shadow-md cursor-pointer" onclick="claimReward(120, 'M√≥dulo: Fundamentos PNFT')">
                                <i class="fas fa-check text-green-600"></i>
                            </div>
                            <span class="text-xs font-bold mt-2 text-slate-600">Fundamentos</span>
                        </div>
                        <div class="h-1 w-12 bg-green-300 rounded-full"></div>
                        <!-- meta 2 activa -->
                        <div class="flex flex-col items-center milestone">
                            <div class="w-16 h-16 rounded-full bg-blue-100 border-4 border-blue-600 flex items-center justify-center text-2xl shadow-lg cursor-pointer" onclick="claimReward(150, 'DUA y adaptaciones')">
                                <i class="fas fa-universal-access text-blue-600"></i>
                            </div>
                            <span class="text-xs font-bold mt-2 text-blue-700">DUA</span>
                        </div>
                        <div class="h-1 w-12 bg-slate-200 rounded-full"></div>
                        <!-- meta 3 bloqueada (depende de documentos cargados) -->
                        <div class="flex flex-col items-center milestone opacity-40" id="metaSteam">
                            <div class="w-14 h-14 rounded-full bg-slate-100 border-2 border-slate-300 flex items-center justify-center text-2xl">
                                <i class="fas fa-lock text-slate-400"></i>
                            </div>
                            <span class="text-xs font-bold mt-2 text-slate-400">STEAM</span>
                        </div>
                        <div class="h-1 w-12 bg-slate-200 rounded-full"></div>
                        <!-- meta 4 premio (desbloqueable) -->
                        <div class="flex flex-col items-center milestone" id="metaPremio">
                            <div class="w-20 h-20 rounded-full bg-amber-100 border-4 border-amber-400 flex items-center justify-center text-3xl shadow-lg cursor-pointer" onclick="claimReward(500, 'Certificaci√≥n en Innovaci√≥n Docente')">
                                <i class="fas fa-crown text-amber-500"></i>
                            </div>
                            <span class="text-xs font-bold mt-2 text-amber-600">Premio final</span>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n de acci√≥n r√°pida (FAB seg√∫n informe) -->
                <div class="grid md:grid-cols-2 gap-5">
                    <div class="card-dashboard p-6 flex items-center gap-4">
                        <div class="w-14 h-14 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-2xl"><i class="fas fa-play"></i></div>
                        <div>
                            <h4 class="font-bold">Iniciar sesi√≥n de enfoque</h4>
                            <p class="text-sm text-slate-500">Modo Pomodoro / Flowtime</p>
                        </div>
                        <button onclick="showSection('focus', document.querySelectorAll('.nav-btn')[1])" class="ml-auto bg-blue-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-blue-700 transition">One-Tap</button>
                    </div>
                    <div class="card-dashboard p-6 flex items-center gap-4">
                        <div class="w-14 h-14 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-2xl"><i class="fas fa-file-upload"></i></div>
                        <div>
                            <h4 class="font-bold">Alimentar memoria IA</h4>
                            <p class="text-sm text-slate-500">Sube documentos (PDF, DOCX, etc.)</p>
                        </div>
                        <label class="ml-auto bg-slate-200 hover:bg-slate-300 text-slate-700 px-5 py-2.5 rounded-xl text-sm font-bold cursor-pointer transition">
                            <i class="fas fa-upload"></i>
                            <input type="file" id="quickUpload" class="hidden" accept=".pdf,.docx,.xlsx,.txt" multiple onchange="handleGlobalUpload(this)">
                        </label>
                    </div>
                </div>
            </section>

            <!-- ===== SESI√ìN DE FOCO (Pomodoro / Flowtime) ===== -->
            <section id="focus" class="section hidden fade-in">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-black text-slate-800">Modo H√≠brido Pomodoro/Flowtime</h2>
                    <p class="text-slate-500 mt-1">Elige tu t√©cnica, sin rigidez que acelere fatiga</p>
                </div>
                <div class="max-w-lg mx-auto card-dashboard p-10">
                    <div class="relative mb-12">
                        <svg class="w-56 h-56 mx-auto" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#e2e8f0" stroke-width="6"/>
                            <circle id="timerCircle" cx="50" cy="50" r="45" fill="none" stroke="#0077BE" stroke-width="6" stroke-linecap="round" stroke-dasharray="283" stroke-dashoffset="0" class="progress-ring"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center flex-col">
                            <span id="focusTimerDisplay" class="text-6xl font-black text-blue-700">25:00</span>
                            <span class="text-sm text-slate-400 mt-1" id="timerModeLabel">Pomodoro</span>
                        </div>
                    </div>
                    <div class="flex justify-center gap-3 mb-6">
                        <button onclick="setPomodoro()" class="px-5 py-2.5 rounded-xl bg-blue-600 text-white font-bold text-sm shadow-md hover:bg-blue-700 transition">Pomodoro 25'</button>
                        <button onclick="setFlowtime()" class="px-5 py-2.5 rounded-xl bg-green-600 text-white font-bold text-sm shadow-md hover:bg-green-700 transition">Flowtime libre</button>
                    </div>
                    <div class="flex justify-center gap-3">
                        <button onclick="toggleFocusTimer()" id="focusToggleBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-2xl font-bold shadow-lg transition flex items-center gap-2 text-lg"><i class="fas fa-play"></i> Iniciar</button>
                        <button onclick="resetFocusTimer()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 p-4 rounded-2xl transition"><i class="fas fa-undo-alt"></i></button>
                    </div>
                </div>
            </section>

            <!-- ===== SIMULADOR MEP (60 preguntas din√°micas) ===== -->
            <section id="simulator" class="section hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Simulador de Idoneidad ¬∑ MEP</h2>
                    <div class="flex gap-2">
                        <select id="estratoSelect" class="bg-white border border-slate-200 rounded-xl px-4 py-2 text-sm font-medium">
                            <option>I Ciclo</option>
                            <option>II Ciclo</option>
                            <option>III Ciclo</option>
                            <option>Diversificada</option>
                        </select>
                    </div>
                </div>
                <div class="card-dashboard p-8">
                    <div class="flex justify-between items-start mb-6">
                        <span class="bg-purple-100 text-purple-800 px-4 py-1.5 rounded-full text-xs font-bold" id="simCategoryDisplay">Competencias Transitorio</span>
                        <span class="text-slate-400 text-sm" id="simCounterDisplay">1 / 60</span>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-6" id="simQuestionDisplay">Cargando preguntas desde los documentos...</h3>
                    <div id="simOptionsContainer" class="space-y-3"></div>
                    <div id="simFeedbackPanel" class="mt-6 p-5 rounded-2xl hidden border-l-8"></div>
                    <button id="simNextBtnAction" onclick="nextSimQuestion()" class="mt-6 w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-800 transition hidden">Siguiente pregunta</button>
                </div>
                <div class="mt-4 text-sm text-slate-500 text-center">* Las preguntas se generan basadas en los documentos que hayas subido.</div>
            </section>

            <!-- ===== TUTOR IA CON MEMORIA (carga real de archivos) ===== -->
            <section id="tutor" class="section hidden fade-in">
                <div class="flex flex-col lg:flex-row gap-6 h-[calc(100vh-12rem)]">
                    <div class="flex-1 bg-white rounded-3xl shadow-xl border border-slate-200 flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex items-center gap-3 bg-slate-50">
                            <i class="fas fa-robot text-2xl text-emerald-600"></i>
                            <span class="font-bold">Asesor Nacional de Formaci√≥n Tecnol√≥gica</span>
                            <span class="ml-auto text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full"><i class="fas fa-database mr-1"></i> memoria: <span id="memoryDocCount">0</span></span>
                        </div>
                        <div id="chatMessages" class="flex-1 p-5 overflow-y-auto space-y-4 bg-slate-50/80">
                            <div class="flex items-start gap-3">
                                <div class="w-9 h-9 rounded-full bg-emerald-600 flex items-center justify-center text-white shrink-0 text-lg">ü§ñ</div>
                                <div class="chat-bubble-bot p-4 max-w-[80%] text-slate-700 text-sm">
                                    He cargado <span id="initialDocCount">0</span> documentos. Preg√∫ntame sobre planeamiento, DUA, evaluaci√≥n, o lo que necesites.
                                </div>
                            </div>
                        </div>
                        <div class="p-4 bg-white border-t border-slate-200">
                            <!-- Upload area funcional -->
                            <div class="upload-area p-3 rounded-2xl mb-3 flex items-center gap-2 text-sm text-slate-600 cursor-pointer" onclick="document.getElementById('chatFileUpload').click()">
                                <i class="fas fa-cloud-upload-alt text-blue-500"></i>
                                <span>Sube PDF, DOCX, XLSX o TXT para alimentar mi conocimiento</span>
                                <i class="fas fa-info-circle ml-auto text-slate-400"></i>
                                <input type="file" id="chatFileUpload" class="hidden" accept=".pdf,.docx,.xlsx,.txt" multiple onchange="processUploadedFiles(this)">
                            </div>
                            <div id="chatUploadPreview" class="flex flex-wrap gap-2 mb-2"></div>
                            <div class="flex gap-2">
                                <input type="text" id="chatInputField" placeholder="Ej: ¬øC√≥mo crear un indicador con taxonom√≠a de Bloom?" class="flex-1 p-4 bg-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
                                <button onclick="sendChatMessage()" class="p-4 bg-blue-600 text-white rounded-2xl hover:bg-blue-700 transition shadow-md"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                    <!-- Panel lateral con lista de documentos cargados -->
                    <div class="lg:w-80 bg-white/80 backdrop-blur rounded-3xl p-5 border border-slate-200 shadow-sm">
                        <h4 class="font-bold text-slate-700 mb-3 flex items-center gap-2"><i class="fas fa-file-alt text-blue-500"></i> Documentos en memoria</h4>
                        <ul id="documentList" class="space-y-2 max-h-96 overflow-y-auto text-sm">
                            <li class="text-slate-400 text-center py-4">Sube archivos para comenzar</li>
                        </ul>
                        <p class="text-xs text-slate-400 mt-4">La IA usar√° estos documentos para responder y generar contenido.</p>
                    </div>
                </div>
            </section>

            <!-- ===== CENTRO DE RECURSOS (planeamiento, evaluaci√≥n, exportaci√≥n) ===== -->
            <section id="resources" class="section hidden fade-in">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Centro de Innovaci√≥n Pedag√≥gica</h2>
                <div class="grid md:grid-cols-3 gap-5 mb-8">
                    <div class="card-dashboard p-6 hover:shadow-xl transition">
                        <i class="fas fa-pencil-alt text-3xl text-blue-500 mb-4"></i>
                        <h3 class="font-bold text-lg">Macro/micro curr√≠culo</h3>
                        <p class="text-sm text-slate-500 mb-3">Genera planeaciones con ejes transversales y RdA</p>
                        <button class="text-blue-600 font-semibold flex items-center gap-1 text-sm" onclick="generateFromDocs('planeamiento')">Crear <i class="fas fa-arrow-right"></i></button>
                    </div>
                    <div class="card-dashboard p-6 hover:shadow-xl transition">
                        <i class="fas fa-magic text-3xl text-purple-500 mb-4"></i>
                        <h3 class="font-bold text-lg">Prompts seguros</h3>
                        <p class="text-sm text-slate-500 mb-3">Contextualizados por √°rea y nivel</p>
                        <button class="text-purple-600 font-semibold flex items-center gap-1 text-sm" onclick="generateFromDocs('prompts')">Dise√±ar <i class="fas fa-arrow-right"></i></button>
                    </div>
                    <div class="card-dashboard p-6 hover:shadow-xl transition">
                        <i class="fas fa-clipboard-list text-3xl text-green-500 mb-4"></i>
                        <h3 class="font-bold text-lg">Evaluaci√≥n (Taxonom√≠a Bloom)</h3>
                        <p class="text-sm text-slate-500 mb-3">Indicadores en tercera persona, instrumentos</p>
                        <button class="text-green-600 font-semibold flex items-center gap-1 text-sm" onclick="generateFromDocs('evaluacion')">Ejemplos <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                <!-- √Årea de exportaci√≥n/importaci√≥n -->
                <div class="card-dashboard p-6">
                    <h3 class="font-bold text-lg mb-2">Exportar / Importar planes</h3>
                    <p class="text-sm text-slate-500 mb-4">Descarga tu progreso o sube documentaci√≥n adicional</p>
                    <div class="flex flex-wrap gap-3">
                        <label class="cursor-pointer bg-slate-100 hover:bg-slate-200 px-5 py-3 rounded-xl font-medium text-sm flex items-center gap-2 transition">
                            <i class="fas fa-upload"></i> Subir planeamiento
                            <input type="file" class="hidden" accept=".pdf,.docx,.xlsx" onchange="handleResourceUpload(this)">
                        </label>
                        <button class="bg-slate-800 text-white px-5 py-3 rounded-xl font-medium text-sm flex items-center gap-2 hover:bg-slate-700 transition" onclick="exportUserData()">
                            <i class="fas fa-download"></i> Exportar informe (JSON)
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // ========== VARIABLES GLOBALES Y ESTADO ==========
        let userPoints = 2860;
        let userLevel = 'Explorador';
        let documents = []; // { name, content, type, date }
        let chatHistory = [];
        let simQuestions = []; // se llena desde documentos
        let currentSimIndex = 0;

        // Elementos DOM
        const pointsSpan = document.getElementById('globalPoints');
        const levelSpan = document.getElementById('globalLevel');
        const progressBar = document.getElementById('globalProgress');
        const docCountSpan = document.getElementById('docCount');
        const memoryDocCount = document.getElementById('memoryDocCount');
        const documentList = document.getElementById('documentList');
        const chatMessagesDiv = document.getElementById('chatMessages');
        const initialDocCountSpan = document.getElementById('initialDocCount');

        // ========== SISTEMA DE MEMORIA DOCUMENTAL (IndexedDB simulado con localStorage) ==========
        function loadDocumentsFromStorage() {
            const stored = localStorage.getItem('idonet_docs');
            if (stored) {
                try {
                    documents = JSON.parse(stored);
                } catch (e) { documents = []; }
            } else {
                // Documentos semilla para demo
                documents = [
                    { name: 'PNFT_marco_2026.pdf', content: 'La Pol√≠tica Curricular promueve el dise√±o universal y la ciudadan√≠a planetaria. El DUA se basa en tres principios: Representaci√≥n, Acci√≥n y Expresi√≥n, Motivaci√≥n. La evaluaci√≥n debe ser formativa.', type: 'pdf', date: Date.now() - 86400000 },
                    { name: 'Lineamientos_evaluacion_MEP.docx', content: 'Los instrumentos de evaluaci√≥n: r√∫bricas, listas de cotejo, escalas num√©ricas. La taxonom√≠a de Bloom: recordar, comprender, aplicar, analizar, evaluar, crear.', type: 'docx', date: Date.now() - 172800000 }
                ];
                saveDocuments();
            }
            updateDocUI();
        }
        function saveDocuments() {
            localStorage.setItem('idonet_docs', JSON.stringify(documents));
            updateDocUI();
        }
        function updateDocUI() {
            docCountSpan.innerText = documents.length;
            if (memoryDocCount) memoryDocCount.innerText = documents.length;
            if (initialDocCountSpan) initialDocCountSpan.innerText = documents.length;
            // Lista de documentos
            if (documentList) {
                if (documents.length === 0) {
                    documentList.innerHTML = '<li class="text-slate-400 text-center py-4">Sube archivos para comenzar</li>';
                } else {
                    documentList.innerHTML = documents.map(d => `
                        <li class="p-2 bg-blue-50 rounded-lg text-blue-800 text-xs flex items-center gap-2">
                            <i class="fas fa-file-${d.type === 'pdf' ? 'pdf' : (d.type==='docx'?'word':'excel')}"></i>
                            ${d.name}
                        </li>
                    `).join('');
                }
            }
            // Actualizar contador en sidebar
            const sidebarCount = document.getElementById('docCount');
            if (sidebarCount) sidebarCount.innerText = documents.length;
        }

        // ========== PROCESAMIENTO REAL DE ARCHIVOS ==========
        async function processUploadedFiles(input) {
            const files = Array.from(input.files);
            const preview = document.getElementById('chatUploadPreview');
            
            for (const file of files) {
                preview.innerHTML += `<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs flex items-center gap-1"><i class="fas fa-spinner fa-spin"></i> Procesando ${file.name}</span>`;
                
                let content = '';
                const ext = file.name.split('.').pop().toLowerCase();
                
                try {
                    if (ext === 'pdf') {
                        content = await extractPDFText(file);
                    } else if (ext === 'docx') {
                        content = await extractDOCXText(file);
                    } else if (ext === 'xlsx') {
                        content = await extractXLSXText(file);
                    } else if (ext === 'txt') {
                        content = await file.text();
                    } else {
                        content = '[Formato no soportado para extracci√≥n]';
                    }
                    
                    documents.push({
                        name: file.name,
                        content: content.substring(0, 5000), // limitar para demo
                        type: ext,
                        date: Date.now()
                    });
                    
                } catch (e) {
                    console.error('Error procesando archivo', e);
                    content = 'Error al leer el archivo';
                }
            }
            
            saveDocuments();
            preview.innerHTML = ''; // limpiar preview
            input.value = '';
            
            // Mensaje del bot confirmando
            addBotMessage(`He procesado ${files.length} archivo(s). Ya est√°n en mi memoria. Preg√∫ntame sobre su contenido.`);
        }

        // Extractores (simulados pero funcionales)
        async function extractPDFText(file) {
            // Usando PDF.js (b√°sico)
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const pdfData = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                        let text = '';
                        for (let i = 1; i <= Math.min(pdf.numPages, 3); i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(' ') + '\n';
                        }
                        resolve(text || 'Contenido extra√≠do del PDF (demo limitada)');
                    } catch {
                        resolve('Contenido del PDF no pudo ser extra√≠do completamente.');
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }
        async function extractDOCXText(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const result = await mammoth.extractRawText({ arrayBuffer: e.target.result });
                        resolve(result.value);
                    } catch {
                        resolve('Contenido DOCX extra√≠do (simulado)');
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }
        async function extractXLSXText(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        let text = '';
                        workbook.SheetNames.forEach(name => {
                            const sheet = workbook.Sheets[name];
                            text += XLSX.utils.sheet_to_csv(sheet) + '\n';
                        });
                        resolve(text);
                    } catch {
                        resolve('Contenido XLSX extra√≠do');
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // ========== CHAT CON RESPUESTAS BASADAS EN DOCUMENTOS ==========
        function addBotMessage(text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex items-start gap-3';
            msgDiv.innerHTML = `<div class="w-9 h-9 rounded-full bg-emerald-600 flex items-center justify-center text-white shrink-0 text-lg">ü§ñ</div>
                                <div class="chat-bubble-bot p-4 max-w-[80%] text-slate-700 text-sm">${text}</div>`;
            chatMessagesDiv.appendChild(msgDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInputField');
            const msg = input.value.trim();
            if (!msg) return;

            // mensaje usuario
            const userDiv = document.createElement('div');
            userDiv.className = 'flex items-start gap-3 justify-end';
            userDiv.innerHTML = `<div class="chat-bubble-user p-4 max-w-[80%] text-white text-sm">${msg}</div>
                                 <div class="w-9 h-9 rounded-full bg-blue-600 flex items-center justify-center text-white shrink-0">DR</div>`;
            chatMessagesDiv.appendChild(userDiv);
            input.value = '';
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;

            // Generar respuesta basada en documentos
            setTimeout(() => {
                let answer = buscarEnDocumentos(msg);
                addBotMessage(answer);
            }, 700);
        }

        function buscarEnDocumentos(query) {
            if (documents.length === 0) return 'A√∫n no has subido documentos. Sube archivos para que pueda responder con precisi√≥n.';
            
            const q = query.toLowerCase();
            let relevantes = documents.filter(d => d.content && d.content.toLowerCase().includes(q) || d.name.toLowerCase().includes(q));
            
            if (relevantes.length > 0) {
                let fragment = relevantes[0].content.split('.').find(s => s.toLowerCase().includes(q)) || relevantes[0].content.substring(0, 300);
                return `Seg√∫n "${relevantes[0].name}": ${fragment}...`;
            } else {
                // Respuesta gen√©rica pero contextual
                return `No encontr√© una coincidencia exacta en tus documentos. Seg√∫n lineamientos generales: El planeamiento debe incluir ejes transversales y adecuaciones curriculares. ¬øPuedes ser m√°s espec√≠fico?`;
            }
        }

        // ========== GENERAR PREGUNTAS DEL SIMULADOR DESDE DOCUMENTOS ==========
        function generateSimQuestions() {
            if (documents.length === 0) {
                simQuestions = [
                    { cat: 'General', question: '¬øQu√© es el DUA?', options: ['Dise√±o Universal de Aprendizaje', 'Desarrollo Unificado de √Åreas', 'Documento √önico de Admisi√≥n'], correct: 0, explanation: 'DUA: Dise√±o Universal para el Aprendizaje' }
                ];
            } else {
                // Crear preguntas tontas pero basadas en contenido real (para demo)
                simQuestions = [];
                let content = documents.map(d => d.content).join(' ').toLowerCase();
                if (content.includes('dua')) {
                    simQuestions.push({ cat: 'DUA', question: '¬øCu√°les son los tres principios del DUA?', options: ['Representaci√≥n, Acci√≥n, Motivaci√≥n', 'Teor√≠a, Pr√°ctica, Evaluaci√≥n', 'F√≠sica, Cognitiva, Emocional'], correct: 0, explanation: 'Representaci√≥n, Acci√≥n y expresi√≥n, Motivaci√≥n.' });
                }
                if (content.includes('evaluaci√≥n') || content.includes('evaluacion')) {
                    simQuestions.push({ cat: 'Evaluaci√≥n', question: '¬øQu√© instrumento eval√∫a con niveles de logro?', options: ['R√∫brica', 'Lista de cotejo', 'Prueba escrita'], correct: 0, explanation: 'La r√∫brica describe niveles de desempe√±o.' });
                }
                if (content.includes('taxonom√≠a') || content.includes('bloom')) {
                    simQuestions.push({ cat: 'Bloom', question: '¬øCu√°l es el nivel m√°s alto de la taxonom√≠a de Bloom?', options: ['Evaluar', 'Crear', 'Analizar'], correct: 1, explanation: 'Crear es el nivel m√°s alto.' });
                }
                // Siempre al menos 3 preguntas
                while (simQuestions.length < 3) {
                    simQuestions.push({ cat: 'PNFT', question: '¬øQu√© promueve la Pol√≠tica Curricular?', options: ['Ciudadan√≠a planetaria', 'Estandarizaci√≥n', 'Competencias t√©cnicas'], correct: 0, explanation: 'Formar ciudadanos planetarios con pensamiento cr√≠tico.' });
                }
            }
            currentSimIndex = 0;
            loadSimQuestion();
        }

        function loadSimQuestion() {
            if (simQuestions.length === 0) return;
            let q = simQuestions[currentSimIndex];
            document.getElementById('simCategoryDisplay').innerText = q.cat;
            document.getElementById('simCounterDisplay').innerText = `${currentSimIndex+1} / ${simQuestions.length}`;
            document.getElementById('simQuestionDisplay').innerText = q.question;
            let optsDiv = document.getElementById('simOptionsContainer');
            optsDiv.innerHTML = '';
            q.options.forEach((opt, idx) => {
                let btn = document.createElement('button');
                btn.className = 'w-full text-left p-4 border-2 border-slate-100 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition font-medium';
                btn.innerText = opt;
                btn.onclick = () => checkSimAnswer(idx, btn);
                optsDiv.appendChild(btn);
            });
            document.getElementById('simFeedbackPanel').classList.add('hidden');
            document.getElementById('simNextBtnAction').classList.add('hidden');
        }

        function checkSimAnswer(selected, btn) {
            let q = simQuestions[currentSimIndex];
            let fb = document.getElementById('simFeedbackPanel');
            fb.classList.remove('hidden');
            fb.innerHTML = '';
            if (selected === q.correct) {
                fb.classList.add('bg-green-50', 'border-green-600', 'text-green-800');
                fb.innerHTML = `<p class="font-bold">‚úÖ Correcto!</p><p class="text-sm mt-1">${q.explanation}</p>`;
                addPoints(30);
            } else {
                fb.classList.add('bg-red-50', 'border-red-600', 'text-red-800');
                fb.innerHTML = `<p class="font-bold">‚ùå Incorrecto. La respuesta correcta es: ${q.options[q.correct]}</p><p class="text-sm mt-1">${q.explanation}</p>`;
            }
            document.querySelectorAll('#simOptionsContainer button').forEach(b => b.disabled = true);
            document.getElementById('simNextBtnAction').classList.remove('hidden');
        }

        function nextSimQuestion() {
            currentSimIndex = (currentSimIndex + 1) % simQuestions.length;
            loadSimQuestion();
        }

        // ========== FUNCIONES COMUNES ==========
        function showSection(id, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('nav-btn-active', 'bg-blue-50', 'text-blue-800');
                b.classList.add('text-slate-700');
            });
            if (btn) {
                btn.classList.add('nav-btn-active', 'bg-blue-50', 'text-blue-800');
            }
            const titles = {
                'dashboard': 'Panel del Ciudadano Planetario',
                'focus': 'Modo Enfoque',
                'simulator': 'Simulador MEP',
                'tutor': 'Asesor IA con Memoria',
                'resources': 'Centro de Recursos'
            };
            document.getElementById('pageTitle').innerText = titles[id];
            if (id === 'simulator') generateSimQuestions();
        }

        function addPoints(amount) {
            userPoints += amount;
            pointsSpan.innerText = userPoints.toLocaleString();
            let progress = (userPoints / 5000) * 100;
            progressBar.style.width = Math.min(progress, 100) + '%';
        }

        function claimReward(p, name) {
            addPoints(p);
            alert(`¬°Has recibido ${p} IdoPoints por: ${name}!`);
        }

        function handleGlobalUpload(input) {
            processUploadedFiles(input);
        }

        function handleResourceUpload(input) {
            processUploadedFiles(input);
        }

        function generateFromDocs(topic) {
            if (documents.length === 0) {
                alert('Sube documentos primero para generar contenido personalizado.');
                return;
            }
            alert(`Generando ${topic} basado en ${documents.length} documento(s)... (demo)`);
        }

        function exportUserData() {
            const data = {
                points: userPoints,
                documents: documents.map(d => ({ name: d.name, type: d.type, date: d.date })),
                exportDate: new Date()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'idonet_informe.json';
            a.click();
        }

        // ========== TEMPORIZADOR ENFOQUE ==========
        let focusTime = 25 * 60;
        let focusInterval = null;
        let focusRunning = false;
        let focusMode = 'pomodoro';
        const focusDisplay = document.getElementById('focusTimerDisplay');
        const focusCircle = document.getElementById('timerCircle');
        const modeLabel = document.getElementById('timerModeLabel');
        const toggleBtnFocus = document.getElementById('focusToggleBtn');

        function updateFocusTimerDisplay() {
            let m = Math.floor(focusTime / 60);
            let s = focusTime % 60;
            focusDisplay.innerText = `${m}:${s < 10 ? '0'+s : s}`;
            let total = focusMode === 'pomodoro' ? 25*60 : 45*60;
            let offset = 283 * (1 - focusTime / total);
            focusCircle.setAttribute('stroke-dashoffset', offset);
        }
        function toggleFocusTimer() {
            if (focusRunning) {
                clearInterval(focusInterval);
                focusRunning = false;
                toggleBtnFocus.innerHTML = '<i class="fas fa-play"></i> Reanudar';
            } else {
                focusInterval = setInterval(() => {
                    if (focusTime > 0) {
                        focusTime--;
                        updateFocusTimerDisplay();
                    } else {
                        clearInterval(focusInterval);
                        focusRunning = false;
                        addPoints(80);
                        alert('Sesi√≥n completada +80 IdoPoints');
                        resetFocusTimer();
                    }
                }, 1000);
                focusRunning = true;
                toggleBtnFocus.innerHTML = '<i class="fas fa-pause"></i> Pausar';
            }
        }
        function resetFocusTimer() {
            clearInterval(focusInterval);
            focusRunning = false;
            if (focusMode === 'pomodoro') focusTime = 25*60;
            else focusTime = 45*60;
            updateFocusTimerDisplay();
            toggleBtnFocus.innerHTML = '<i class="fas fa-play"></i> Iniciar';
        }
        function setPomodoro() {
            focusMode = 'pomodoro';
            focusTime = 25*60;
            modeLabel.innerText = 'Pomodoro';
            resetFocusTimer();
        }
        function setFlowtime() {
            focusMode = 'flowtime';
            focusTime = 45*60;
            modeLabel.innerText = 'Flowtime';
            resetFocusTimer();
        }

        // Inicializaci√≥n
        loadDocumentsFromStorage();
        updateFocusTimerDisplay();
    </script>
</body>
</html>
