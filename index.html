<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA DOCENTE INTEGRAL 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --mep-blue: #003366; --mep-red: #cc0000; --bg: #f8f9fa; --card: #ffffff; --text: #212529; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; }
        header { background: var(--mep-blue); color: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--mep-red); position: sticky; top: 0; z-index: 1000; }
        .container { padding: 15px; max-width: 1000px; margin: auto; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #e0e0e0; }
        
        /* NAVEGACI√ìN PRINCIPAL */
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #dee2e6; z-index: 2000; }
        .tab-item { background: none; border: none; font-size: 11px; color: #6c757d; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; flex: 1; }
        .tab-item.active { color: var(--mep-blue); font-weight: bold; }
        .tab-item i { font-size: 20px; }

        /* TABLAS E INPUTS */
        .table-responsive { overflow-x: auto; margin-top: 15px; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: center; font-size: 14px; }
        th { background: #e9ecef; color: var(--mep-blue); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; margin-top: 5px; font-size: 16px; }
        .btn { padding: 15px; border: none; border-radius: 10px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; transition: 0.3s; color: white; }
        .btn-mep { background: var(--mep-blue); }
        .btn-wa { background: #25d366; }
        .btn-pdf { background: #dc3545; }
        .btn-sec { background: #6c757d; }
    </style>
</head>
<body>

<header>
    <div id="inst-display" style="font-size: 10px; opacity: 0.9; text-transform: uppercase;">REGISTRO DOCENTE</div>
    <div id="active-title" style="font-weight: bold; font-size: 18px;">CONFIGURACI√ìN</div>
</header>

<div class="container" id="app-content"></div>

<nav class="tab-bar">
    <button class="tab-item active" onclick="navigate('config', this)">‚öôÔ∏è<span>Config</span></button>
    <button class="tab-item" onclick="navigate('lista', this)">üë•<span>Lista</span></button>
    <button class="tab-item" onclick="navigate('eval', this)">üìä<span>Eval</span></button>
    <button class="tab-item" onclick="navigate('dua', this)">üìñ<span>DUA</span></button>
    <button class="tab-item" onclick="navigate('reportes', this)">‚ûï<span>M√°s</span></button>
</nav>

<script>
// --- MOTOR DE DATOS (PROTECCI√ìN DE DATOS LOCAL) ---
let db;
let Config = { centro: "Liceo Bello Horizonte", tc: 45, pr: 20, ta: 10, py: 25, modalidad: "primaria" };

const DB_REQ = indexedDB.open("REGISTRO_MEP_FULL", 1);
DB_REQ.onupgradeneeded = e => {
    let d = e.target.result;
    d.createObjectStore("config", { keyPath: "id" });
    d.createObjectStore("estudiantes", { keyPath: "id", autoIncrement: true });
    d.createObjectStore("asistencia", { keyPath: "fecha" });
    d.createObjectStore("bitacora", { keyPath: "id", autoIncrement: true });
};
DB_REQ.onsuccess = e => { db = e.target.result; startup(); };

function startup() {
    db.transaction("config").objectStore("config").get("main").onsuccess = e => {
        if(e.target.result) Config = e.target.result;
        document.getElementById('inst-display').innerText = Config.centro;
        navigate('config', document.querySelector('.tab-item'));
    };
}

// --- NAVEGACI√ìN Y FUNCIONES ---
function navigate(view, el) {
    const main = document.getElementById('app-content');
    const title = document.getElementById('active-title');
    document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
    if(el) el.classList.add('active');
    title.innerText = view.toUpperCase();

    if(view === 'config') {
        main.innerHTML = `
            <div class="card">
                <h3>Instituci√≥n y Modalidad</h3>
                <input type="text" id="c-nom" value="${Config.centro}">
                <select id="c-mod">
                    <option value="pre" ${Config.modalidad==='pre'?'selected':''}>Preescolar (Cualitativo)</option>
                    <option value="primaria" ${Config.modalidad==='primaria'?'selected':''}>Primaria/Secundaria (Num√©rico)</option>
                </select>
                <h3>Ponderaciones (%)</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>Cotidiano: <input type="number" id="c-tc" value="${Config.tc}"></div>
                    <div>Pruebas: <input type="number" id="c-pr" value="${Config.pr}"></div>
                </div>
                <button class="btn btn-mep" onclick="saveConfig()">Guardar Configuraci√≥n</button>
            </div>`;
    }

    if(view === 'lista') {
        main.innerHTML = `
            <div class="card">
                <h3>Registro Estudiantil</h3>
                <input type="text" id="s-nom" placeholder="Nombre completo">
                <input type="number" id="s-tel" placeholder="WhatsApp Encargado">
                <select id="s-acs"><option value="no">Sin Adecuaci√≥n</option><option value="si">Con ACS (50/50)</option></select>
                <button class="btn btn-mep" onclick="addS()">Registrar Estudiante</button>
            </div>
            <div id="student-render"></div>`;
        renderStudents();
    }

    if(view === 'eval') {
        main.innerHTML = `
            <div class="card">
                <h3>Registro de Calificaciones</h3>
                <div class="table-responsive">
                    <table id="table-eval">
                        <tr><th>Estudiante</th><th>Cot %</th><th>Pru %</th><th>Nota</th></tr>
                    </table>
                </div>
            </div>`;
        renderEval();
    }

    if(view === 'dua') {
        main.innerHTML = `
            <div class="card">
                <h3>Bit√°cora de Estrategias DUA</h3>
                <input type="date" id="b-fecha" value="${new Date().toISOString().split('T')[0]}">
                <input type="text" id="b-tema" placeholder="Tema de la lecci√≥n">
                <textarea id="b-ajuste" placeholder="Ajustes realizados para estudiantes con adecuaci√≥n..."></textarea>
                <button class="btn btn-mep" onclick="saveBit()">Guardar en Bit√°cora</button>
            </div>
            <div id="bit-render"></div>`;
        renderBit();
    }

    if(view === 'reportes') {
        main.innerHTML = `
            <div class="card">
                <h3>Control de Asistencia</h3>
                <button class="btn btn-sec" onclick="alert('Cargando Lista de Asistencia...')">üìÖ Tomar Asistencia Hoy</button>
                <hr>
                <h3>Reportes y Documentaci√≥n</h3>
                <button class="btn btn-pdf" onclick="genPDF()">üìë Generar Informe de Traslado (PDF)</button>
                <button class="btn btn-wa" onclick="sendWA()">üö® Notificar Promedios Bajos (WA)</button>
                <button class="btn btn-sec" onclick="exportCSV()">üì§ Exportar Lista a Excel</button>
            </div>`;
    }
}

// --- FUNCIONES DE PERSISTENCIA ---
function saveConfig() {
    Config.centro = document.getElementById('c-nom').value;
    Config.modalidad = document.getElementById('c-mod').value;
    Config.tc = parseInt(document.getElementById('c-tc').value);
    Config.pr = parseInt(document.getElementById('c-pr').value);
    db.transaction("config","readwrite").objectStore("config").put({...Config, id:"main"});
    alert("Configuraci√≥n Exitosa");
    location.reload();
}

function addS() {
    const n = document.getElementById('s-nom').value;
    const t = document.getElementById('s-tel').value;
    const a = document.getElementById('s-acs').value;
    if(!n) return;
    const tx = db.transaction("estudiantes","readwrite");
    tx.objectStore("estudiantes").add({nombre:n, tel:t, acs:a, tc:0, pr:0});
    tx.oncomplete = () => navigate('lista');
}

function renderStudents() {
    const div = document.getElementById('student-render');
    let html = "";
    db.transaction("estudiantes").objectStore("estudiantes").getAll().onsuccess = e => {
        e.target.result.forEach(s => {
            html += `<div class="card" style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <span><b>${s.nombre}</b><br><small>Tel: ${s.tel}</small></span>
                <span style="font-size:10px; background:#eee; padding:5px; border-radius:5px;">${s.acs.toUpperCase()}</span>
            </div>`;
        });
        div.innerHTML = html;
    };
}

function renderEval() {
    const table = document.getElementById('table-eval');
    db.transaction("estudiantes").objectStore("estudiantes").getAll().onsuccess = e => {
        e.target.result.forEach(s => {
            let n = ((s.tc * Config.tc/100) + (s.pr * Config.pr/100)).toFixed(1);
            let row = table.insertRow();
            row.innerHTML = `<td>${s.nombre}</td>
                <td><input type="number" value="${s.tc}" onchange="upd(${s.id},'tc',this.value)"></td>
                <td><input type="number" value="${s.pr}" onchange="upd(${s.id},'pr',this.value)"></td>
                <td style="color:${n<70?'red':'green'}"><b>${n}</b></td>`;
        });
    };
}

function upd(id, f, v) {
    const s = db.transaction("estudiantes","readwrite").objectStore("estudiantes");
    s.get(id).onsuccess = e => {
        let d = e.target.result;
        d[f] = parseFloat(v) || 0;
        s.put(d);
    };
}

function genPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text(`INFORME OFICIAL - ${Config.centro}`, 15, 15);
    db.transaction("estudiantes").objectStore("estudiantes").getAll().onsuccess = e => {
        const body = e.target.result.map(s => [s.nombre, s.acs, ((s.tc*Config.tc/100)+(s.pr*Config.pr/100)).toFixed(1)]);
        doc.autoTable({ head: [['Estudiante', 'ACS', 'Nota']], body: body, startY: 25 });
        doc.save("Reporte_Traslado.pdf");
    };
}

function saveBit() {
    const f = document.getElementById('b-fecha').value;
    const t = document.getElementById('b-tema').value;
    const a = document.getElementById('b-ajuste').value;
    db.transaction("bitacora","readwrite").objectStore("bitacora").add({fecha:f, tema:t, ajuste:a});
    navigate('dua');
}

function renderBit() {
    const div = document.getElementById('bit-render');
    let html = "";
    db.transaction("bitacora").objectStore("bitacora").openCursor(null, 'prev').onsuccess = e => {
        const c = e.target.result;
        if(c) {
            html += `<div class="card" style="border-left:5px solid var(--mep-blue)">
                <b>${c.value.fecha} - ${c.value.tema}</b><p style="font-size:13px">${c.value.ajuste}</p>
            </div>`;
            c.continue();
        } else { div.innerHTML = html; }
    };
}
</script>
</body>
</html>
