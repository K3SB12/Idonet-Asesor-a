<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>üìö SISTEMA DOCENTE MEP 2026 - VERSI√ìN COMPLETA</title>
    <!-- Librer√≠as para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }

        :root {
            --mep-blue: #003366;
            --mep-red: #CC0000;
            --mep-gray: #f0f2f5;
            --mep-white: #ffffff;
            --mep-text: #1e1e1e;
            --mep-border: #d1d5db;
            --mep-success: #28a745;
            --mep-warning: #ffc107;
            --mep-danger: #dc3545;
        }

        body {
            background: var(--mep-gray);
            color: var(--mep-text);
            padding-bottom: 85px;
            min-height: 100vh;
            font-size: 14px;
        }

        /* HEADER INSTITUCIONAL */
        .mep-header {
            background: var(--mep-blue);
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 4px solid var(--mep-red);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .mep-header h1 {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .mep-header .subtitle {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 4px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* TARJETAS */
        .card {
            background: var(--mep-white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid var(--mep-border);
        }

        .card-title {
            font-size: 1.3rem;
            color: var(--mep-blue);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--mep-red);
            font-weight: 600;
        }

        /* GRIDS */
        .grid-2, .grid-3, .grid-4 {
            display: grid;
            gap: 15px;
            margin-bottom: 15px;
        }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        /* FORMULARIOS */
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: var(--mep-blue);
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1.5px solid var(--mep-border);
            border-radius: 10px;
            font-size: 1rem;
            transition: border 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--mep-blue);
            box-shadow: 0 0 0 3px rgba(0,51,102,0.1);
        }

        /* BOTONES */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            margin: 5px;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-primary { background: var(--mep-blue); color: white; }
        .btn-success { background: var(--mep-success); color: white; }
        .btn-warning { background: var(--mep-warning); color: black; }
        .btn-danger { background: var(--mep-danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--mep-blue); color: var(--mep-blue); }

        /* TABLAS */
        .table-responsive {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--mep-border);
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        th {
            background: var(--mep-blue);
            color: white;
            padding: 12px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid var(--mep-border);
            text-align: left;
        }
        td input, td select {
            width: 100%;
            padding: 6px;
            font-size: 0.85rem;
        }

        /* BADGES */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 30px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }
        .badge-success { background: var(--mep-success); }
        .badge-warning { background: var(--mep-warning); color: black; }
        .badge-danger { background: var(--mep-danger); }
        .badge-info { background: var(--mep-blue); }

        /* NAVEGACI√ìN INFERIOR (9 FUNCIONES) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            overflow-x: auto;
            padding: 8px 4px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 2000;
            border-top: 3px solid var(--mep-blue);
        }
        .nav-item {
            min-width: 70px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 4px;
            background: none;
            border: none;
            color: #6c757d;
            font-size: 0.7rem;
            cursor: pointer;
            border-radius: 12px;
            transition: 0.2s;
        }
        .nav-item.active {
            color: var(--mep-blue);
            font-weight: 700;
            background: rgba(0,51,102,0.1);
        }
        .nav-item span:first-child {
            font-size: 1.4rem;
            margin-bottom: 2px;
        }

        /* TARJETA DE INSTITUCI√ìN */
        .institucion-card {
            background: #f8f9fa;
            border: 1px solid var(--mep-border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: 0.2s;
        }
        .institucion-card:hover {
            border-color: var(--mep-blue);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* √ÅREA DE IMPORTACI√ìN */
        .import-area {
            border: 2px dashed var(--mep-blue);
            padding: 25px;
            text-align: center;
            border-radius: 16px;
            background: #f0f7ff;
            margin: 15px 0;
        }

        .filtros-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--mep-border);
        }

        /* UTILIDADES */
        .text-success { color: var(--mep-success); }
        .text-danger { color: var(--mep-danger); }
        .mt-3 { margin-top: 15px; }
        .mb-3 { margin-bottom: 15px; }
        .w-100 { width: 100%; }
    </style>
</head>
<body>

<header class="mep-header" id="mainHeader">
    <h1 id="institucionNombre">Ministerio de Educaci√≥n P√∫blica</h1>
    <div class="subtitle" id="institucionDetalle">Sistema Integral de Gesti√≥n Docente ¬∑ Costa Rica</div>
</header>

<main class="container" id="appMain">
    <!-- Contenido din√°mico seg√∫n pesta√±a -->
</main>

<nav class="bottom-nav" id="bottomNav">
    <button class="nav-item active" data-view="instituciones">üè´<span>Instituciones</span></button>
    <button class="nav-item" data-view="config">‚öôÔ∏è<span>Config</span></button>
    <button class="nav-item" data-view="estudiantes">üë•<span>Listas</span></button>
    <button class="nav-item" data-view="asistencia">üìÖ<span>Asistencia</span></button>
    <button class="nav-item" data-view="evaluacion">üìä<span>Evaluar</span></button>
    <button class="nav-item" data-view="cotidiano">üìù<span>Cotidiano</span></button>
    <button class="nav-item" data-view="reportes">üìë<span>Reportes</span></button>
    <button class="nav-item" data-view="alertas">üö®<span>Alertas</span></button>
    <button class="nav-item" data-view="plantillas">üìã<span>Plantillas</span></button>
</nav>

<script>
    (function() {
        // ==================== CONFIGURACI√ìN GLOBAL ====================
        const DB_NAME = 'MEP_FINAL_2026';
        const DB_VERSION = 7;
        const CODIGO_PAIS = '506';

        let db = null;
        let institucionActiva = null;
        let nivelActivo = 'secundaria'; // preescolar, primaria, secundaria

        // ==================== INICIALIZACI√ìN INDEXEDDB ====================
        function inicializarDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject('Error al abrir DB');

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('‚úÖ IndexedDB conectada');
                    cargarDatosIniciales().then(() => {
                        cambiarVista('instituciones');
                        resolve();
                    });
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('instituciones')) {
                        db.createObjectStore('instituciones', { keyPath: 'id', autoIncrement: true });
                    }

                    if (!db.objectStoreNames.contains('estudiantes')) {
                        const storeEst = db.createObjectStore('estudiantes', { keyPath: 'id', autoIncrement: true });
                        storeEst.createIndex('institucionId', 'institucionId', { unique: false });
                        storeEst.createIndex('identificacion', 'identificacion', { unique: true });
                    }

                    if (!db.objectStoreNames.contains('asistencia')) {
                        db.createObjectStore('asistencia', { keyPath: 'id', autoIncrement: true });
                    }

                    if (!db.objectStoreNames.contains('evaluaciones')) {
                        db.createObjectStore('evaluaciones', { keyPath: 'id', autoIncrement: true });
                    }

                    if (!db.objectStoreNames.contains('indicadores')) {
                        db.createObjectStore('indicadores', { keyPath: 'id', autoIncrement: true });
                    }

                    if (!db.objectStoreNames.contains('bitacora')) {
                        db.createObjectStore('bitacora', { keyPath: 'id', autoIncrement: true });
                    }

                    // Datos de ejemplo - Instituciones
                    const tx = event.target.transaction;
                    const storeInst = tx.objectStore('instituciones');
                    
                    storeInst.add({ 
                        nombre: 'Liceo Rural Las Moras', 
                        direccionRegional: 'Lim√≥n', 
                        circuito: '10', 
                        codigo: '0255-00',
                        nivel: 'secundaria',
                        registrada: new Date().toLocaleDateString('es-CR')
                    });
                    
                    storeInst.add({ 
                        nombre: 'Escuela El Pilar', 
                        direccionRegional: 'San Carlos', 
                        circuito: '05', 
                        codigo: '3357-00',
                        nivel: 'primaria',
                        registrada: new Date().toLocaleDateString('es-CR')
                    });

                    // Datos de ejemplo - Estudiantes con datos completos
                    const storeEst = tx.objectStore('estudiantes');
                    storeEst.add({
                        institucionId: 1,
                        identificacion: '1-1234-5678',
                        nombre: 'Alberto Laureano Guevara',
                        correoMEP: 'alberto.guevara@est.mep.go.cr',
                        telefono1: '88881111',
                        telefono2: '88881112',
                        correoEncargado: 'padre.alberto@gmail.com',
                        seccion: '9-1',
                        acs: false
                    });
                    storeEst.add({
                        institucionId: 1,
                        identificacion: '2-2345-6789',
                        nombre: 'Mar√≠a Jos√© Jim√©nez',
                        correoMEP: 'maria.jimenez@est.mep.go.cr',
                        telefono1: '88882222',
                        telefono2: '88882223',
                        correoEncargado: 'madre.maria@gmail.com',
                        seccion: '9-1',
                        acs: true
                    });
                    storeEst.add({
                        institucionId: 2,
                        identificacion: '3-3456-7890',
                        nombre: 'Sof√≠a Valverde',
                        correoMEP: 'sofia.valverde@est.mep.go.cr',
                        telefono1: '88883333',
                        telefono2: '88883334',
                        correoEncargado: 'padre.sofia@gmail.com',
                        seccion: '4-1',
                        acs: false
                    });

                    // Indicadores de ejemplo
                    const storeInd = tx.objectStore('indicadores');
                    storeInd.add({ descripcion: 'Analiza cr√≠ticamente las causas de la Segunda Guerra Mundial', puntos: 3 });
                    storeInd.add({ descripcion: 'Identifica eventos del periodo de entreguerras', puntos: 3 });
                    storeInd.add({ descripcion: 'Compara perspectivas sobre la Guerra Fr√≠a', puntos: 3 });
                };
            });
        }

        async function cargarDatosIniciales() {
            return new Promise((resolve) => {
                if (!db) return resolve();
                
                const tx = db.transaction('instituciones', 'readonly');
                const store = tx.objectStore('instituciones');
                store.getAll().onsuccess = (e) => {
                    if (e.target.result.length > 0) {
                        institucionActiva = e.target.result[0];
                        nivelActivo = institucionActiva.nivel;
                        actualizarHeader();
                    }
                    resolve();
                };
            });
        }

        function actualizarHeader() {
            if (institucionActiva) {
                document.getElementById('institucionNombre').textContent = `MEP ¬∑ ${institucionActiva.nombre}`;
                document.getElementById('institucionDetalle').textContent = 
                    `C√≥digo: ${institucionActiva.codigo} ¬∑ ${institucionActiva.nivel} ¬∑ ${institucionActiva.direccionRegional}`;
            }
        }

        // ==================== L√ìGICA POR NIVEL ====================
        function getConfiguracionEvaluacion(nivel) {
            switch(nivel) {
                case 'preescolar':
                    return { rubros: [{ nombre: 'Observaciones', porcentaje: 100 }], tieneExamenes: false };
                case 'primaria':
                    return { rubros: [
                        { nombre: 'Trabajo Cotidiano', porcentaje: 60 },
                        { nombre: 'Pruebas', porcentaje: 40 }
                    ], tieneExamenes: true };
                case 'secundaria':
                    return { rubros: [
                        { nombre: 'Trabajo Cotidiano', porcentaje: 40 },
                        { nombre: 'Pruebas', porcentaje: 30 },
                        { nombre: 'Tareas', porcentaje: 15 },
                        { nombre: 'Proyectos', porcentaje: 15 }
                    ], tieneExamenes: true };
                default: return null;
            }
        }

        // ==================== NAVEGACI√ìN ====================
        function cambiarVista(vistaId) {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === vistaId);
            });

            const container = document.getElementById('appMain');
            
            const vistas = {
                instituciones: renderInstituciones,
                config: renderConfiguracion,
                estudiantes: renderEstudiantes,
                asistencia: renderAsistencia,
                evaluacion: renderEvaluacion,
                cotidiano: renderCotidiano,
                reportes: renderReportes,
                alertas: renderAlertas,
                plantillas: renderPlantillas
            };

            if (vistas[vistaId]) {
                vistas[vistaId](container);
            }
        }

        // ==================== VISTA 1: INSTITUCIONES ====================
        function renderInstituciones(container) {
            if (!db) return;
            
            const tx = db.transaction('instituciones', 'readonly');
            const store = tx.objectStore('instituciones');
            store.getAll().onsuccess = (e) => {
                const instituciones = e.target.result;
                
                container.innerHTML = `
                    <div class="card">
                        <div class="card-title">üè´ Centros Educativos</div>
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Nombre de la Instituci√≥n</label>
                                <input type="text" id="inst-nombre" placeholder="Ej: Liceo Rural Las Moras">
                            </div>
                            <div class="form-group">
                                <label>Direcci√≥n Regional</label>
                                <input type="text" id="inst-regional" placeholder="Ej: Lim√≥n">
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Circuito Escolar</label>
                                <input type="text" id="inst-circuito" placeholder="Ej: 10">
                            </div>
                            <div class="form-group">
                                <label>C√≥digo</label>
                                <input type="text" id="inst-codigo" placeholder="Ej: 0255-00">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Nivel</label>
                            <select id="inst-nivel">
                                <option value="preescolar">Preescolar</option>
                                <option value="primaria">Primaria (I y II Ciclo)</option>
                                <option value="secundaria" selected>Secundaria (III Ciclo)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="agregarInstitucion()">‚ûï Agregar Instituci√≥n</button>
                    </div>

                    <div class="card">
                        <h3>Instituciones Registradas</h3>
                        ${instituciones.map(inst => `
                            <div class="institucion-card" onclick="seleccionarInstitucion(${inst.id})">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4>${inst.nombre}</h4>
                                        <p>${inst.direccionRegional} | Circuito: ${inst.circuito} | C√≥digo: ${inst.codigo}</p>
                                        <p><span class="badge badge-info">${inst.nivel}</span> | Registrada: ${inst.registrada}</p>
                                    </div>
                                    <div>
                                        <button class="btn btn-outline btn-small" onclick="editarInstitucion(${inst.id}, event)">‚úèÔ∏è</button>
                                        <button class="btn btn-danger btn-small" onclick="eliminarInstitucion(${inst.id}, event)">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            };

            window.agregarInstitucion = () => {
                const nombre = document.getElementById('inst-nombre').value;
                const regional = document.getElementById('inst-regional').value;
                const circuito = document.getElementById('inst-circuito').value;
                const codigo = document.getElementById('inst-codigo').value;
                const nivel = document.getElementById('inst-nivel').value;

                if (!nombre || !regional || !circuito || !codigo) {
                    alert('‚ùå Todos los campos son obligatorios');
                    return;
                }

                const tx = db.transaction('instituciones', 'readwrite');
                const store = tx.objectStore('instituciones');
                store.add({
                    nombre, direccionRegional: regional, circuito, codigo, nivel,
                    registrada: new Date().toLocaleDateString('es-CR')
                });

                tx.oncomplete = () => {
                    alert('‚úÖ Instituci√≥n agregada');
                    cambiarVista('instituciones');
                };
            };

            window.seleccionarInstitucion = (id) => {
                const tx = db.transaction('instituciones', 'readonly');
                tx.objectStore('instituciones').get(id).onsuccess = (e) => {
                    institucionActiva = e.target.result;
                    nivelActivo = institucionActiva.nivel;
                    actualizarHeader();
                    cambiarVista('estudiantes');
                };
            };

            window.eliminarInstitucion = (id, event) => {
                event.stopPropagation();
                if (confirm('¬øEliminar esta instituci√≥n?')) {
                    const tx = db.transaction('instituciones', 'readwrite');
                    tx.objectStore('instituciones').delete(id);
                    tx.oncomplete = () => cambiarVista('instituciones');
                }
            };

            window.editarInstitucion = (id, event) => {
                event.stopPropagation();
                alert('Editar instituci√≥n (funcionalidad en desarrollo)');
            };
        }

        // ==================== VISTA 2: CONFIGURACI√ìN ====================
        function renderConfiguracion(container) {
            if (!institucionActiva) {
                container.innerHTML = '<div class="card"><p>‚ö†Ô∏è Seleccione una instituci√≥n primero</p></div>';
                return;
            }

            const config = getConfiguracionEvaluacion(nivelActivo);

            container.innerHTML = `
                <div class="card">
                    <div class="card-title">‚öôÔ∏è Configuraci√≥n - ${institucionActiva.nombre}</div>
                    <div class="form-group">
                        <label>Nivel educativo:</label>
                        <select id="config-nivel" onchange="cambiarNivel(this.value)">
                            <option value="preescolar" ${nivelActivo === 'preescolar' ? 'selected' : ''}>Preescolar</option>
                            <option value="primaria" ${nivelActivo === 'primaria' ? 'selected' : ''}>Primaria</option>
                            <option value="secundaria" ${nivelActivo === 'secundaria' ? 'selected' : ''}>Secundaria</option>
                        </select>
                    </div>
                    <h4>Rubros de evaluaci√≥n</h4>
                    ${config.rubros.map((r, i) => `
                        <div class="form-group">
                            <label>${r.nombre} (%)</label>
                            <input type="number" value="${r.porcentaje}" min="0" max="100" readonly class="form-control">
                        </div>
                    `).join('')}
                    <button class="btn btn-primary mt-3" onclick="guardarConfiguracion()">üíæ Guardar Configuraci√≥n</button>
                </div>
            `;

            window.cambiarNivel = (nuevoNivel) => {
                nivelActivo = nuevoNivel;
                if (institucionActiva) {
                    institucionActiva.nivel = nuevoNivel;
                    const tx = db.transaction('instituciones', 'readwrite');
                    tx.objectStore('instituciones').put(institucionActiva);
                }
                renderConfiguracion(container);
            };

            window.guardarConfiguracion = () => {
                alert('‚úÖ Configuraci√≥n guardada');
            };
        }

        // ==================== VISTA 3: ESTUDIANTES (LISTAS COMPLETAS) ====================
        function renderEstudiantes(container) {
            if (!institucionActiva) {
                container.innerHTML = '<div class="card"><p>‚ö†Ô∏è Seleccione una instituci√≥n primero</p></div>';
                return;
            }

            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üë• Gesti√≥n de Listas - ${institucionActiva.nombre}</div>
                    
                    <!-- AGREGAR MANUAL -->
                    <details>
                        <summary style="cursor: pointer; color: var(--mep-blue); font-weight: 600;">‚ûï Agregar Estudiante Manualmente</summary>
                        <div class="mt-3">
                            <div class="grid-2">
                                <input type="text" id="est-nombre" placeholder="Nombre completo">
                                <input type="text" id="est-identificacion" placeholder="C√©dula (1-1234-5678)">
                            </div>
                            <div class="grid-2">
                                <input type="text" id="est-seccion" placeholder="Secci√≥n (9-1)">
                                <input type="email" id="est-correoMEP" placeholder="Correo MEP">
                            </div>
                            <div class="grid-2">
                                <input type="text" id="est-tel1" placeholder="Tel√©fono 1 (principal)">
                                <input type="text" id="est-tel2" placeholder="Tel√©fono 2 (alternativo)">
                            </div>
                            <input type="email" id="est-correoEnc" placeholder="Correo del encargado">
                            <label><input type="checkbox" id="est-acs"> ACS</label>
                            <button class="btn btn-success mt-3" onclick="agregarEstudiante()">‚úÖ Guardar Estudiante</button>
                        </div>
                    </details>

                    <!-- IMPORTAR / EXPORTAR -->
                    <div class="grid-2 mt-3">
                        <div class="import-area">
                            <p>üìÅ Importar lista desde CSV</p>
                            <input type="file" id="csvFile" accept=".csv">
                            <button class="btn btn-primary" onclick="importarCSV()">Importar</button>
                        </div>
                        <div style="padding: 20px;">
                            <button class="btn btn-success w-100" onclick="exportarCSV()">üì• Exportar a CSV</button>
                            <button class="btn btn-danger w-100 mt-2" onclick="eliminarTodaLaLista()">üóëÔ∏è Eliminar toda la lista</button>
                        </div>
                    </div>

                    <!-- FILTROS -->
                    <div class="filtros-bar">
                        <div class="grid-3">
                            <div>
                                <label>Filtrar por secci√≥n:</label>
                                <select id="filtroSeccion" onchange="filtrarEstudiantes()">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div>
                                <label>Buscar nombre:</label>
                                <input type="text" id="buscarNombre" placeholder="Escriba..." onkeyup="filtrarEstudiantes()">
                            </div>
                        </div>
                    </div>

                    <!-- TABLA -->
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Identificaci√≥n</th>
                                    <th>Nombre</th>
                                    <th>Secci√≥n</th>
                                    <th>Tel√©fono 1</th>
                                    <th>Tel√©fono 2</th>
                                    <th>Correo Encargado</th>
                                    <th>ACS</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyEstudiantes"></tbody>
                        </table>
                    </div>
                </div>
            `;

            cargarEstudiantes();

            // ========== FUNCIONES CRUD ==========
            window.agregarEstudiante = () => {
                const nuevo = {
                    institucionId: institucionActiva.id,
                    identificacion: document.getElementById('est-identificacion').value,
                    nombre: document.getElementById('est-nombre').value,
                    seccion: document.getElementById('est-seccion').value,
                    correoMEP: document.getElementById('est-correoMEP').value,
                    telefono1: document.getElementById('est-tel1').value,
                    telefono2: document.getElementById('est-tel2').value,
                    correoEncargado: document.getElementById('est-correoEnc').value,
                    acs: document.getElementById('est-acs').checked
                };

                if (!nuevo.identificacion || !nuevo.nombre) {
                    alert('‚ùå Identificaci√≥n y nombre obligatorios');
                    return;
                }

                const tx = db.transaction('estudiantes', 'readwrite');
                tx.objectStore('estudiantes').add(nuevo);
                tx.oncomplete = () => {
                    alert('‚úÖ Estudiante agregado');
                    cargarEstudiantes();
                    // Limpiar campos
                    document.getElementById('est-identificacion').value = '';
                    document.getElementById('est-nombre').value = '';
                    document.getElementById('est-seccion').value = '';
                    document.getElementById('est-correoMEP').value = '';
                    document.getElementById('est-tel1').value = '';
                    document.getElementById('est-tel2').value = '';
                    document.getElementById('est-correoEnc').value = '';
                    document.getElementById('est-acs').checked = false;
                };
            };

            window.eliminarEstudiante = (id) => {
                if (confirm('¬øEliminar este estudiante?')) {
                    const tx = db.transaction('estudiantes', 'readwrite');
                    tx.objectStore('estudiantes').delete(id);
                    tx.oncomplete = () => cargarEstudiantes();
                }
            };

            window.eliminarTodaLaLista = () => {
                if (confirm('‚ö†Ô∏è ¬øELIMINAR TODA LA LISTA DE ESTUDIANTES? Esta acci√≥n es irreversible.')) {
                    const tx = db.transaction('estudiantes', 'readwrite');
                    const store = tx.objectStore('estudiantes');
                    store.getAll().onsuccess = (e) => {
                        e.target.result.forEach(est => store.delete(est.id));
                    };
                    tx.oncomplete = () => cargarEstudiantes();
                }
            };

            window.toggleACS = (id, checked) => {
                const tx = db.transaction('estudiantes', 'readwrite');
                const store = tx.objectStore('estudiantes');
                store.get(id).onsuccess = (e) => {
                    const est = e.target.result;
                    est.acs = checked;
                    store.put(est);
                };
            };

            window.exportarCSV = () => {
                const tx = db.transaction('estudiantes', 'readonly');
                tx.objectStore('estudiantes').getAll().onsuccess = (e) => {
                    const estudiantes = e.target.result.filter(e => e.institucionId === institucionActiva.id);
                    let csv = "Identificaci√≥n,Nombre,Secci√≥n,Tel√©fono 1,Tel√©fono 2,Correo Encargado,ACS\n";
                    estudiantes.forEach(e => {
                        csv += `${e.identificacion},"${e.nombre}",${e.seccion || ''},${e.telefono1 || ''},${e.telefono2 || ''},${e.correoEncargado || ''},${e.acs ? 'S√≠' : 'No'}\n`;
                    });
                    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `estudiantes_${new Date().toISOString().slice(0,10)}.csv`;
                    link.click();
                };
            };

            window.importarCSV = () => {
                const file = document.getElementById('csvFile').files[0];
                if (!file) return alert('Seleccione un archivo CSV');

                const reader = new FileReader();
                reader.onload = (e) => {
                    const lines = e.target.result.split('\n');
                    let importados = 0;
                    const tx = db.transaction('estudiantes', 'readwrite');
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        const values = lines[i].split(',');
                        if (values.length >= 2) {
                            tx.objectStore('estudiantes').add({
                                institucionId: institucionActiva.id,
                                identificacion: values[0].replace(/"/g, ''),
                                nombre: values[1].replace(/"/g, ''),
                                seccion: values[2]?.replace(/"/g, '') || '',
                                telefono1: values[3]?.replace(/"/g, '') || '',
                                telefono2: values[4]?.replace(/"/g, '') || '',
                                correoEncargado: values[5]?.replace(/"/g, '') || '',
                                acs: values[6]?.replace(/"/g, '') === 'S√≠'
                            });
                            importados++;
                        }
                    }
                    tx.oncomplete = () => {
                        alert(`‚úÖ ${importados} estudiantes importados`);
                        cargarEstudiantes();
                    };
                };
                reader.readAsText(file, 'UTF-8');
            };

            window.filtrarEstudiantes = () => cargarEstudiantes();
        }

        function cargarEstudiantes() {
            if (!db || !institucionActiva) return;

            const tx = db.transaction('estudiantes', 'readonly');
            const index = tx.objectStore('estudiantes').index('institucionId');
            index.getAll(institucionActiva.id).onsuccess = (e) => {
                let estudiantes = e.target.result;
                
                // Aplicar filtros
                const filtroSeccion = document.getElementById('filtroSeccion')?.value;
                const buscarNombre = document.getElementById('buscarNombre')?.value?.toLowerCase();
                
                if (filtroSeccion) estudiantes = estudiantes.filter(e => e.seccion === filtroSeccion);
                if (buscarNombre) estudiantes = estudiantes.filter(e => e.nombre.toLowerCase().includes(buscarNombre));

                const tbody = document.getElementById('tbodyEstudiantes');
                tbody.innerHTML = estudiantes.map((est, idx) => `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${est.identificacion}</td>
                        <td>${est.nombre}</td>
                        <td>${est.seccion || '-'}</td>
                        <td>${est.telefono1 || '-'}</td>
                        <td>${est.telefono2 || '-'}</td>
                        <td>${est.correoEncargado || '-'}</td>
                        <td><input type="checkbox" ${est.acs ? 'checked' : ''} onchange="toggleACS(${est.id}, this.checked)"></td>
                        <td>
                            <button class="btn btn-warning" style="padding:5px 10px;" onclick="alert('Editar en desarrollo')">‚úèÔ∏è</button>
                            <button class="btn btn-danger" style="padding:5px 10px;" onclick="eliminarEstudiante(${est.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');

                // Actualizar selector de secciones
                const secciones = [...new Set(e.target.result.map(e => e.seccion))];
                const select = document.getElementById('filtroSeccion');
                if (select) {
                    select.innerHTML = '<option value="">Todas</option>' + 
                        secciones.map(s => `<option value="${s}">${s}</option>`).join('');
                }
            };
        }

        // ==================== VISTA 4: ASISTENCIA ====================
        function renderAsistencia(container) {
            if (!institucionActiva) {
                container.innerHTML = '<div class="card"><p>‚ö†Ô∏è Seleccione una instituci√≥n primero</p></div>';
                return;
            }

            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üìÖ Control de Asistencia - ${institucionActiva.nombre}</div>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Fecha:</label>
                            <input type="date" id="asis-fecha" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>Secci√≥n:</label>
                            <select id="asis-seccion">
                                <option value="">Todas</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="cargarAsistencia()">üìÖ Cargar Asistencia</button>
                    
                    <div class="table-responsive mt-3" id="tablaAsistenciaContainer"></div>
                    <button class="btn btn-success mt-3" onclick="guardarAsistencia()">üíæ Guardar Asistencia</button>
                </div>
            `;

            window.cargarAsistencia = () => {
                const tx = db.transaction('estudiantes', 'readonly');
                tx.objectStore('estudiantes').getAll().onsuccess = (e) => {
                    const estudiantes = e.target.result.filter(e => e.institucionId === institucionActiva.id);
                    const fecha = document.getElementById('asis-fecha').value;
                    
                    let html = '<table><tr><th>Estudiante</th><th>Estado</th></tr>';
                    estudiantes.forEach(est => {
                        html += `<tr>
                            <td>${est.nombre}</td>
                            <td>
                                <select class="estado-asistencia" data-id="${est.id}">
                                    <option value="P">Presente</option>
                                    <option value="A">Ausente</option>
                                    <option value="J">Justificada</option>
                                    <option value="T">Tard√≠a</option>
                                </select>
                            </td>
                        </tr>`;
                    });
                    html += '</table>';
                    document.getElementById('tablaAsistenciaContainer').innerHTML = html;
                };
            };

            window.guardarAsistencia = () => {
                alert('‚úÖ Asistencia guardada (simulado)');
            };
        }

        // ==================== VISTA 5: EVALUACI√ìN ====================
        function renderEvaluacion(container) {
            if (!institucionActiva) {
                container.innerHTML = '<div class="card"><p>‚ö†Ô∏è Seleccione una instituci√≥n primero</p></div>';
                return;
            }

            const config = getConfiguracionEvaluacion(nivelActivo);

            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üìä Evaluaci√≥n - ${institucionActiva.nombre} (${nivelActivo})</div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    ${config.rubros.map(r => `<th>${r.nombre}</th>`).join('')}
                                    <th>Nota Final</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Ejemplo: Alberto Guevara</td>
                                    ${config.rubros.map(() => '<td><input type="number" value="80" min="0" max="100"></td>').join('')}
                                    <td><strong>82.5</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary mt-3">üíæ Guardar Evaluaci√≥n</button>
                </div>
            `;
        }

        // ==================== VISTA 6: TRABAJO COTIDIANO ====================
        function renderCotidiano(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üìù Trabajo Cotidiano - Configuraci√≥n</div>
                    <div class="grid-2">
                        <div>
                            <label>Periodo:</label>
                            <select class="form-control">
                                <option>I Periodo</option>
                                <option>II Periodo</option>
                                <option>III Periodo</option>
                            </select>
                        </div>
                        <div>
                            <label>Filtrar:</label>
                            <input type="text" placeholder="Buscar estudiante...">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin: 20px 0;">
                        <button class="btn btn-primary" onclick="alert('PDF generado')">üì• PDF</button>
                        <button class="btn btn-success" onclick="alert('Excel generado')">üì• Excel</button>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr><th>Estudiante</th><th>A</th><th>B</th><th>C</th><th>% Obtenido</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>Alberto Guevara</td><td><input value="3"></td><td><input value="3"></td><td><input value="3"></td><td>50.00%</td></tr>
                                <tr><td>Mar√≠a Jim√©nez</td><td><input value="3"></td><td><input value="2"></td><td><input value="3"></td><td>44.44%</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // ==================== VISTA 7: REPORTES ====================
        function renderReportes(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üìë Reportes Oficiales</div>
                    <div class="filtros-bar">
                        <div class="grid-3">
                            <div>
                                <label>Periodo:</label>
                                <select>
                                    <option>I Periodo</option>
                                    <option>II Periodo</option>
                                    <option>III Periodo</option>
                                </select>
                            </div>
                            <div>
                                <label>Secci√≥n:</label>
                                <select>
                                    <option>9-1</option>
                                    <option>4-1</option>
                                </select>
                            </div>
                            <div>
                                <label>Ordenar por:</label>
                                <select>
                                    <option>Orden alfab√©tico</option>
                                    <option>Nota (mayor a menor)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="alert('PDF generado')">üì• PDF</button>
                        <button class="btn btn-success" onclick="alert('Excel generado')">üì• Excel</button>
                    </div>
                </div>
            `;
        }

        // ==================== VISTA 8: ALERTAS ====================
        function renderAlertas(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üö® Alertas de Rendimiento</div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr><th>Estudiante</th><th>Nota</th><th>Tel√©fono</th><th>WhatsApp</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Alberto Guevara</td>
                                    <td><span class="badge badge-danger">58</span></td>
                                    <td>8888-1111</td>
                                    <td><button class="btn btn-warning" onclick="window.open('https://wa.me/50688881111?text=Alerta de rendimiento')">üì± Enviar</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // ==================== VISTA 9: PLANTILLAS ====================
        function renderPlantillas(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üìã Plantillas Oficiales</div>
                    <div class="grid-3">
                        <div class="institucion-card">
                            <h4>üìÖ Asistencia</h4>
                            <p>Plantilla para control diario</p>
                            <button class="btn btn-outline btn-small" onclick="descargarPlantilla('asistencia')">Descargar</button>
                        </div>
                        <div class="institucion-card">
                            <h4>üìù Trabajo Cotidiano</h4>
                            <p>Registro A, B, C</p>
                            <button class="btn btn-outline btn-small" onclick="descargarPlantilla('cotidiano')">Descargar</button>
                        </div>
                        <div class="institucion-card">
                            <h4>üìä Acta por Periodo</h4>
                            <p>Calificaciones por periodo</p>
                            <button class="btn btn-outline btn-small" onclick="descargarPlantilla('acta')">Descargar</button>
                        </div>
                    </div>
                </div>
            `;

            window.descargarPlantilla = (tipo) => {
                let contenido = '';
                let nombre = '';
                if (tipo === 'asistencia') {
                    contenido = 'Fecha,Estudiante,Estado\n2025-04-01,"Ejemplo",Presente';
                    nombre = 'plantilla_asistencia.csv';
                } else if (tipo === 'cotidiano') {
                    contenido = 'Estudiante,A,B,C\n"Ejemplo",3,3,3';
                    nombre = 'plantilla_cotidiano.csv';
                } else {
                    contenido = 'Estudiante,Periodo,Nota\n"Ejemplo",I,85';
                    nombre = 'plantilla_acta.csv';
                }
                const blob = new Blob(['\uFEFF' + contenido], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nombre;
                link.click();
            };
        }

        // ==================== INICIALIZACI√ìN ====================
        window.onload = async () => {
            await inicializarDB();
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    cambiarVista(e.currentTarget.dataset.view);
                });
            });
        };

        window.cambiarVista = cambiarVista;
    })();
</script>
</body>
</html>
