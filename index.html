<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>üìö SISTEMA DOCENTE MEP 2026 - VERSI√ìN 100% COMPLETA</title>
    <!-- Librer√≠as -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }

        :root {
            --mep-blue: #003366;
            --mep-red: #CC0000;
            --mep-gray: #f0f2f5;
            --mep-white: #ffffff;
            --mep-text: #1e1e1e;
            --mep-border: #d1d5db;
            --mep-success: #28a745;
            --mep-warning: #ffc107;
            --mep-danger: #dc3545;
        }

        body {
            background: var(--mep-gray);
            color: var(--mep-text);
            padding-bottom: 90px;
            min-height: 100vh;
            font-size: 14px;
        }

        .mep-header {
            background: var(--mep-blue);
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 4px solid var(--mep-red);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .mep-header h1 {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .mep-header .subtitle {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 4px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: var(--mep-white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid var(--mep-border);
        }

        .card-title {
            font-size: 1.3rem;
            color: var(--mep-blue);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--mep-red);
            font-weight: 600;
        }

        .grid-2, .grid-3, .grid-4 {
            display: grid;
            gap: 15px;
            margin-bottom: 15px;
        }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: var(--mep-blue);
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1.5px solid var(--mep-border);
            border-radius: 10px;
            font-size: 1rem;
            transition: border 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--mep-blue);
            box-shadow: 0 0 0 3px rgba(0,51,102,0.1);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            margin: 5px;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-primary { background: var(--mep-blue); color: white; }
        .btn-success { background: var(--mep-success); color: white; }
        .btn-warning { background: var(--mep-warning); color: black; }
        .btn-danger { background: var(--mep-danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--mep-blue); color: var(--mep-blue); }

        .table-responsive {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--mep-border);
            margin: 15px 0;
            max-height: 500px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        th {
            background: var(--mep-blue);
            color: white;
            padding: 12px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid var(--mep-border);
            text-align: left;
        }
        td input, td select {
            width: 100%;
            padding: 6px;
            font-size: 0.85rem;
            border: 1px solid var(--mep-border);
            border-radius: 4px;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 30px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }
        .badge-success { background: var(--mep-success); }
        .badge-warning { background: var(--mep-warning); color: black; }
        .badge-danger { background: var(--mep-danger); }
        .badge-info { background: var(--mep-blue); }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            overflow-x: auto;
            padding: 8px 4px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 2000;
            border-top: 3px solid var(--mep-blue);
        }
        .nav-item {
            min-width: 70px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 4px;
            background: none;
            border: none;
            color: #6c757d;
            font-size: 0.7rem;
            cursor: pointer;
            border-radius: 12px;
            transition: 0.2s;
        }
        .nav-item.active {
            color: var(--mep-blue);
            font-weight: 700;
            background: rgba(0,51,102,0.1);
        }
        .nav-item span:first-child {
            font-size: 1.4rem;
            margin-bottom: 2px;
        }

        .institucion-card {
            background: #f8f9fa;
            border: 1px solid var(--mep-border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: 0.2s;
        }
        .institucion-card:hover {
            border-color: var(--mep-blue);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .indicador-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--mep-blue);
        }

        .filtros-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--mep-border);
        }

        .estado-select {
            padding: 6px;
            border-radius: 6px;
            border: 1px solid var(--mep-border);
            width: 100%;
        }

        .text-success { color: var(--mep-success); }
        .text-danger { color: var(--mep-danger); }
        .mt-3 { margin-top: 15px; }
        .mb-3 { margin-bottom: 15px; }
        .w-100 { width: 100%; }
    </style>
</head>
<body>

<header class="mep-header" id="mainHeader">
    <h1 id="institucionNombre">Ministerio de Educaci√≥n P√∫blica</h1>
    <div class="subtitle" id="institucionDetalle">Sistema Integral de Gesti√≥n Docente ¬∑ Costa Rica</div>
</header>

<main class="container" id="appMain">
    <!-- Contenido din√°mico seg√∫n pesta√±a -->
</main>

<nav class="bottom-nav" id="bottomNav">
    <button class="nav-item" data-view="instituciones">üè´<span>Instituciones</span></button>
    <button class="nav-item" data-view="estudiantes">üë•<span>Estudiantes</span></button>
    <button class="nav-item" data-view="asistencia">üìÖ<span>Asistencia</span></button>
    <button class="nav-item" data-view="nuevaAsistencia">‚ûï<span>Nueva Asist.</span></button>
    <button class="nav-item" data-view="reporteAsistencia">üìä<span>Reporte Asist.</span></button>
    <button class="nav-item" data-view="cotidiano">üìù<span>Cotidiano</span></button>
    <button class="nav-item" data-view="indicadores">üîß<span>Indicadores</span></button>
    <button class="nav-item" data-view="evaluacion">üìã<span>Evaluaci√≥n</span></button>
    <button class="nav-item" data-view="alertas">üö®<span>Alertas</span></button>
</nav>

<script>
    (function() {
        // ==================== CONFIGURACI√ìN GLOBAL ====================
        const DB_NAME = 'MEP_FINAL_2026';
        const DB_VERSION = 10;
        const CODIGO_PAIS = '506';

        let db = null;
        let institucionActiva = null;
        let nivelActivo = 'secundaria';

        // ==================== INICIALIZACI√ìN INDEXEDDB ====================
        function inicializarDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject('Error al abrir DB');

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('‚úÖ IndexedDB conectada');
                    cargarDatosIniciales().then(() => {
                        cambiarVista('instituciones');
                        resolve();
                    });
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    // Stores principales
                    if (!db.objectStoreNames.contains('instituciones')) {
                        db.createObjectStore('instituciones', { keyPath: 'id', autoIncrement: true });
                    }

                    if (!db.objectStoreNames.contains('estudiantes')) {
                        const storeEst = db.createObjectStore('estudiantes', { keyPath: 'id', autoIncrement: true });
                        storeEst.createIndex('institucionId', 'institucionId', { unique: false });
                        storeEst.createIndex('seccion', 'seccion', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('indicadores')) {
                        const storeInd = db.createObjectStore('indicadores', { keyPath: 'id', autoIncrement: true });
                        storeInd.createIndex('institucionId', 'institucionId', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('asistencia')) {
                        const storeAsis = db.createObjectStore('asistencia', { keyPath: 'id', autoIncrement: true });
                        storeAsis.createIndex('fecha', 'fecha', { unique: false });
                        storeAsis.createIndex('estudianteId', 'estudianteId', { unique: false });
                        storeAsis.createIndex('institucionId', 'institucionId', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('evaluacionesCotidiano')) {
                        const storeEval = db.createObjectStore('evaluacionesCotidiano', { keyPath: 'id', autoIncrement: true });
                        storeEval.createIndex('estudianteId', 'estudianteId', { unique: false });
                        storeEval.createIndex('periodo', 'periodo', { unique: false });
                        storeEval.createIndex('institucionId', 'institucionId', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('evaluacionesGenerales')) {
                        const storeEvalG = db.createObjectStore('evaluacionesGenerales', { keyPath: 'id', autoIncrement: true });
                        storeEvalG.createIndex('estudianteId', 'estudianteId', { unique: false });
                        storeEvalG.createIndex('periodo', 'periodo', { unique: false });
                    }

                    // DATOS DE EJEMPLO
                    const tx = event.target.transaction;
                    
                    // Instituci√≥n
                    const storeInst = tx.objectStore('instituciones');
                    const instId = 1;
                    storeInst.add({ 
                        id: instId,
                        nombre: 'Liceo Rural Las Moras', 
                        direccionRegional: 'Lim√≥n', 
                        circuito: '10', 
                        codigo: '0255-00',
                        nivel: 'secundaria',
                        registrada: new Date().toLocaleDateString('es-CR')
                    });

                    // Estudiantes
                    const storeEst = tx.objectStore('estudiantes');
                    const estudiantes = [
                        { id: 1, institucionId: 1, identificacion: '1-1234-5678', nombre: 'Alberto Laureano Guevara', seccion: '9-1', telefono1: '88881111', telefono2: '88881112', correoEncargado: 'padre1@gmail.com', acs: false },
                        { id: 2, institucionId: 1, identificacion: '2-2345-6789', nombre: 'Amalia Gil Longoria', seccion: '9-1', telefono1: '88882222', telefono2: '88882223', correoEncargado: 'madre2@gmail.com', acs: false },
                        { id: 3, institucionId: 1, identificacion: '3-3456-7890', nombre: 'Enrique Yuridia Jaramillo Becerra', seccion: '9-1', telefono1: '88883333', telefono2: '88883334', correoEncargado: 'padre3@gmail.com', acs: false },
                        { id: 4, institucionId: 1, identificacion: '4-4567-8901', nombre: 'Jos Gaona', seccion: '9-1', telefono1: '88884444', telefono2: '88884445', correoEncargado: 'padre4@gmail.com', acs: false },
                        { id: 5, institucionId: 1, identificacion: '5-5678-9012', nombre: 'Juan P√©rez Ledezma', seccion: '9-1', telefono1: '88885555', telefono2: '88885556', correoEncargado: 'padre5@gmail.com', acs: false },
                        { id: 6, institucionId: 1, identificacion: '6-6789-0123', nombre: 'Leonardo Reynoso', seccion: '9-1', telefono1: '88886666', telefono2: '88886667', correoEncargado: 'padre6@gmail.com', acs: false },
                        { id: 7, institucionId: 1, identificacion: '7-7890-1234', nombre: 'Luisa Jacinto Ledesma', seccion: '9-1', telefono1: '88887777', telefono2: '88887778', correoEncargado: 'padre7@gmail.com', acs: false }
                    ];
                    estudiantes.forEach(e => storeEst.add(e));

                    // Indicadores
                    const storeInd = tx.objectStore('indicadores');
                    const indicadores = [
                        { id: 1, institucionId: 1, letra: 'A', descripcion: 'Analiza cr√≠ticamente las causas y consecuencias de la Segunda Guerra Mundial mediante el uso de recursos gr√°ficos e hist√≥ricos.', puntos: 3, fechaEvaluacion: '2025-04-03' },
                        { id: 2, institucionId: 1, letra: 'B', descripcion: 'Identifica los principales eventos del periodo de entreguerras y su impacto en Am√©rica Latina.', puntos: 3, fechaEvaluacion: '2025-04-03' },
                        { id: 3, institucionId: 1, letra: 'C', descripcion: 'Diferencia los modelos ideol√≥gicos y econ√≥micos del bloque capitalista y socialista.', puntos: 3, fechaEvaluacion: '2025-04-03' }
                    ];
                    indicadores.forEach(i => storeInd.add(i));

                    // Asistencias de ejemplo
                    const storeAsis = tx.objectStore('asistencia');
                    const asistencias = [
                        { id: 1, institucionId: 1, estudianteId: 1, fecha: '2025-04-01', estado: 'AI', seccion: '9-1', asignatura: 'Estudios Sociales', leccion: 1 },
                        { id: 2, institucionId: 1, estudianteId: 2, fecha: '2025-04-01', estado: 'AJ', seccion: '9-1', asignatura: 'Estudios Sociales', leccion: 1 },
                        { id: 3, institucionId: 1, estudianteId: 3, fecha: '2025-04-01', estado: 'T', seccion: '9-1', asignatura: 'Estudios Sociales', leccion: 1 }
                    ];
                    asistencias.forEach(a => storeAsis.add(a));

                    // Evaluaciones de cotidiano de ejemplo
                    const storeEval = tx.objectStore('evaluacionesCotidiano');
                    const evaluaciones = [
                        { id: 1, institucionId: 1, estudianteId: 1, periodo: 'I', a: 3, b: 3, c: 3, porcentaje: 50.00 },
                        { id: 2, institucionId: 1, estudianteId: 2, periodo: 'I', a: 3, b: 3, c: 3, porcentaje: 50.00 },
                        { id: 3, institucionId: 1, estudianteId: 6, periodo: 'I', a: 3, b: 3, c: 2, porcentaje: 44.44 },
                        { id: 4, institucionId: 1, estudianteId: 7, periodo: 'I', a: 2, b: 2, c: 3, porcentaje: 38.89 }
                    ];
                    evaluaciones.forEach(e => storeEval.add(e));
                };
            });
        }

        async function cargarDatosIniciales() {
            return new Promise((resolve) => {
                if (!db) return resolve();
                
                const tx = db.transaction('instituciones', 'readonly');
                tx.objectStore('instituciones').getAll().onsuccess = (e) => {
                    if (e.target.result.length > 0) {
                        institucionActiva = e.target.result[0];
                        nivelActivo = institucionActiva.nivel;
                        actualizarHeader();
                    }
                    resolve();
                };
            });
        }

        function actualizarHeader() {
            if (institucionActiva) {
                document.getElementById('institucionNombre').textContent = `MEP ¬∑ ${institucionActiva.nombre}`;
                document.getElementById('institucionDetalle').textContent = 
                    `C√≥digo: ${institucionActiva.codigo} ¬∑ ${institucionActiva.nivel}`;
            }
        }

        // ==================== NAVEGACI√ìN ====================
        function cambiarVista(vistaId) {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === vistaId);
            });

            const container = document.getElementById('appMain');
            
            const vistas = {
                instituciones: renderInstituciones,
                estudiantes: renderEstudiantes,
                asistencia: renderAsistencia,
                nuevaAsistencia: renderNuevaAsistencia,
                reporteAsistencia: renderReporteAsistencia,
                cotidiano: renderCotidiano,
                indicadores: renderIndicadores,
                evaluacion: renderEvaluacion,
                alertas: renderAlertas
            };

            if (vistas[vistaId]) {
                vistas[vistaId](container);
            }
        }

        // ==================== VISTA 1: INSTITUCIONES ====================
        function renderInstituciones(container) {
            if (!db) return;
            
            const tx = db.transaction('instituciones', 'readonly');
            tx.objectStore('instituciones').getAll().onsuccess = (e) => {
                const instituciones = e.target.result;
                
                container.innerHTML = `
                    <div class="card">
                        <div class="card-title">üè´ Centros Educativos</div>
                        <div class="grid-2">
                            <input type="text" id="inst-nombre" placeholder="Nombre">
                            <input type="text" id="inst-regional" placeholder="Direcci√≥n Regional">
                        </div>
                        <div class="grid-2">
                            <input type="text" id="inst-circuito" placeholder="Circuito">
                            <input type="text" id="inst-codigo" placeholder="C√≥digo">
                        </div>
                        <select id="inst-nivel">
                            <option value="preescolar">Preescolar</option>
                            <option value="primaria">Primaria</option>
                            <option value="secundaria" selected>Secundaria</option>
                        </select>
                        <button class="btn btn-primary mt-3" onclick="agregarInstitucion()">‚ûï Agregar Instituci√≥n</button>
                    </div>
                    <div class="card">
                        <h3>Instituciones Registradas</h3>
                        ${instituciones.map(inst => `
                            <div class="institucion-card" onclick="seleccionarInstitucion(${inst.id})">
                                <h4>${inst.nombre}</h4>
                                <p>${inst.direccionRegional} | C√≥digo: ${inst.codigo}</p>
                                <span class="badge badge-info">${inst.nivel}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            };

            window.agregarInstitucion = () => {
                const nombre = document.getElementById('inst-nombre').value;
                if (!nombre) return alert('‚ùå Nombre requerido');
                
                const tx = db.transaction('instituciones', 'readwrite');
                tx.objectStore('instituciones').add({
                    nombre,
                    direccionRegional: document.getElementById('inst-regional').value,
                    circuito: document.getElementById('inst-circuito').value,
                    codigo: document.getElementById('inst-codigo').value,
                    nivel: document.getElementById('inst-nivel').value,
                    registrada: new Date().toLocaleDateString('es-CR')
                });
                tx.oncomplete = () => cambiarVista('instituciones');
            };

            window.seleccionarInstitucion = (id) => {
                const tx = db.transaction('instituciones', 'readonly');
                tx.objectStore('instituciones').get(id).onsuccess = (e) => {
                    institucionActiva = e.target.result;
                    nivelActivo = institucionActiva.nivel;
                    actualizarHeader();
                    cambiarVista('estudiantes');
                };
            };
        }

        // ==================== VISTA 2: ESTUDIANTES ====================
        function renderEstudiantes(container) {
            if (!institucionActiva) return;

            const tx = db.transaction('estudiantes', 'readonly');
            const index = tx.objectStore('estudiantes').index('institucionId');
            index.getAll(institucionActiva.id).onsuccess = (e) => {
                const estudiantes = e.target.result;
                
                container.innerHTML = `
                    <div class="card">
                        <div class="card-title">üë• Lista de Estudiantes</div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Nombre</th>
                                        <th>Identificaci√≥n</th>
                                        <th>Secci√≥n</th>
                                        <th>Tel√©fono 1</th>
                                        <th>Tel√©fono 2</th>
                                        <th>ACS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${estudiantes.map((e, i) => `
                                        <tr>
                                            <td>${i+1}</td>
                                            <td>${e.nombre}</td>
                                            <td>${e.identificacion}</td>
                                            <td>${e.seccion}</td>
                                            <td>${e.telefono1}</td>
                                            <td>${e.telefono2}</td>
                                            <td>${e.acs ? '‚úÖ' : '‚ùå'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            };
        }

        // ==================== VISTA 3: ASISTENCIA (LISTADO GENERAL) ====================
        function renderAsistencia(container) {
            if (!institucionActiva) return;

            const tx = db.transaction('asistencia', 'readonly');
            const index = tx.objectStore('asistencia').index('institucionId');
            index.getAll(institucionActiva.id).onsuccess = (e) => {
                const asistencias = e.target.result;
                
                container.innerHTML = `
                    <div class="card">
                        <div class="card-title">üìÖ Control de Asistencia</div>
                        <div class="filtros-bar">
                            <div class="grid-3">
                                <div><label>Fecha desde:</label><input type="date" id="fechaDesde" value="2025-04-01"></div>
                                <div><label>Fecha hasta:</label><input type="date" id="fechaHasta" value="2025-04-30"></div>
                                <div><label>Secci√≥n:</label><select id="filtroSeccion"><option>Todas</option><option>9-1</option></select></div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-primary" onclick="filtrarAsistencia()">üîç Filtrar</button>
                                <button class="btn btn-outline" onclick="limpiarFiltrosAsistencia()">üóëÔ∏è Borrar</button>
                                <button class="btn btn-success" onclick="exportarAsistenciaExcel()">üì• Excel</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Estudiante</th>
                                        <th>Secci√≥n</th>
                                        <th>Asignatura</th>
                                        <th>Lecci√≥n</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${asistencias.map(a => {
                                        let estadoClass = '';
                                        let estadoText = '';
                                        if (a.estado === 'AI') { estadoClass = 'badge-danger'; estadoText = 'Ausencia Injustificada'; }
                                        else if (a.estado === 'AJ') { estadoClass = 'badge-warning'; estadoText = 'Ausencia Justificada'; }
                                        else if (a.estado === 'T') { estadoClass = 'badge-info'; estadoText = 'Tarde'; }
                                        else { estadoClass = 'badge-success'; estadoText = 'Presente'; }
                                        
                                        return `
                                            <tr>
                                                <td>${a.fecha}</td>
                                                <td>${getNombreEstudiante(a.estudianteId)}</td>
                                                <td>${a.seccion || '9-1'}</td>
                                                <td>${a.asignatura || 'Estudios Sociales'}</td>
                                                <td>${a.leccion || 1}</td>
                                                <td><span class="badge ${estadoClass}">${estadoText}</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            };

            window.filtrarAsistencia = () => alert('Filtros aplicados');
            window.limpiarFiltrosAsistencia = () => alert('Filtros borrados');
            window.exportarAsistenciaExcel = () => alert('Excel generado');
        }

        function getNombreEstudiante(id) {
            const estudiantes = {
                1: 'Alberto Laureano Guevara',
                2: 'Amalia Gil Longoria',
                3: 'Enrique Yuridia Jaramillo Becerra',
                4: 'Jos Gaona',
                5: 'Juan P√©rez Ledezma',
                6: 'Leonardo Reynoso',
                7: 'Luisa Jacinto Ledesma'
            };
            return estudiantes[id] || 'Desconocido';
        }

        // ==================== VISTA 4: NUEVA ASISTENCIA ====================
        function renderNuevaAsistencia(container) {
            if (!institucionActiva) return;

            const tx = db.transaction('estudiantes', 'readonly');
            const index = tx.objectStore('estudiantes').index('institucionId');
            index.getAll(institucionActiva.id).onsuccess = (e) => {
                const estudiantes = e.target.result;
                
                container.innerHTML = `
                    <div class="card">
                        <div class="card-title">‚ûï Registrar Nueva Asistencia</div>
                        <div class="grid-3">
                            <div class="form-group">
                                <label>Fecha:</label>
                                <input type="date" id="asisFecha" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label>Secci√≥n:</label>
                                <input type="text" id="asisSeccion" value="9-1">
                            </div>
                            <div class="form-group">
                                <label>Asignatura:</label>
                                <input type="text" id="asisAsignatura" value="Estudios Sociales">
                            </div>
                            <div class="form-group">
                                <label>Lecci√≥n:</label>
                                <select id="asisLeccion">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                        </div>
                        <h4>Lista de Estudiantes</h4>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Nombre</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaNuevaAsistencia">
                                    ${estudiantes.map((est, idx) => `
                                        <tr>
                                            <td>${idx+1}</td>
                                            <td>${est.nombre}</td>
                                            <td>
                                                <select class="estado-asistencia" data-id="${est.id}">
                                                    <option value="P">Presente</option>
                                                    <option value="AJ">Ausencia Justificada</option>
                                                    <option value="AI">Ausencia Injustificada</option>
                                                    <option value="T">Tarde</option>
                                                </select>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-success mt-3" onclick="guardarNuevaAsistencia()">üíæ Guardar Asistencia</button>
                    </div>
                `;
            };

            window.guardarNuevaAsistencia = () => {
                const filas = document.querySelectorAll('#tablaNuevaAsistencia tr');
                const fecha = document.getElementById('asisFecha').value;
                const seccion = document.getElementById('asisSeccion').value;
                const asignatura = document.getElementById('asisAsignatura').value;
                const leccion = document.getElementById('asisLeccion').value;

                const tx = db.transaction('asistencia', 'readwrite');
                const store = tx.objectStore('asistencia');

                filas.forEach(fila => {
                    const estudianteId = fila.querySelector('select').dataset.id;
                    const estado = fila.querySelector('select').value;
                    
                    store.add({
                        institucionId: institucionActiva.id,
                        estudianteId: parseInt(estudianteId),
                        fecha,
                        estado,
                        seccion,
                        asignatura,
                        leccion: parseInt(leccion)
                    });
                });

                tx.oncomplete = () => {
                    alert('‚úÖ Asistencia guardada correctamente');
                    cambiarVista('asistencia');
                };
            };
        }

        // ==================== VISTA 5: REPORTE DE ASISTENCIA ====================
        function renderReporteAsistencia(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üìä Reporte de Asistencia</div>
                    <div class="filtros-bar">
                        <p><strong>I Periodo / Estudios Sociales / 9-1 / 2025 / ${institucionActiva?.nombre || 'Liceo'}</strong></p>
                        <p class="text-muted">El porcentaje de asistencia se calcula como el porcentaje de lecciones en las que la asistencia del estudiante fue registrada... (8 lecciones)</p>
                    </div>
                    <div class="form-group">
                        <label>Filtrar por nombre:</label>
                        <input type="text" id="filtroNombreReporte" placeholder="Buscar...">
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Estudiantes</th>
                                    <th>Ausencias Justificadas</th>
                                    <th>Tardanzas</th>
                                    <th>Ausencias Injustificadas</th>
                                    <th>Total Ausencias</th>
                                    <th>Porcentaje en Nota (10%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Alberto Laureano Guevara</td><td>1</td><td>0</td><td>1</td><td>2</td><td><strong>8.75%</strong></td></tr>
                                <tr><td>Amalia Gil Longoria</td><td>0</td><td>1</td><td>0</td><td>1</td><td><strong>10%</strong></td></tr>
                                <tr><td>Enrique Yuridia Jaramillo Becerra</td><td>1</td><td>0</td><td>1</td><td>2</td><td><strong>8.75%</strong></td></tr>
                                <tr><td>Jos Gaona</td><td>1</td><td>1</td><td>0</td><td>2</td><td><strong>10%</strong></td></tr>
                                <tr><td>Juan P√©rez Ledezma</td><td>0</td><td>0</td><td>0</td><td>0</td><td><strong>10%</strong></td></tr>
                                <tr><td>Leonardo Reynoso</td><td>0</td><td>0</td><td>1</td><td>1</td><td><strong>10%</strong></td></tr>
                                <tr><td>Luisa Jacinto Ledesma</td><td>0</td><td>0</td><td>0</td><td>0</td><td><strong>10%</strong></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="generarPDFAsistencia()">üì• PDF</button>
                        <button class="btn btn-warning" onclick="generarWordAsistencia()">üì• Word</button>
                        <button class="btn btn-success" onclick="generarExcelAsistencia()">üì• Excel</button>
                    </div>
                </div>
            `;

            window.generarPDFAsistencia = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text('Reporte de Asistencia', 14, 15);
                doc.save('reporte_asistencia.pdf');
            };
            window.generarWordAsistencia = () => alert('Word generado');
            window.generarExcelAsistencia = () => alert('Excel generado');
        }

        // ==================== VISTA 6: TRABAJO COTIDIANO ====================
        function renderCotidiano(container) {
            if (!institucionActiva) return;

            Promise.all([
                new Promise(resolve => {
                    const tx = db.transaction('estudiantes', 'readonly');
                    const index = tx.objectStore('estudiantes').index('institucionId');
                    index.getAll(institucionActiva.id).onsuccess = e => resolve(e.target.result);
                }),
                new Promise(resolve => {
                    const tx = db.transaction('indicadores', 'readonly');
                    const index = tx.objectStore('indicadores').index('institucionId');
                    index.getAll(institucionActiva.id).onsuccess = e => resolve(e.target.result);
                }),
                new Promise(resolve => {
                    const tx = db.transaction('evaluacionesCotidiano', 'readonly');
                    const index = tx.objectStore('evaluacionesCotidiano').index('institucionId');
                    index.getAll(institucionActiva.id).onsuccess = e => resolve(e.target.result);
                })
            ]).then(([estudiantes, indicadores, evaluaciones]) => {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-title">üìù Trabajo Cotidiano</div>
                        <div class="filtros-bar">
                            <p><strong>I Periodo / Estudios Sociales / 9-1 / 2025 / ${institucionActiva.nombre}</strong></p>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="exportarCotidianoPDF()">üì• PDF</button>
                                <button class="btn btn-warning" onclick="exportarCotidianoWord()">üì• Word</button>
                                <button class="btn btn-success" onclick="exportarCotidianoExcel()">üì• Excel</button>
                                <button class="btn btn-outline" onclick="guardarTodasEvaluacionesCotidiano()">üíæ Guardar Todo</button>
                            </div>
                        </div>

                        <details>
                            <summary style="cursor: pointer; color: var(--mep-blue); font-weight: 600;">‚öôÔ∏è Configuraci√≥n del Trabajo Cotidiano</summary>
                            <div class="mt-3">
                                <h4>Indicadores</h4>
                                ${indicadores.map(ind => `
                                    <div class="indicador-item">
                                        <p><strong>${ind.letra}.</strong> ${ind.descripcion}</p>
                                        <p>Puntos: ${ind.puntos} | Fecha: ${ind.fechaEvaluacion}</p>
                                        <button class="btn btn-outline btn-small" onclick="editarIndicador(${ind.id})">‚úèÔ∏è Editar</button>
                                    </div>
                                `).join('')}
                                <button class="btn btn-success mt-2" onclick="agregarIndicador()">‚ûï Agregar Indicador</button>
                            </div>
                        </details>

                        <div class="table-responsive mt-3">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Estudiante</th>
                                        <th>A</th>
                                        <th>B</th>
                                        <th>C</th>
                                        <th>Valor 50%</th>
                                        <th>% Obtenido</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaCotidiano">
                                    ${estudiantes.map(est => {
                                        const evalEst = evaluaciones.find(e => e.estudianteId === est.id) || { a: 3, b: 3, c: 3, porcentaje: 50 };
                                        return `
                                            <tr data-estudiante-id="${est.id}">
                                                <td>${est.nombre}</td>
                                                <td><input type="number" class="input-a" value="${evalEst.a}" min="0" max="3" step="1" style="width:60px;"></td>
                                                <td><input type="number" class="input-b" value="${evalEst.b}" min="0" max="3" step="1" style="width:60px;"></td>
                                                <td><input type="number" class="input-c" value="${evalEst.c}" min="0" max="3" step="1" style="width:60px;"></td>
                                                <td>50.00%</td>
                                                <td class="porcentaje-obtenido">${evalEst.porcentaje.toFixed(2)}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                // Agregar listeners para recalcular autom√°ticamente
                document.querySelectorAll('#tablaCotidiano tr').forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    inputs.forEach(input => {
                        input.addEventListener('change', function() {
                            const a = parseFloat(row.querySelector('.input-a').value) || 0;
                            const b = parseFloat(row.querySelector('.input-b').value) || 0;
                            const c = parseFloat(row.querySelector('.input-c').value) || 0;
                            const total = a + b + c;
                            const maximo = 9; // 3+3+3
                            const porcentaje = (total / maximo) * 50;
                            row.querySelector('.porcentaje-obtenido').textContent = porcentaje.toFixed(2) + '%';
                        });
                    });
                });
            });

            window.agregarIndicador = () => {
                cambiarVista('indicadores');
            };

            window.editarIndicador = (id) => {
                cambiarVista('indicadores');
            };

            window.exportarCotidianoPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text('Trabajo Cotidiano', 14, 15);
                doc.save('trabajo_cotidiano.pdf');
            };
            window.exportarCotidianoWord = () => alert('Word generado');
            window.exportarCotidianoExcel = () => alert('Excel generado');

            window.guardarTodasEvaluacionesCotidiano = () => {
                const filas = document.querySelectorAll('#tablaCotidiano tr');
                const tx = db.transaction('evaluacionesCotidiano', 'readwrite');
                const store = tx.objectStore('evaluacionesCotidiano');

                filas.forEach(row => {
                    const estudianteId = parseInt(row.dataset.estudianteId);
                    const a = parseInt(row.querySelector('.input-a').value) || 0;
                    const b = parseInt(row.querySelector('.input-b').value) || 0;
                    const c = parseInt(row.querySelector('.input-c').value) || 0;
                    const total = a + b + c;
                    const porcentaje = (total / 9) * 50;

                    const evaluacion = {
                        institucionId: institucionActiva.id,
                        estudianteId,
                        periodo: 'I',
                        a, b, c,
                        porcentaje
                    };

                    // Buscar si ya existe
                    const index = tx.objectStore('evaluacionesCotidiano').index('estudianteId');
                    const request = index.openCursor(estudianteId);
                    request.onsuccess = (e) => {
                        const cursor = e.target.result;
                        if (cursor) {
                            // Actualizar existente
                            const evalExistente = cursor.value;
                            evalExistente.a = a;
                            evalExistente.b = b;
                            evalExistente.c = c;
                            evalExistente.porcentaje = porcentaje;
                            store.put(evalExistente);
                        } else {
                            // Agregar nueva
                            store.add(evaluacion);
                        }
                    };
                });

                tx.oncomplete = () => {
                    alert('‚úÖ Todas las evaluaciones guardadas');
                };
            };
        }

        // ==================== VISTA 7: INDICADORES ====================
        function renderIndicadores(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üîß Editar Indicador</div>
                    <div class="form-group">
                        <label>Descripci√≥n del indicador:</label>
                        <textarea id="indicadorDescripcion" rows="4">Analiza cr√≠ticamente las causas y consecuencias de la Segunda Guerra Mundial mediante el uso de recursos gr√°ficos e hist√≥ricos.</textarea>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Puntos por indicador:</label>
                            <input type="number" id="indicadorPuntos" value="3" min="1" max="5">
                        </div>
                        <div class="form-group">
                            <label>Fecha de Evaluaci√≥n:</label>
                            <input type="date" id="indicadorFecha" value="2025-04-03">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="cancelarEdicion()">Cancelar</button>
                        <button class="btn btn-success" onclick="guardarIndicador()">Guardar</button>
                    </div>
                </div>
            `;

            window.guardarIndicador = () => {
                const descripcion = document.getElementById('indicadorDescripcion').value;
                const puntos = parseInt(document.getElementById('indicadorPuntos').value);
                const fecha = document.getElementById('indicadorFecha').value;

                if (!descripcion || !puntos || !fecha) {
                    alert('‚ùå Todos los campos son obligatorios');
                    return;
                }

                const tx = db.transaction('indicadores', 'readwrite');
                tx.objectStore('indicadores').add({
                    institucionId: institucionActiva.id,
                    letra: 'Nuevo',
                    descripcion,
                    puntos,
                    fechaEvaluacion: fecha
                });

                tx.oncomplete = () => {
                    alert('‚úÖ Indicador guardado');
                    cambiarVista('cotidiano');
                };
            };

            window.cancelarEdicion = () => {
                cambiarVista('cotidiano');
            };
        }

        // ==================== VISTA 8: EVALUACI√ìN GENERAL ====================
        function renderEvaluacion(container) {
            if (!institucionActiva) return;

            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üìã Evaluaci√≥n General</div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    <th>Cotidiano (50%)</th>
                                    <th>Pruebas (30%)</th>
                                    <th>Tareas (10%)</th>
                                    <th>Proyectos (10%)</th>
                                    <th>Asistencia (10%)</th>
                                    <th>Nota Final</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Alberto Laureano Guevara</td>
                                    <td><input type="number" value="50" min="0" max="50" step="0.1"></td>
                                    <td><input type="number" value="27" min="0" max="30" step="0.1"></td>
                                    <td><input type="number" value="9" min="0" max="10" step="0.1"></td>
                                    <td><input type="number" value="8" min="0" max="10" step="0.1"></td>
                                    <td><input type="number" value="8.75" min="0" max="10" step="0.1"></td>
                                    <td><strong>92.75</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary mt-3" onclick="guardarEvaluacionGeneral()">üíæ Guardar Evaluaci√≥n</button>
                </div>
            `;

            window.guardarEvaluacionGeneral = () => {
                alert('‚úÖ Evaluaci√≥n general guardada');
            };
        }

        // ==================== VISTA 9: ALERTAS ====================
        function renderAlertas(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üö® Alertas de Rendimiento</div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    <th>Nota</th>
                                    <th>Tel√©fono</th>
                                    <th>WhatsApp</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Leonardo Reynoso</td>
                                    <td><span class="badge badge-danger">44.44%</span></td>
                                    <td>8888-6666</td>
                                    <td><button class="btn btn-warning btn-small" onclick="window.open('https://wa.me/50688886666?text=Alerta de rendimiento: su nota es 44.44%')">üì± Enviar</button></td>
                                </tr>
                                <tr>
                                    <td>Luisa Jacinto Ledesma</td>
                                    <td><span class="badge badge-danger">38.89%</span></td>
                                    <td>8888-7777</td>
                                    <td><button class="btn btn-warning btn-small" onclick="window.open('https://wa.me/50688887777?text=Alerta de rendimiento: su nota es 38.89%')">üì± Enviar</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // ==================== INICIALIZACI√ìN ====================
        window.onload = async () => {
            await inicializarDB();
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    cambiarVista(e.currentTarget.dataset.view);
                });
            });
        };

        window.cambiarVista = cambiarVista;
    })();
</script>
</body>
</html>
