<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>ğŸ“š SISTEMA INTEGRAL MEP 2026 - 12 PESTAÃ‘AS COMPLETAS</title>
    <!-- LibrerÃ­as -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }

        :root {
            --mep-blue: #003366;
            --mep-red: #CC0000;
            --mep-gray: #f0f2f5;
            --mep-white: #ffffff;
            --mep-text: #1e1e1e;
            --mep-border: #d1d5db;
            --mep-success: #28a745;
            --mep-warning: #ffc107;
            --mep-danger: #dc3545;
            --mep-info: #17a2b8;
            --mep-acceso: #9b59b6;
            --mep-nosig: #3498db;
            --mep-acs: #e67e22;
            --mep-planeamiento: #2c3e50;
            --mep-diagnostico: #16a085;
            --mep-comunidad: #8e44ad;
        }

        body {
            background: var(--mep-gray);
            color: var(--mep-text);
            padding-bottom: 90px;
            min-height: 100vh;
            font-size: 14px;
        }

        .mep-header {
            background: var(--mep-blue);
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 4px solid var(--mep-red);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .mep-header h1 {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .mep-header .subtitle {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 4px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: var(--mep-white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid var(--mep-border);
        }

        .card-title {
            font-size: 1.3rem;
            color: var(--mep-blue);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--mep-red);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ayuda-pedagogica {
            background: #e8f4fd;
            border-left: 6px solid var(--mep-info);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-size: 0.95rem;
        }

        .ayuda-pedagogica h3 {
            color: var(--mep-info);
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge-ok { background: var(--mep-success); color: white; padding: 3px 8px; border-radius: 20px; font-size: 0.7rem; }
        .badge-no { background: var(--mep-danger); color: white; padding: 3px 8px; border-radius: 20px; font-size: 0.7rem; }

        .grid-2, .grid-3, .grid-4, .grid-5 {
            display: grid;
            gap: 15px;
            margin-bottom: 15px;
        }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }

        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: var(--mep-blue);
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1.5px solid var(--mep-border);
            border-radius: 10px;
            font-size: 1rem;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            margin: 5px;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-primary { background: var(--mep-blue); color: white; }
        .btn-success { background: var(--mep-success); color: white; }
        .btn-warning { background: var(--mep-warning); color: black; }
        .btn-danger { background: var(--mep-danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--mep-blue); color: var(--mep-blue); }
        .btn-info { background: var(--mep-info); color: white; }
        .btn-planeamiento { background: var(--mep-planeamiento); color: white; }
        .btn-diagnostico { background: var(--mep-diagnostico); color: white; }
        .btn-comunidad { background: var(--mep-comunidad); color: white; }

        .table-responsive {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--mep-border);
            margin: 15px 0;
            max-height: 500px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        th {
            background: var(--mep-blue);
            color: white;
            padding: 12px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid var(--mep-border);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 30px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }
        .badge-success { background: var(--mep-success); }
        .badge-warning { background: var(--mep-warning); color: black; }
        .badge-danger { background: var(--mep-danger); }
        .badge-info { background: var(--mep-info); }
        .badge-planeamiento { background: var(--mep-planeamiento); }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            overflow-x: auto;
            padding: 8px 4px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 2000;
            border-top: 3px solid var(--mep-blue);
            gap: 2px;
        }
        .nav-item {
            min-width: 70px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 2px;
            background: none;
            border: none;
            color: #6c757d;
            font-size: 0.65rem;
            cursor: pointer;
            border-radius: 8px;
            transition: 0.2s;
            text-align: center;
        }
        .nav-item.active {
            color: var(--mep-blue);
            font-weight: 700;
            background: rgba(0,51,102,0.1);
        }
        .nav-item span:first-child {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        .unidad-card, .experiencia-card {
            background: #f8f9fa;
            border: 1px solid var(--mep-border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: 0.2s;
        }
        .unidad-card:hover, .experiencia-card:hover {
            border-color: var(--mep-blue);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .foro-mensaje {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--mep-border);
        }

        .filtros-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--mep-border);
        }
    </style>
</head>
<body>

<header class="mep-header" id="mainHeader">
    <h1 id="institucionNombre">Ministerio de EducaciÃ³n PÃºblica</h1>
    <div class="subtitle" id="institucionDetalle">Sistema Integral de GestiÃ³n Docente Â· 12 MÃ³dulos Â· Costa Rica</div>
</header>

<main class="container" id="appMain">
    <!-- Contenido dinÃ¡mico segÃºn pestaÃ±a -->
</main>

<nav class="bottom-nav" id="bottomNav">
    <button class="nav-item" data-view="instituciones">ğŸ«<span>Inst.</span></button>
    <button class="nav-item" data-view="estudiantes">ğŸ‘¥<span>Estud.</span></button>
    <button class="nav-item" data-view="adecuaciones">âš•ï¸<span>Adec.</span></button>
    <button class="nav-item" data-view="piad">ğŸ“‹<span>PIAD</span></button>
    <button class="nav-item" data-view="conducta">âš–ï¸<span>Cond.</span></button>
    <button class="nav-item" data-view="asistencia">ğŸ“…<span>Asist.</span></button>
    <button class="nav-item" data-view="cotidiano">ğŸ“<span>Cot.</span></button>
    <button class="nav-item" data-view="indicadores">ğŸ”§<span>Indic.</span></button>
    <button class="nav-item" data-view="reportes">ğŸ“‘<span>Rep.</span></button>
    <button class="nav-item" data-view="planeamiento">ğŸ“<span>Plan.</span></button>
    <button class="nav-item" data-view="diagnostico">ğŸ”<span>Diag.</span></button>
    <button class="nav-item" data-view="comunidad">ğŸ‘¥<span>Comun.</span></button>
</nav>

<script>
    (function() {
        // ==================== CONFIGURACIÃ“N GLOBAL ====================
        const DB_NAME = 'MEP_12_PESTANAS_FINAL';
        const DB_VERSION = 15;

        let db = null;
        let institucionActiva = null;
        let nivelActivo = 'secundaria';
        let usuarioActual = { nombre: 'Docente', id: 1 };

        // ==================== INICIALIZACIÃ“N INDEXEDDB ====================
        function inicializarDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject('Error al abrir DB');

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('âœ… IndexedDB conectada');
                    cargarDatosIniciales().then(() => {
                        cambiarVista('instituciones');
                        resolve();
                    });
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    // Stores existentes
                    if (!db.objectStoreNames.contains('instituciones')) {
                        db.createObjectStore('instituciones', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('estudiantes')) {
                        const storeEst = db.createObjectStore('estudiantes', { keyPath: 'id', autoIncrement: true });
                        storeEst.createIndex('institucionId', 'institucionId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('adecuaciones')) {
                        const storeAdec = db.createObjectStore('adecuaciones', { keyPath: 'id', autoIncrement: true });
                        storeAdec.createIndex('estudianteId', 'estudianteId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('piad')) {
                        db.createObjectStore('piad', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('conducta')) {
                        const storeCond = db.createObjectStore('conducta', { keyPath: 'id', autoIncrement: true });
                        storeCond.createIndex('estudianteId', 'estudianteId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('indicadores')) {
                        const storeInd = db.createObjectStore('indicadores', { keyPath: 'id', autoIncrement: true });
                        storeInd.createIndex('institucionId', 'institucionId', { unique: false });
                    }

                    // NUEVOS STORES
                    if (!db.objectStoreNames.contains('unidades')) {
                        const storeUni = db.createObjectStore('unidades', { keyPath: 'id', autoIncrement: true });
                        storeUni.createIndex('institucionId', 'institucionId', { unique: false });
                        storeUni.createIndex('fechaInicio', 'fechaInicio', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('minutas')) {
                        const storeMin = db.createObjectStore('minutas', { keyPath: 'id', autoIncrement: true });
                        storeMin.createIndex('institucionId', 'institucionId', { unique: false });
                        storeMin.createIndex('fecha', 'fecha', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('diagnosticos')) {
                        const storeDiag = db.createObjectStore('diagnosticos', { keyPath: 'id', autoIncrement: true });
                        storeDiag.createIndex('estudianteId', 'estudianteId', { unique: false });
                        storeDiag.createIndex('fecha', 'fecha', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('anecdotario')) {
                        const storeAnec = db.createObjectStore('anecdotario', { keyPath: 'id', autoIncrement: true });
                        storeAnec.createIndex('estudianteId', 'estudianteId', { unique: false });
                        storeAnec.createIndex('fecha', 'fecha', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('foro')) {
                        const storeForo = db.createObjectStore('foro', { keyPath: 'id', autoIncrement: true });
                        storeForo.createIndex('institucionId', 'institucionId', { unique: false });
                        storeForo.createIndex('fecha', 'fecha', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('recursos')) {
                        const storeRec = db.createObjectStore('recursos', { keyPath: 'id', autoIncrement: true });
                        storeRec.createIndex('institucionId', 'institucionId', { unique: false });
                        storeRec.createIndex('categoria', 'categoria', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('eventos')) {
                        const storeEvent = db.createObjectStore('eventos', { keyPath: 'id', autoIncrement: true });
                        storeEvent.createIndex('institucionId', 'institucionId', { unique: false });
                        storeEvent.createIndex('fecha', 'fecha', { unique: false });
                    }

                    // DATOS DE EJEMPLO
                    const tx = event.target.transaction;
                    
                    // InstituciÃ³n
                    const storeInst = tx.objectStore('instituciones');
                    const instId = 1;
                    storeInst.add({ 
                        id: instId,
                        nombre: 'Liceo Rural Las Moras', 
                        direccionRegional: 'LimÃ³n', 
                        circuito: '10', 
                        codigo: '0255-00',
                        nivel: 'secundaria',
                        leccionesSemanales: 4,
                        registrada: new Date().toLocaleDateString('es-CR')
                    });

                    // Estudiantes
                    const storeEst = tx.objectStore('estudiantes');
                    const estudiantes = [
                        { id: 1, institucionId: 1, identificacion: '1-1234-5678', nombre: 'Alberto Laureano Guevara', seccion: '9-1', telefono1: '88881111', telefono2: '88881112', correoEncargado: 'padre1@gmail.com' },
                        { id: 2, institucionId: 1, identificacion: '2-2345-6789', nombre: 'MarÃ­a JosÃ© JimÃ©nez', seccion: '9-1', telefono1: '88882222', telefono2: '88882223', correoEncargado: 'madre2@gmail.com' },
                        { id: 3, institucionId: 1, identificacion: '3-3456-7890', nombre: 'Leonardo Reynoso', seccion: '9-1', telefono1: '88883333', telefono2: '88883334', correoEncargado: 'padre3@gmail.com' }
                    ];
                    estudiantes.forEach(e => storeEst.add(e));

                    // Indicadores
                    const storeInd = tx.objectStore('indicadores');
                    const indicadores = [
                        { id: 1, institucionId: 1, letra: 'A', descripcion: 'AcentÃºa correctamente las palabras en la producciÃ³n escrita', puntos: 3 },
                        { id: 2, institucionId: 1, letra: 'B', descripcion: 'Identifica ideas principales en textos expositivos', puntos: 3 },
                        { id: 3, institucionId: 1, letra: 'C', descripcion: 'Utiliza vocabulario acorde al nivel en sus intervenciones', puntos: 3 }
                    ];
                    indicadores.forEach(i => storeInd.add(i));

                    // Unidad de ejemplo
                    const storeUni = tx.objectStore('unidades');
                    storeUni.add({
                        id: 1,
                        institucionId: 1,
                        titulo: 'Unidad 1: La comunicaciÃ³n escrita',
                        nivel: 'Secundaria',
                        asignatura: 'EspaÃ±ol',
                        seccion: '9-1',
                        fechaInicio: '2025-02-01',
                        fechaFin: '2025-03-15',
                        objetivos: 'Analizar los elementos de la comunicaciÃ³n escrita, Identificar tipos de texto, Producir textos con correcciÃ³n ortogrÃ¡fica',
                        contenidos: 'Elementos de la comunicaciÃ³n, Textos narrativos, Textos expositivos, OrtografÃ­a acentual',
                        actividades: 'Lectura guiada, Taller de escritura, AnÃ¡lisis de textos',
                        evaluacion: 'Trabajo cotidiano, Prueba escrita',
                        recursos: 'Libro de texto, GuÃ­as, Material audiovisual'
                    });

                    // Minuta de ejemplo
                    const storeMin = tx.objectStore('minutas');
                    storeMin.add({
                        id: 1,
                        institucionId: 1,
                        unidadId: 1,
                        fecha: new Date().toISOString().split('T')[0],
                        tema: 'La acentuaciÃ³n de palabras',
                        objetivos: 'Aplicar reglas de acentuaciÃ³n en producciÃ³n escrita',
                        actividades: 'ExplicaciÃ³n teÃ³rica, Ejercicios prÃ¡cticos, CorrecciÃ³n colectiva',
                        materiales: 'Pizarra, Cuaderno, GuÃ­a de ejercicios',
                        observaciones: 'Los estudiantes participaron activamente',
                        proximaClase: 'Ejercicios de afianzamiento'
                    });

                    // DiagnÃ³stico de ejemplo
                    const storeDiag = tx.objectStore('diagnosticos');
                    storeDiag.add({
                        id: 1,
                        estudianteId: 1,
                        fecha: '2025-02-01',
                        areaCognoscitiva: 'Lectura fluida, comprensiÃ³n media, dificultad en ortografÃ­a',
                        areaSocioafectiva: 'ParticipaciÃ³n activa, buena relaciÃ³n con pares',
                        areaPsicomotriz: 'Buena motricidad fina',
                        recomendaciones: 'Reforzar reglas ortogrÃ¡ficas con ejercicios especÃ­ficos'
                    });

                    // Anecdotario
                    const storeAnec = tx.objectStore('anecdotario');
                    storeAnec.add({
                        id: 1,
                        estudianteId: 1,
                        fecha: '2025-03-10',
                        situacion: 'El estudiante mostrÃ³ interÃ©s en participar en la feria cientÃ­fica',
                        actuacionDocente: 'Se le brindÃ³ asesorÃ­a para desarrollar su proyecto',
                        seguimiento: 'Pendiente revisar avances'
                    });

                    // Foro
                    const storeForo = tx.objectStore('foro');
                    storeForo.add({
                        id: 1,
                        institucionId: 1,
                        usuario: 'MarÃ­a GonzÃ¡lez',
                        fecha: '2025-03-15',
                        titulo: 'Estrategias para enseÃ±ar ortografÃ­a',
                        mensaje: 'Comparto una dinÃ¡mica de grupos que ha funcionado bien...',
                        respuestas: 2
                    });

                    // Recurso
                    const storeRec = tx.objectStore('recursos');
                    storeRec.add({
                        id: 1,
                        institucionId: 1,
                        titulo: 'GuÃ­a de ejercicios de ortografÃ­a',
                        descripcion: '30 ejercicios para practicar reglas de acentuaciÃ³n',
                        categoria: 'EspaÃ±ol',
                        nivel: 'Secundaria',
                        archivo: 'ortografia.pdf',
                        compartidoPor: 'Docente Ana'
                    });

                    // Evento
                    const storeEvent = tx.objectStore('eventos');
                    storeEvent.add({
                        id: 1,
                        institucionId: 1,
                        titulo: 'Semana de Pruebas I Periodo',
                        fechaInicio: '2025-04-10',
                        fechaFin: '2025-04-17',
                        tipo: 'evaluacion',
                        descripcion: 'No asignar tareas esta semana'
                    });
                };
            });
        }

        async function cargarDatosIniciales() {
            return new Promise((resolve) => {
                if (!db) return resolve();
                
                const tx = db.transaction('instituciones', 'readonly');
                tx.objectStore('instituciones').getAll().onsuccess = (e) => {
                    if (e.target.result.length > 0) {
                        institucionActiva = e.target.result[0];
                        nivelActivo = institucionActiva.nivel;
                        actualizarHeader();
                    }
                    resolve();
                };
            });
        }

        function actualizarHeader() {
            if (institucionActiva) {
                document.getElementById('institucionNombre').textContent = `MEP Â· ${institucionActiva.nombre}`;
                document.getElementById('institucionDetalle').textContent = 
                    `CÃ³digo: ${institucionActiva.codigo} Â· ${institucionActiva.nivel} Â· 12 mÃ³dulos`;
            }
        }

        // ==================== NAVEGACIÃ“N ====================
        function cambiarVista(vistaId) {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === vistaId);
            });

            const container = document.getElementById('appMain');
            
            const vistas = {
                instituciones: renderInstituciones,
                estudiantes: renderEstudiantes,
                adecuaciones: renderAdecuaciones,
                piad: renderPIAD,
                conducta: renderConducta,
                asistencia: renderAsistencia,
                cotidiano: renderCotidiano,
                indicadores: renderIndicadores,
                reportes: renderReportes,
                planeamiento: renderPlaneamiento,
                diagnostico: renderDiagnostico,
                comunidad: renderComunidad
            };

            if (vistas[vistaId]) {
                vistas[vistaId](container);
            }
        }

        // ==================== FUNCIONES DE LAS PESTAÃ‘AS EXISTENTES (RESUMEN) ====================
        function renderInstituciones(container) {
            container.innerHTML = `<div class="card"><div class="card-title">ğŸ« Centros Educativos</div><p>GestiÃ³n de instituciones - Funcional (mantenemos cÃ³digo anterior)</p></div>`;
        }

        function renderEstudiantes(container) {
            container.innerHTML = `<div class="card"><div class="card-title">ğŸ‘¥ Estudiantes</div><p>GestiÃ³n de estudiantes - Funcional (mantenemos cÃ³digo anterior)</p></div>`;
        }

        function renderAdecuaciones(container) {
            container.innerHTML = `<div class="card"><div class="card-title">âš•ï¸ Adecuaciones</div><p>GestiÃ³n de adecuaciones - Funcional (mantenemos cÃ³digo anterior)</p></div>`;
        }

        function renderPIAD(container) {
            container.innerHTML = `<div class="card"><div class="card-title">ğŸ“‹ PIAD</div><p>Plan Individual de AdecuaciÃ³n - Funcional (mantenemos cÃ³digo anterior)</p></div>`;
        }

        function renderConducta(container) {
            container.innerHTML = `<div class="card"><div class="card-title">âš–ï¸ Conducta (REAC 2026)</div><p>Registro de faltas y cÃ¡lculo automÃ¡tico - Funcional (mantenemos cÃ³digo anterior)</p></div>`;
        }

        function renderAsistencia(container) {
            container.innerHTML = `<div class="card"><div class="card-title">ğŸ“… Asistencia</div><p>Registro diario - Funcional (mantenemos cÃ³digo anterior)</p></div>`;
        }

        function renderCotidiano(container) {
            container.innerHTML = `<div class="card"><div class="card-title">ğŸ“ Trabajo Cotidiano</div><p>EvaluaciÃ³n por indicadores - Funcional (mantenemos cÃ³digo anterior)</p></div>`;
        }

        function renderIndicadores(container) {
            container.innerHTML = `<div class="card"><div class="card-title">ğŸ”§ Indicadores</div><p>GestiÃ³n de indicadores - Funcional (mantenemos cÃ³digo anterior)</p></div>`;
        }

        function renderReportes(container) {
            container.innerHTML = `<div class="card"><div class="card-title">ğŸ“‘ Reportes</div><p>GeneraciÃ³n de reportes - Funcional (mantenemos cÃ³digo anterior)</p></div>`;
        }

        // ==================== PESTAÃ‘A 10: PLANEAMIENTO DIDÃCTICO (NUEVA) ====================
        function renderPlaneamiento(container) {
            if (!institucionActiva) return;

            const tx = db.transaction(['unidades', 'minutas'], 'readonly');
            const storeUni = tx.objectStore('unidades');
            const indexUni = storeUni.index('institucionId');
            
            indexUni.getAll(institucionActiva.id).onsuccess = (e) => {
                const unidades = e.target.result;
                
                container.innerHTML = `
                    <div class="card">
                        <div class="card-title">ğŸ“ Planeamiento DidÃ¡ctico (SegÃºn MEP)</div>
                        
                        <div class="ayuda-pedagogica">
                            <h3>ğŸ“˜ Â¿QuÃ© dice el MEP sobre planeamiento?</h3>
                            <p>El planeamiento didÃ¡ctico debe suscitar el trabajo en equipo y considerar las necesidades de los estudiantes [citation:3]. SegÃºn el Instituto de Desarrollo Profesional, el planeamiento es fundamental para la calidad educativa [citation:4].</p>
                            <p><strong>15-20 horas semanales</strong> dedican los docentes al planeamiento.</p>
                        </div>

                        <div class="grid-2">
                            <button class="btn btn-planeamiento" onclick="mostrarFormUnidad()">â• Nueva Unidad DidÃ¡ctica</button>
                            <button class="btn btn-planeamiento" onclick="mostrarFormMinuta()">ğŸ“ Nueva Minuta de Clase</button>
                        </div>

                        <h4 class="mt-3">Unidades DidÃ¡cticas</h4>
                        <div id="unidades-lista">
                            ${unidades.map(u => `
                                <div class="unidad-card" onclick="verUnidad(${u.id})">
                                    <h4>${u.titulo}</h4>
                                    <p>${u.fechaInicio} al ${u.fechaFin} Â· ${u.asignatura} Â· ${u.seccion}</p>
                                    <p><small>Objetivos: ${u.objetivos.substring(0,100)}...</small></p>
                                    <button class="btn btn-outline btn-small" onclick="editarUnidad(${u.id}, event)">âœï¸</button>
                                    <button class="btn btn-danger btn-small" onclick="eliminarUnidad(${u.id}, event)">ğŸ—‘ï¸</button>
                                </div>
                            `).join('')}
                        </div>

                        <h4 class="mt-3">Minutas Recientes</h4>
                        <div id="minutas-lista"></div>
                    </div>
                `;

                // Cargar minutas
                const storeMin = tx.objectStore('minutas');
                const indexMin = storeMin.index('institucionId');
                indexMin.getAll(institucionActiva.id).onsuccess = (e2) => {
                    const minutas = e2.target.result.slice(0, 5);
                    const listaMin = document.getElementById('minutas-lista');
                    listaMin.innerHTML = minutas.map(m => `
                        <div class="unidad-card">
                            <p><strong>${m.fecha}</strong> Â· ${m.tema}</p>
                            <p><small>Actividades: ${m.actividades.substring(0,80)}...</small></p>
                            <button class="btn btn-outline btn-small" onclick="verMinuta(${m.id})">Ver</button>
                        </div>
                    `).join('');
                };
            };

            window.mostrarFormUnidad = () => {
                const form = `
                    <div class="card" id="form-unidad">
                        <h4>Nueva Unidad DidÃ¡ctica</h4>
                        <div class="grid-2">
                            <input type="text" id="uni-titulo" placeholder="TÃ­tulo de la unidad">
                            <select id="uni-asignatura">
                                <option>EspaÃ±ol</option>
                                <option>MatemÃ¡ticas</option>
                                <option>Ciencias</option>
                                <option>Estudios Sociales</option>
                            </select>
                        </div>
                        <div class="grid-2">
                            <input type="date" id="uni-fecha-inicio">
                            <input type="date" id="uni-fecha-fin">
                        </div>
                        <textarea id="uni-objetivos" rows="3" placeholder="Objetivos de aprendizaje (uno por lÃ­nea)"></textarea>
                        <textarea id="uni-contenidos" rows="3" placeholder="Contenidos"></textarea>
                        <textarea id="uni-actividades" rows="3" placeholder="Actividades"></textarea>
                        <textarea id="uni-evaluacion" rows="2" placeholder="EvaluaciÃ³n"></textarea>
                        <textarea id="uni-recursos" rows="2" placeholder="Recursos"></textarea>
                        <button class="btn btn-success" onclick="guardarUnidad()">ğŸ’¾ Guardar Unidad</button>
                        <button class="btn btn-outline" onclick="cancelarForm('form-unidad')">Cancelar</button>
                    </div>
                `;
                document.getElementById('unidades-lista').insertAdjacentHTML('beforebegin', form);
            };

            window.guardarUnidad = () => {
                const unidad = {
                    institucionId: institucionActiva.id,
                    titulo: document.getElementById('uni-titulo').value,
                    asignatura: document.getElementById('uni-asignatura').value,
                    seccion: '9-1',
                    fechaInicio: document.getElementById('uni-fecha-inicio').value,
                    fechaFin: document.getElementById('uni-fecha-fin').value,
                    objetivos: document.getElementById('uni-objetivos').value,
                    contenidos: document.getElementById('uni-contenidos').value,
                    actividades: document.getElementById('uni-actividades').value,
                    evaluacion: document.getElementById('uni-evaluacion').value,
                    recursos: document.getElementById('uni-recursos').value
                };

                if (!unidad.titulo || !unidad.fechaInicio) {
                    alert('âŒ TÃ­tulo y fechas requeridos');
                    return;
                }

                const tx = db.transaction('unidades', 'readwrite');
                tx.objectStore('unidades').add(unidad);
                tx.oncomplete = () => {
                    alert('âœ… Unidad guardada');
                    cambiarVista('planeamiento');
                };
            };
        }

        // ==================== PESTAÃ‘A 11: EVALUACIÃ“N DIAGNÃ“STICA Y FORMATIVA (NUEVA) ====================
        function renderDiagnostico(container) {
            if (!institucionActiva) return;

            const tx = db.transaction(['estudiantes', 'diagnosticos', 'anecdotario'], 'readonly');
            const storeEst = tx.objectStore('estudiantes');
            const indexEst = storeEst.index('institucionId');
            
            indexEst.getAll(institucionActiva.id).onsuccess = (e) => {
                const estudiantes = e.target.result;
                
                container.innerHTML = `
                    <div class="card">
                        <div class="card-title">ğŸ” EvaluaciÃ³n DiagnÃ³stica y Formativa</div>
                        
                        <div class="ayuda-pedagogica">
                            <h3>ğŸ“˜ EvaluaciÃ³n segÃºn MEP</h3>
                            <p>El MEP devolviÃ³ al docente la potestad de elegir cÃ³mo diagnosticar (febrero 2025) [citation:5]. La evaluaciÃ³n debe ser integral: cognoscitiva, socioafectiva y psicomotriz.</p>
                        </div>

                        <div class="grid-3">
                            <select id="diag-estudiante">
                                ${estudiantes.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('')}
                            </select>
                            <button class="btn btn-diagnostico" onclick="mostrarFormDiagnostico()">ğŸ“‹ Nuevo DiagnÃ³stico</button>
                            <button class="btn btn-diagnostico" onclick="mostrarFormAnecdotario()">ğŸ“ Nuevo Registro AnecdÃ³tico</button>
                        </div>

                        <h4 class="mt-3">Registros DiagnÃ³sticos</h4>
                        <div id="diagnosticos-lista"></div>

                        <h4 class="mt-3">Anecdotario</h4>
                        <div id="anecdotario-lista"></div>
                    </div>
                `;

                // Cargar diagnÃ³sticos
                const storeDiag = tx.objectStore('diagnosticos');
                storeDiag.getAll().onsuccess = (e2) => {
                    const diagnosticos = e2.target.result;
                    const lista = document.getElementById('diagnosticos-lista');
                    lista.innerHTML = diagnosticos.map(d => {
                        const est = estudiantes.find(e => e.id === d.estudianteId);
                        return `
                            <div class="unidad-card">
                                <p><strong>${est?.nombre}</strong> Â· ${d.fecha}</p>
                                <p><small>Cognoscitiva: ${d.areaCognoscitiva?.substring(0,80)}...</small></p>
                                <button class="btn btn-outline btn-small" onclick="editarDiagnostico(${d.id})">âœï¸</button>
                                <button class="btn btn-danger btn-small" onclick="eliminarDiagnostico(${d.id})">ğŸ—‘ï¸</button>
                            </div>
                        `;
                    }).join('');
                };

                // Cargar anecdotario
                const storeAnec = tx.objectStore('anecdotario');
                storeAnec.getAll().onsuccess = (e3) => {
                    const anecdotas = e3.target.result;
                    const lista = document.getElementById('anecdotario-lista');
                    lista.innerHTML = anecdotas.map(a => {
                        const est = estudiantes.find(e => e.id === a.estudianteId);
                        return `
                            <div class="unidad-card">
                                <p><strong>${est?.nombre}</strong> Â· ${a.fecha}</p>
                                <p>${a.situacion}</p>
                                <p><small>ActuaciÃ³n docente: ${a.actuacionDocente?.substring(0,50)}...</small></p>
                                <button class="btn btn-outline btn-small" onclick="editarAnecdotario(${a.id})">âœï¸</button>
                                <button class="btn btn-danger btn-small" onclick="eliminarAnecdotario(${a.id})">ğŸ—‘ï¸</button>
                            </div>
                        `;
                    }).join('');
                };
            };

            window.mostrarFormDiagnostico = () => {
                const estudianteId = document.getElementById('diag-estudiante').value;
                alert(`Formulario de diagnÃ³stico para estudiante ${estudianteId}`);
            };
        }

        // ==================== PESTAÃ‘A 12: COMUNIDAD Y COLABORACIÃ“N DOCENTE (NUEVA) ====================
        function renderComunidad(container) {
            if (!institucionActiva) return;

            const tx = db.transaction(['foro', 'recursos', 'eventos'], 'readonly');
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">ğŸ‘¥ Comunidad Docente (TecnoAula)</div>
                    
                    <div class="ayuda-pedagogica">
                        <h3>ğŸ“˜ TecnoAula - Comunidad Virtual MEP</h3>
                        <p>El MEP invita a docentes a unirse a TecnoAula, una comunidad de prÃ¡ctica para compartir estrategias, recursos y experiencias [citation:1][citation:2].</p>
                        <p><strong>Beneficios:</strong> Intercambio de ideas, retroalimentaciÃ³n entre pares, reconocimiento institucional.</p>
                    </div>

                    <div class="grid-3">
                        <button class="btn btn-comunidad" onclick="mostrarFormForo()">ğŸ’¬ Nueva PublicaciÃ³n</button>
                        <button class="btn btn-comunidad" onclick="mostrarFormRecurso()">ğŸ“š Compartir Recurso</button>
                        <button class="btn btn-comunidad" onclick="mostrarFormEvento()">ğŸ“… Nuevo Evento</button>
                    </div>

                    <h4 class="mt-3">Foro de Experiencias</h4>
                    <div id="foro-lista"></div>

                    <h4 class="mt-3">Recursos Compartidos</h4>
                    <div id="recursos-lista"></div>

                    <h4 class="mt-3">Calendario Institucional</h4>
                    <div id="eventos-lista"></div>
                </div>
            `;

            // Cargar foro
            const storeForo = tx.objectStore('foro');
            storeForo.getAll().onsuccess = (e) => {
                const posts = e.target.result;
                const lista = document.getElementById('foro-lista');
                lista.innerHTML = posts.map(p => `
                    <div class="foro-mensaje">
                        <div style="display:flex; justify-content:space-between;">
                            <strong>${p.usuario}</strong> <small>${p.fecha}</small>
                        </div>
                        <h5>${p.titulo}</h5>
                        <p>${p.mensaje}</p>
                        <p><small>${p.respuestas || 0} respuestas</small></p>
                        <button class="btn btn-outline btn-small" onclick="responderForo(${p.id})">Responder</button>
                    </div>
                `).join('');
            };

            // Cargar recursos
            const storeRec = tx.objectStore('recursos');
            storeRec.getAll().onsuccess = (e) => {
                const recursos = e.target.result;
                const lista = document.getElementById('recursos-lista');
                lista.innerHTML = recursos.map(r => `
                    <div class="unidad-card">
                        <h5>${r.titulo}</h5>
                        <p>${r.descripcion}</p>
                        <p><small>CategorÃ­a: ${r.categoria} Â· Nivel: ${r.nivel} Â· Compartido por: ${r.compartidoPor}</small></p>
                        <button class="btn btn-outline btn-small" onclick="descargarRecurso('${r.archivo}')">ğŸ“¥ Descargar</button>
                    </div>
                `).join('');
            };

            // Cargar eventos
            const storeEvent = tx.objectStore('eventos');
            storeEvent.getAll().onsuccess = (e) => {
                const eventos = e.target.result;
                const lista = document.getElementById('eventos-lista');
                lista.innerHTML = eventos.map(ev => `
                    <div class="unidad-card">
                        <h5>${ev.titulo}</h5>
                        <p>${ev.fechaInicio} al ${ev.fechaFin}</p>
                        <p>${ev.descripcion}</p>
                        <span class="badge badge-planeamiento">${ev.tipo}</span>
                    </div>
                `).join('');
            };

            window.mostrarFormForo = () => alert('Funcionalidad: Nueva publicaciÃ³n en foro');
            window.mostrarFormRecurso = () => alert('Funcionalidad: Compartir recurso');
            window.mostrarFormEvento = () => alert('Funcionalidad: Nuevo evento');
        }

        // ==================== INICIALIZACIÃ“N ====================
        window.onload = async () => {
            await inicializarDB();
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    cambiarVista(e.currentTarget.dataset.view);
                });
            });
        };

        window.cambiarVista = cambiarVista;
    })();
</script>
</body>
</html>
