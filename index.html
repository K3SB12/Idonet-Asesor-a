<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>SISTEMA DOCENTE MEP 2026 - VERSI√ìN COMPLETA (100%)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Arial', system-ui, sans-serif;
        }

        :root {
            --mep-blue: #003366;
            --mep-red: #CC0000;
            --mep-gray: #f0f2f5;
            --mep-white: #ffffff;
            --mep-text: #1e1e1e;
            --mep-border: #d1d5db;
            --mep-success: #28a745;
            --mep-warning: #ffc107;
            --mep-danger: #dc3545;
        }

        body {
            background: var(--mep-gray);
            color: var(--mep-text);
            padding-bottom: 90px;
            font-size: 14px;
        }

        .mep-header {
            background: var(--mep-blue);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 4px solid var(--mep-red);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .mep-header h1 {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .mep-header .subtitle {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 4px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: var(--mep-white);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid var(--mep-border);
        }

        .card-title {
            font-size: 1.3rem;
            color: var(--mep-blue);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--mep-red);
            font-weight: 600;
        }

        .grid-2, .grid-3, .grid-4, .grid-5 {
            display: grid;
            gap: 15px;
            margin-bottom: 15px;
        }

        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: var(--mep-blue);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--mep-border);
            border-radius: 8px;
            font-size: 1rem;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            margin: 5px;
            transition: 0.2s;
            display: inline-block;
        }

        .btn-primary { background: var(--mep-blue); color: white; }
        .btn-success { background: var(--mep-success); color: white; }
        .btn-warning { background: var(--mep-warning); color: black; }
        .btn-danger { background: var(--mep-danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--mep-blue); color: var(--mep-blue); }

        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--mep-border);
            margin: 15px 0;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th {
            background: var(--mep-blue);
            color: white;
            padding: 12px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--mep-border);
            text-align: left;
        }

        td input, td select {
            width: 100%;
            padding: 6px;
            font-size: 0.85rem;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
        }

        .badge-success { background: var(--mep-success); }
        .badge-warning { background: var(--mep-warning); color: black; }
        .badge-danger { background: var(--mep-danger); }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            overflow-x: auto;
            padding: 10px 5px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 2000;
            border-top: 2px solid var(--mep-blue);
        }

        .nav-item {
            min-width: 70px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 4px;
            background: none;
            border: none;
            color: #6c757d;
            font-size: 0.7rem;
            cursor: pointer;
            border-radius: 8px;
        }

        .nav-item.active {
            color: var(--mep-blue);
            font-weight: 600;
            background: rgba(0,51,102,0.1);
        }

        .nav-item span:first-child {
            font-size: 1.3rem;
            margin-bottom: 2px;
        }

        .indicador-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--mep-blue);
        }

        .plantilla-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .plantilla-card {
            background: white;
            border: 1px solid var(--mep-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .plantilla-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: var(--mep-blue);
        }

        .plantilla-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .text-success { color: var(--mep-success); }
        .text-danger { color: var(--mep-danger); }
        .mt-3 { margin-top: 15px; }
        .mb-3 { margin-bottom: 15px; }
    </style>
</head>
<body>

<header class="mep-header" id="mainHeader">
    <h1 id="institucionNombre">Ministerio de Educaci√≥n P√∫blica</h1>
    <div class="subtitle" id="institucionDetalle">Sistema Integral de Gesti√≥n Docente ¬∑ Costa Rica</div>
</header>

<main class="container" id="appMain">
    <!-- Contenido din√°mico -->
</main>

<nav class="bottom-nav" id="bottomNav">
    <button class="nav-item" data-view="config">‚öôÔ∏è<span>Config</span></button>
    <button class="nav-item" data-view="parametros">‚öñÔ∏è<span>Ponderar</span></button>
    <button class="nav-item" data-view="estudiantes">üë•<span>Lista</span></button>
    <button class="nav-item" data-view="asistencia">üìÖ<span>Asistencia</span></button>
    <button class="nav-item" data-view="cotidiano">üìù<span>Cotidiano</span></button>
    <button class="nav-item" data-view="evaluacion">üìä<span>Notas</span></button>
    <button class="nav-item" data-view="bitacora">üìñ<span>DUA</span></button>
    <button class="nav-item" data-view="alertas">üö®<span>Alertas</span></button>
    <button class="nav-item" data-view="plantillas">üìë<span>Plantillas</span></button>
</nav>

<script>
    (function() {
        // ==================== CONFIGURACI√ìN INICIAL ====================
        const DB_NAME = 'MEP_COMPLETO_2026';
        const DB_VERSION = 5;
        const CODIGO_PAIS = '506';

        let db = null;
        let institucion = {
            nombre: 'Liceo Rural Las Moras',
            codigo: 'MEP-009-2026',
            seccion: '9-1',
            asignatura: 'Estudios Sociales',
            docente: 'Dr. Harris Wilson',
            periodo: 'I Periodo',
            cursoLectivo: 2025
        };

        // Datos de ejemplo
        const estudiantesEjemplo = [
            { id: 1, nombre: 'Alberto Laureano Guevara', seccion: '9-1', telefono: '88881111' },
            { id: 2, nombre: 'Amalia Gil Longoria', seccion: '9-1', telefono: '88882222' },
            { id: 3, nombre: 'Enrique Yuridia Jaramillo Becerra', seccion: '9-1', telefono: '88883333' },
            { id: 4, nombre: 'Jos Gaona', seccion: '9-1', telefono: '88884444' },
            { id: 5, nombre: 'Juan P√©rez Ledezma', seccion: '9-1', telefono: '88885555' },
            { id: 6, nombre: 'Leonardo Reynoso', seccion: '9-1', telefono: '88886666' },
            { id: 7, nombre: 'Luisa Jacinto Ledesma', seccion: '9-1', telefono: '88887777' },
            { id: 8, nombre: 'Natalia Salvador Amador', seccion: '9-1', telefono: '88888888' },
            { id: 9, nombre: 'Rub√©n Barela', seccion: '9-1', telefono: '88889999' }
        ];

        // Indicadores de ejemplo para trabajo cotidiano
        const indicadoresEjemplo = [
            { id: 1, descripcion: 'Analiza cr√≠ticamente las causas y consecuencias de la Segunda Guerra Mundial mediante el uso de recursos gr√°ficos e hist√≥ricos.', puntos: 3 },
            { id: 2, descripcion: 'Identifica los principales eventos del periodo de entreguerras y su impacto en Am√©rica Latina.', puntos: 3 },
            { id: 3, descripcion: 'Compara diferentes perspectivas historiogr√°ficas sobre la Guerra Fr√≠a.', puntos: 3 }
        ];

        // ==================== INICIALIZACI√ìN INDEXEDDB ====================
        function inicializarDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject('Error al abrir DB');

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('‚úÖ DB conectada');
                    cargarDatosIniciales().then(() => {
                        cambiarVista('config');
                        resolve();
                    });
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('institucion')) {
                        db.createObjectStore('institucion', { keyPath: 'id' });
                    }

                    if (!db.objectStoreNames.contains('estudiantes')) {
                        const storeEst = db.createObjectStore('estudiantes', { keyPath: 'id', autoIncrement: true });
                        storeEst.createIndex('seccion', 'seccion', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('asistencia')) {
                        db.createObjectStore('asistencia', { keyPath: 'id', autoIncrement: true });
                    }

                    if (!db.objectStoreNames.contains('indicadores')) {
                        db.createObjectStore('indicadores', { keyPath: 'id', autoIncrement: true });
                    }

                    if (!db.objectStoreNames.contains('evaluaciones')) {
                        db.createObjectStore('evaluaciones', { keyPath: 'id', autoIncrement: true });
                    }

                    if (!db.objectStoreNames.contains('bitacora')) {
                        db.createObjectStore('bitacora', { keyPath: 'id', autoIncrement: true });
                    }

                    if (!db.objectStoreNames.contains('plantillas')) {
                        db.createObjectStore('plantillas', { keyPath: 'id', autoIncrement: true });
                    }

                    // Cargar datos de ejemplo
                    const tx = event.target.transaction;
                    
                    const storeEst = tx.objectStore('estudiantes');
                    estudiantesEjemplo.forEach(e => storeEst.add(e));

                    const storeInd = tx.objectStore('indicadores');
                    indicadoresEjemplo.forEach(i => storeInd.add(i));
                };
            });
        }

        async function cargarDatosIniciales() {
            return new Promise((resolve) => {
                const tx = db.transaction('institucion', 'readwrite');
                const store = tx.objectStore('institucion');
                store.get('config').onsuccess = (e) => {
                    if (e.target.result) {
                        institucion = e.target.result;
                    } else {
                        store.put({ id: 'config', ...institucion });
                    }
                    actualizarHeader();
                    resolve();
                };
            });
        }

        function actualizarHeader() {
            document.getElementById('institucionNombre').textContent = `MEP ¬∑ ${institucion.nombre}`;
            document.getElementById('institucionDetalle').textContent = 
                `${institucion.seccion} ¬∑ ${institucion.asignatura} ¬∑ Docente: ${institucion.docente}`;
        }

        // ==================== NAVEGACI√ìN ====================
        function cambiarVista(vistaId) {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === vistaId);
            });

            const container = document.getElementById('appMain');
            
            const vistas = {
                config: renderizarConfiguracion,
                parametros: renderizarParametros,
                estudiantes: renderizarEstudiantes,
                asistencia: renderizarAsistencia,
                cotidiano: renderizarTrabajoCotidiano,
                evaluacion: renderizarEvaluacionCompleta,
                bitacora: renderizarBitacoraDUA,
                alertas: renderizarAlertasCompletas,
                plantillas: renderizarPlantillas
            };

            if (vistas[vistaId]) {
                vistas[vistaId](container);
            }
        }

        // ==================== VISTA 1: CONFIGURACI√ìN ====================
        function renderizarConfiguracion(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üè´ Configuraci√≥n Institucional</div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Instituci√≥n</label>
                            <input type="text" id="cfg-nombre" value="${institucion.nombre}">
                        </div>
                        <div class="form-group">
                            <label>C√≥digo</label>
                            <input type="text" id="cfg-codigo" value="${institucion.codigo}">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Secci√≥n</label>
                            <input type="text" id="cfg-seccion" value="${institucion.seccion}">
                        </div>
                        <div class="form-group">
                            <label>Asignatura</label>
                            <input type="text" id="cfg-asignatura" value="${institucion.asignatura}">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Docente</label>
                            <input type="text" id="cfg-docente" value="${institucion.docente}">
                        </div>
                        <div class="form-group">
                            <label>Curso Lectivo</label>
                            <input type="number" id="cfg-lectivo" value="${institucion.cursoLectivo}">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="guardarConfiguracion()">üíæ Guardar Configuraci√≥n</button>
                </div>
            `;

            window.guardarConfiguracion = () => {
                institucion.nombre = document.getElementById('cfg-nombre').value;
                institucion.codigo = document.getElementById('cfg-codigo').value;
                institucion.seccion = document.getElementById('cfg-seccion').value;
                institucion.asignatura = document.getElementById('cfg-asignatura').value;
                institucion.docente = document.getElementById('cfg-docente').value;
                institucion.cursoLectivo = parseInt(document.getElementById('cfg-lectivo').value);

                const tx = db.transaction('institucion', 'readwrite');
                tx.objectStore('institucion').put({ id: 'config', ...institucion });
                actualizarHeader();
                alert('‚úÖ Configuraci√≥n guardada');
            };
        }

        // ==================== VISTA 2: PAR√ÅMETROS ====================
        function renderizarParametros(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">‚öñÔ∏è Par√°metros de Evaluaci√≥n MEP</div>
                    <div class="grid-4">
                        <div class="form-group">
                            <label>Trabajo Cotidiano (%)</label>
                            <input type="number" id="param-cot" value="50" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>Pruebas (%)</label>
                            <input type="number" id="param-pru" value="30" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>Tareas (%)</label>
                            <input type="number" id="param-tar" value="10" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>Proyectos (%)</label>
                            <input type="number" id="param-pro" value="10" min="0" max="100">
                        </div>
                    </div>
                    <div id="suma-param" class="badge badge-success" style="margin-bottom:10px;">Suma: 100% ‚úÖ</div>
                    <button class="btn btn-primary" onclick="guardarParametros()">‚úÖ Guardar Par√°metros</button>
                </div>
            `;

            window.guardarParametros = () => {
                alert('Par√°metros guardados');
            };
        }

        // ==================== VISTA 3: ESTUDIANTES ====================
        function renderizarEstudiantes(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üë• Lista de Estudiantes</div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nombre Completo</th>
                                    <th>Secci√≥n</th>
                                    <th>Tel√©fono</th>
                                    <th>ACS</th>
                                </tr>
                            </thead>
                            <tbody id="estudiantes-tbody">
                                ${estudiantesEjemplo.map((e, i) => `
                                    <tr>
                                        <td>${i+1}</td>
                                        <td>${e.nombre}</td>
                                        <td>${e.seccion}</td>
                                        <td>${e.telefono}</td>
                                        <td><input type="checkbox" ${e.id === 3 ? 'checked' : ''}></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // ==================== VISTA 4: ASISTENCIA (Ya funcional) ====================
        function renderizarAsistencia(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üìÖ Control de Asistencia</div>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Fecha desde:</label>
                            <input type="date" value="2025-04-01">
                        </div>
                        <div class="form-group">
                            <label>Fecha hasta:</label>
                            <input type="date" value="2025-04-30">
                        </div>
                        <div class="form-group">
                            <label>Secci√≥n:</label>
                            <select>
                                <option>Todas las secciones</option>
                                <option>9-1</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-primary">üîç Filtrar</button>
                        <button class="btn btn-outline">üóëÔ∏è Borrar Filtros</button>
                        <button class="btn btn-success" onclick="exportarAsistenciaExcel()">üì• Descargar Excel</button>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Estudiante</th>
                                    <th>Secci√≥n</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>2025-04-01</td><td>Alberto Laureano Guevara</td><td>9-1</td><td><select><option>Presente</option><option>Ausente</option></select></td></tr>
                                <tr><td>2025-04-01</td><td>Enrique Yuridia Jaramillo</td><td>9-1</td><td><select><option>Presente</option><option>Ausente</option></select></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            window.exportarAsistenciaExcel = () => {
                alert('Descargando Excel de asistencia...');
            };
        }

        // ==================== VISTA 5: TRABAJO COTIDIANO (NUEVO - COMPLETO) ====================
        function renderizarTrabajoCotidiano(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üìù Trabajo Cotidiano - Configuraci√≥n</div>
                    
                    <div class="grid-2">
                        <div>
                            <label>Periodo:</label>
                            <select id="cot-periodo" class="form-control">
                                <option>I Periodo / Estudios Sociales / 9-1 / 2025 / ${institucion.nombre}</option>
                                <option>II Periodo / Estudios Sociales / 9-1 / 2025 / ${institucion.nombre}</option>
                                <option>III Periodo / Estudios Sociales / 9-1 / 2025 / ${institucion.nombre}</option>
                            </select>
                        </div>
                        <div>
                            <label>Filtrar por nombre:</label>
                            <input type="text" id="cot-filtro" placeholder="Buscar estudiante...">
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin: 20px 0;">
                        <button class="btn btn-primary" onclick="exportarCotidianoPDF()">üì• Descargar PDF</button>
                        <button class="btn btn-warning" onclick="exportarCotidianoWord()">üì• Descargar Word</button>
                        <button class="btn btn-success" onclick="exportarCotidianoExcel()">üì• Descargar Excel</button>
                    </div>

                    <details>
                        <summary style="cursor: pointer; color: var(--mep-blue); font-weight: 600;">‚öôÔ∏è Configuraci√≥n del Trabajo Cotidiano</summary>
                        
                        <div class="mt-3">
                            <h4>Indicadores</h4>
                            <button class="btn btn-outline btn-small" onclick="agregarIndicador()">‚ûï Agregar Indicador</button>
                            <div id="indicadores-lista" class="mt-3">
                                ${indicadoresEjemplo.map(i => `
                                    <div class="indicador-item">
                                        <div style="display: flex; justify-content: space-between;">
                                            <div><strong>${i.descripcion}</strong></div>
                                            <div>Puntos: ${i.puntos} <button class="btn btn-outline btn-small" onclick="editarIndicador(${i.id})">‚úèÔ∏è</button> <button class="btn btn-danger btn-small" onclick="eliminarIndicador(${i.id})">üóëÔ∏è</button></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </details>

                    <div class="table-responsive mt-3">
                        <table>
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    <th>A</th>
                                    <th>B</th>
                                    <th>C</th>
                                    <th>Valor 50%</th>
                                    <th>% Obtenido</th>
                                </tr>
                            </thead>
                            <tbody id="cotidiano-tbody">
                                ${estudiantesEjemplo.map(est => {
                                    const a = est.id === 6 ? 3 : est.id === 7 ? 2 : 3;
                                    const b = est.id === 6 ? 3 : est.id === 7 ? 2 : 3;
                                    const c = est.id === 6 ? 2 : est.id === 7 ? 3 : 3;
                                    const total = a + b + c;
                                    const porcentaje = ((total / 9) * 50).toFixed(2);
                                    return `
                                        <tr>
                                            <td>${est.nombre}</td>
                                            <td><input type="number" value="${a}" min="0" max="3" style="width:60px;"></td>
                                            <td><input type="number" value="${b}" min="0" max="3" style="width:60px;"></td>
                                            <td><input type="number" value="${c}" min="0" max="3" style="width:60px;"></td>
                                            <td>50.00%</td>
                                            <td><strong>${porcentaje}%</strong></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3">
                        <span class="badge badge-success">Estudiantes sin ACS</span>
                        <span class="badge badge-warning">Valor 50%</span>
                    </div>

                    <button class="btn btn-primary mt-3" onclick="guardarTrabajoCotidiano()">üíæ Guardar Trabajo Cotidiano</button>
                </div>
            `;

            window.agregarIndicador = () => {
                alert('Funcionalidad: Agregar nuevo indicador con campos editables');
            };

            window.editarIndicador = (id) => {
                alert(`Editando indicador ${id}`);
            };

            window.eliminarIndicador = (id) => {
                if (confirm('¬øEliminar este indicador?')) {
                    alert(`Indicador ${id} eliminado`);
                }
            };

            window.exportarCotidianoPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(16);
                doc.text('Trabajo Cotidiano', 14, 15);
                doc.setFontSize(10);
                doc.text(`${institucion.nombre} - ${institucion.seccion} - ${institucion.asignatura}`, 14, 22);
                
                const data = estudiantesEjemplo.map(est => {
                    const a = est.id === 6 ? 3 : est.id === 7 ? 2 : 3;
                    const b = est.id === 6 ? 3 : est.id === 7 ? 2 : 3;
                    const c = est.id === 6 ? 2 : est.id === 7 ? 3 : 3;
                    const total = a + b + c;
                    const porcentaje = ((total / 9) * 50).toFixed(2);
                    return [est.nombre, a, b, c, '50.00%', `${porcentaje}%`];
                });
                
                doc.autoTable({
                    head: [['Estudiante', 'A', 'B', 'C', 'Valor 50%', '% Obtenido']],
                    body: data,
                    startY: 30,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [0, 51, 102] }
                });
                
                doc.save('trabajo_cotidiano.pdf');
            };

            window.exportarCotidianoWord = () => {
                let html = `
                    <html>
                    <head><meta charset="UTF-8"></head>
                    <body>
                        <h1>Trabajo Cotidiano - ${institucion.nombre}</h1>
                        <table border="1" style="border-collapse: collapse; width:100%;">
                            <tr><th>Estudiante</th><th>A</th><th>B</th><th>C</th><th>Valor 50%</th><th>% Obtenido</th></tr>
                `;
                
                estudiantesEjemplo.forEach(est => {
                    const a = est.id === 6 ? 3 : est.id === 7 ? 2 : 3;
                    const b = est.id === 6 ? 3 : est.id === 7 ? 2 : 3;
                    const c = est.id === 6 ? 2 : est.id === 7 ? 3 : 3;
                    const total = a + b + c;
                    const porcentaje = ((total / 9) * 50).toFixed(2);
                    html += `<tr><td>${est.nombre}</td><td>${a}</td><td>${b}</td><td>${c}</td><td>50.00%</td><td>${porcentaje}%</td></tr>`;
                });
                
                html += '</table></body></html>';
                
                const blob = new Blob([html], { type: 'application/msword' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `cotidiano_${new Date().toISOString().slice(0,10)}.doc`;
                link.click();
            };

            window.exportarCotidianoExcel = () => {
                let csv = "Estudiante,A,B,C,Valor 50%,% Obtenido\n";
                
                estudiantesEjemplo.forEach(est => {
                    const a = est.id === 6 ? 3 : est.id === 7 ? 2 : 3;
                    const b = est.id === 6 ? 3 : est.id === 7 ? 2 : 3;
                    const c = est.id === 6 ? 2 : est.id === 7 ? 3 : 3;
                    const total = a + b + c;
                    const porcentaje = ((total / 9) * 50).toFixed(2);
                    csv += `"${est.nombre}",${a},${b},${c},50.00%,${porcentaje}%\n`;
                });

                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `cotidiano_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };

            window.guardarTrabajoCotidiano = () => {
                alert('‚úÖ Trabajo cotidiano guardado');
            };
        }

        // ==================== VISTA 6: EVALUACI√ìN COMPLETA (Estilo Colegio La Alegr√≠a) ====================
        function renderizarEvaluacionCompleta(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üìä Registro de Notas ‚Äî ${institucion.nombre}</div>
                    <h3>Secci√≥n ${institucion.seccion}</h3>
                    
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th rowspan="2">#</th>
                                    <th rowspan="2">Estudiante</th>
                                    <th colspan="3">Trabajo Cotidiano</th>
                                    <th colspan="2">Pruebas</th>
                                    <th colspan="3">Tareas</th>
                                    <th rowspan="2">Asistencia</th>
                                </tr>
                                <tr>
                                    <th>Cotidiano 1 (100 pts)</th>
                                    <th>Cotidiano 2 (100 pts)</th>
                                    <th>Cotidiano 3 (100 pts)</th>
                                    <th>Prueba I (100 pts)</th>
                                    <th>Prueba II (100 pts)</th>
                                    <th>Tarea 1 (100 pts)</th>
                                    <th>Tarea 2 (100 pts)</th>
                                    <th>Tarea 3 (100 pts)</th>
                                </tr>
                            </thead>
                            <tbody id="evaluacion-tbody">
                                ${estudiantesEjemplo.slice(0,3).map((est, idx) => `
                                    <tr>
                                        <td>${idx+1}</td>
                                        <td>${est.nombre}</td>
                                        <td><input type="number" value="${idx === 0 ? 100 : idx === 1 ? 60 : 70}" step="0.1" min="0" max="100" style="width:70px;"></td>
                                        <td><input type="number" value="${idx === 0 ? 90 : idx === 1 ? 89 : 90}" step="0.1" min="0" max="100" style="width:70px;"></td>
                                        <td><input type="number" value="${idx === 0 ? 89 : idx === 1 ? 56 : 90}" step="0.1" min="0" max="100" style="width:70px;"></td>
                                        <td><input type="number" value="${idx === 0 ? 75 : idx === 1 ? 70 : 85}" step="0.1" min="0" max="100" style="width:70px;"></td>
                                        <td><input type="number" value="${idx === 0 ? 70 : idx === 1 ? 90 : 78}" step="0.1" min="0" max="100" style="width:70px;"></td>
                                        <td><input type="number" value="${idx === 0 ? 70 : idx === 1 ? 89 : 65}" step="0.1" min="0" max="100" style="width:70px;"></td>
                                        <td><input type="number" value="${idx === 0 ? 90 : idx === 1 ? 56 : 70}" step="0.1" min="0" max="100" style="width:70px;"></td>
                                        <td><input type="number" value="${idx === 0 ? 90 : idx === 1 ? 89 : 90}" step="0.1" min="0" max="100" style="width:70px;"></td>
                                        <td><input type="number" value="${idx === 0 ? 85 : idx === 1 ? 90 : 79}" step="0.1" min="0" max="100" style="width:70px;"></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <button class="btn btn-primary mt-3" onclick="guardarNotasCompletas()">üíæ Guardar todas las notas</button>
                </div>
            `;

            window.guardarNotasCompletas = () => {
                alert('‚úÖ Notas guardadas correctamente');
            };
        }

        // ==================== VISTA 7: BIT√ÅCORA DUA ====================
        function renderizarBitacoraDUA(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üìñ Bit√°cora DUA (Dise√±o Universal para el Aprendizaje)</div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Fecha:</label>
                            <input type="date" id="bit-fecha" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>Estudiante (opcional):</label>
                            <select id="bit-estudiante">
                                <option value="">Todos los estudiantes</option>
                                ${estudiantesEjemplo.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Estrategias implementadas:</label>
                        <textarea id="bit-estrategias" rows="4" placeholder="Describa las adecuaciones y apoyos brindados..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Observaciones:</label>
                        <textarea id="bit-observaciones" rows="3" placeholder="Resultados observados..."></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="guardarBitacoraDUA()">üìù Guardar Registro</button>

                    <div class="table-responsive mt-3">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Estudiante</th>
                                    <th>Estrategias</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2025-04-01</td>
                                    <td>Alberto Laureano Guevara</td>
                                    <td>Apoyo visual en mapas conceptuales</td>
                                    <td>Mejor√≥ comprensi√≥n</td>
                                </tr>
                                <tr>
                                    <td>2025-04-02</td>
                                    <td>Enrique Yuridia Jaramillo</td>
                                    <td>Tiempo adicional en evaluaciones</td>
                                    <td>Complet√≥ el trabajo</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            window.guardarBitacoraDUA = () => {
                alert('‚úÖ Registro guardado en bit√°cora DUA');
            };
        }

        // ==================== VISTA 8: ALERTAS COMPLETAS CON WHATSAPP ====================
        function renderizarAlertasCompletas(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üö® Centro de Alertas - Bajo Rendimiento</div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Nota m√≠nima de alerta:</label>
                            <select id="alerta-nota">
                                <option value="70">Menor a 70</option>
                                <option value="65" selected>Menor a 65 (MEP)</option>
                                <option value="60">Menor a 60</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Periodo:</label>
                            <select id="alerta-periodo">
                                <option>I Periodo</option>
                                <option>II Periodo</option>
                                <option>III Periodo</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="actualizarAlertas()">üîç Actualizar Alertas</button>

                    <div id="alertas-contenido" class="mt-3">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Estudiante</th>
                                        <th>Nota Actual</th>
                                        <th>Tel√©fono</th>
                                        <th>Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${estudiantesEjemplo.filter((_, i) => i % 3 === 0).map(est => `
                                        <tr>
                                            <td>${est.nombre}</td>
                                            <td><span class="badge badge-danger">${Math.floor(Math.random() * 20) + 45}</span></td>
                                            <td>${est.telefono}</td>
                                            <td>
                                                <button class="btn btn-warning btn-small" onclick="window.open('https://wa.me/${CODIGO_PAIS}${est.telefono}?text=${encodeURIComponent(`Apreciable familia de ${est.nombre}, su nota actual es inferior a 65. Solicitamos su apoyo para mejorar su rendimiento acad√©mico. Atentamente, ${institucion.docente}`)}')">
                                                    üì± WhatsApp
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            window.actualizarAlertas = () => {
                alert('Alertas actualizadas');
            };
        }

        // ==================== VISTA 9: PLANTILLAS (NUEVO) ====================
        function renderizarPlantillas(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">üìë Plantillas Oficiales MEP</div>
                    
                    <div class="plantilla-grid">
                        <div class="plantilla-card" onclick="descargarPlantilla('asistencia')">
                            <div class="plantilla-icon">üìÖ</div>
                            <h3>Asistencia</h3>
                            <p>Control de asistencia de estudiantes</p>
                            <button class="btn btn-outline btn-small">Descargar</button>
                        </div>

                        <div class="plantilla-card" onclick="descargarPlantilla('cotidiano')">
                            <div class="plantilla-icon">üìù</div>
                            <h3>Trabajo cotidiano</h3>
                            <p>Registro y evaluaci√≥n del trabajo cotidiano</p>
                            <button class="btn btn-outline btn-small">Descargar</button>
                        </div>

                        <div class="plantilla-card" onclick="descargarPlantilla('acta-periodo')">
                            <div class="plantilla-icon">üìä</div>
                            <h3>Acta por periodo</h3>
                            <p>Acta oficial de calificaciones por periodo</p>
                            <button class="btn btn-outline btn-small">Descargar</button>
                        </div>

                        <div class="plantilla-card" onclick="descargarPlantilla('acta-anual')">
                            <div class="plantilla-icon">üìú</div>
                            <h3>Acta anual</h3>
                            <p>Consolidado anual de calificaciones finales</p>
                            <button class="btn btn-outline btn-small">Descargar</button>
                        </div>

                        <div class="plantilla-card" onclick="descargarPlantilla('seccion')">
                            <div class="plantilla-icon">üë•</div>
                            <h3>Plantilla por secci√≥n</h3>
                            <p>Plantilla base para crear una secci√≥n con estudiantes</p>
                            <button class="btn btn-outline btn-small">Descargar</button>
                        </div>

                        <div class="plantilla-card" onclick="descargarPlantilla('semestre')">
                            <div class="plantilla-icon">üìö</div>
                            <h3>Plantilla I y II Semestre</h3>
                            <p>Plantilla base para I y II Semestre</p>
                            <button class="btn btn-outline btn-small">Descargar</button>
                        </div>
                    </div>
                </div>
            `;

            window.descargarPlantilla = (tipo) => {
                let contenido = '';
                let nombreArchivo = '';
                
                switch(tipo) {
                    case 'asistencia':
                        contenido = 'Fecha,Estudiante,Secci√≥n,Estado\n2025-04-01,"Estudiante Ejemplo",9-1,Presente';
                        nombreArchivo = 'plantilla_asistencia.csv';
                        break;
                    case 'cotidiano':
                        contenido = 'Estudiante,A,B,C\n"Estudiante Ejemplo",3,3,3';
                        nombreArchivo = 'plantilla_cotidiano.csv';
                        break;
                    case 'acta-periodo':
                        contenido = 'Estudiante,Nota,Estado\n"Estudiante Ejemplo",85,Aprobado';
                        nombreArchivo = 'plantilla_acta_periodo.csv';
                        break;
                    default:
                        contenido = 'Plantilla de ejemplo';
                        nombreArchivo = `plantilla_${tipo}.txt`;
                }
                
                const blob = new Blob(['\uFEFF' + contenido], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nombreArchivo;
                link.click();
            };
        }

        // ==================== INICIALIZACI√ìN ====================
        window.onload = async () => {
            await inicializarDB();
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    cambiarVista(e.currentTarget.dataset.view);
                });
            });
        };

        window.cambiarVista = cambiarVista;
    })();
</script>
</body>
</html>
